<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src * 'unsafe-inline' 'unsafe-eval' data: blob: wss: https:;">
    <title>Chronicle - Versi√≥n Local</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%2306b6d4%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        body { background-color: #050505; color: #e5e7eb; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-panel {
            background: rgba(20, 20, 23, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body:not(.performance-mode) .glass-panel {
            @media (min-width: 768px) {
                background: rgba(20, 20, 23, 0.6);
                backdrop-filter: blur(12px);
            }
        }
        body.performance-mode .glass-panel {
            background: #141417; 
            backdrop-filter: none !important;
            box-shadow: none !important;
            border: 1px solid #333;
        }
        body.performance-mode .fade-in { animation: none !important; }
        
        input, select, textarea { font-size: 16px !important; }

        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
            height: 100%; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 48px; 
            width: 20px;
            background: transparent;
            cursor: pointer;
            border: none;
        }
        input[type=range]::-moz-range-thumb {
            height: 48px;
            width: 20px;
            background: transparent;
            cursor: pointer;
            border: none;
        }
        input[type=range]:focus {
            outline: none; 
        }

        .visible-range {
            height: 4px !important; 
            margin: 15px 0 !important; 
            width: 100%;
            -webkit-appearance: none; 
            background: transparent;
        }
        .visible-range::-webkit-slider-runnable-track {
            height: 4px !important;
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 2px;
            border: none;
        }
        .visible-range::-moz-range-track {
            height: 4px !important;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            border: none;
        }
        .visible-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px !important;
            width: 16px !important;
            border-radius: 50%;
            background: #ffffff !important;
            cursor: pointer;
            margin-top: -6px !important; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.5); 
            border: 2px solid #000; 
        }
        .visible-range::-moz-range-thumb {
            height: 16px !important;
            width: 16px !important;
            border: 2px solid #000;
            border-radius: 50%;
            background: #ffffff !important;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { 
            Film, Tv, Book, Layers, Disc, Plus, Trash2, Star, 
            LayoutGrid, Settings, Activity, Zap, Radio, 
            Edit2, Search, Database, Hash, 
            BarChart3, Clock, CheckCircle, PlayCircle,
            Calendar, User, Timer, AlignLeft, Headphones, 
            TrendingUp, Award, Lock, Image as ImageIcon,
            Smartphone, Globe, Eye, PauseCircle, XCircle, RefreshCw, Upload, Music,
            Mic2, Album, Tag, X, Gamepad2, MousePointer2, Heart, ArrowLeft,
            LogOut, Save, Download, FileJson, Mail, AlertTriangle, Speaker, List, History, 
            BarChart2, PieChart, Wifi, WifiOff, Info, AlertCircle, ChevronRight,
            Palette, PaintBucket, Loader2, Share2, Camera, Link as LinkIcon, HardDrive, Shield,
            ChevronUp, ChevronDown, Minus, Maximize2, Grid3X3,
            ArrowRightLeft, ArrowUpCircle, ArrowDownCircle, RefreshCcw
        } from 'https://esm.sh/lucide-react@0.300.0?deps=react@18.2.0';

        const dbName = 'ChronicleDB';
        const dbVersion = 1;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('items')) {
                        db.createObjectStore('items', { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        };

        const dbAPI = {
            getAll: async () => {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction('items', 'readonly');
                    const store = transaction.objectStore('items');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            save: async (item) => {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction('items', 'readwrite');
                    const store = transaction.objectStore('items');
                    const request = store.put(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            clear: async () => {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction('items', 'readwrite');
                    const store = transaction.objectStore('items');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            delete: async (id) => {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction('items', 'readwrite');
                    const store = transaction.objectStore('items');
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };

        const DataManager = {
            getAll: async (type) => {
                if (type === 'indexedDB') return await dbAPI.getAll();
                return JSON.parse(localStorage.getItem('chronicle_items') || '[]');
            },
            save: async (item, type) => {
                if (type === 'indexedDB') return await dbAPI.save(item);
                const items = JSON.parse(localStorage.getItem('chronicle_items') || '[]');
                const index = items.findIndex(i => i.id === item.id);
                if (index >= 0) items[index] = item;
                else items.push(item);
                try {
                    localStorage.setItem('chronicle_items', JSON.stringify(items));
                } catch (e) {
                    throw new Error("LocalStorage lleno. Intenta borrar items o cambiar a IndexedDB.");
                }
            },
            saveBatch: async (newItems, type) => {
                 if (type === 'indexedDB') {
                     const db = await initDB();
                     const transaction = db.transaction('items', 'readwrite');
                     const store = transaction.objectStore('items');
                     newItems.forEach(item => store.put(item));
                     return new Promise((resolve) => transaction.oncomplete = resolve);
                 } else {
                     try {
                        localStorage.setItem('chronicle_items', JSON.stringify(newItems));
                     } catch(e) { throw new Error("LocalStorage lleno durante sync."); }
                 }
            },
            overwriteAll: async (newItems, type) => {
                if (type === 'indexedDB') {
                    await dbAPI.clear();
                    return await DataManager.saveBatch(newItems, type);
                } else {
                    localStorage.setItem('chronicle_items', JSON.stringify(newItems));
                }
            },
            delete: async (id, type) => {
                if (type === 'indexedDB') return await dbAPI.delete(id);
                const items = JSON.parse(localStorage.getItem('chronicle_items') || '[]');
                const newItems = items.filter(i => i.id !== id);
                localStorage.setItem('chronicle_items', JSON.stringify(newItems));
            }
        };

        const smartMerge = (localItems, remoteItems) => {
            const map = new Map();
            localItems.forEach(i => map.set(i.id, i));
            let updatedCount = 0;
            let newCount = 0;
            remoteItems.forEach(remoteItem => {
                if(map.has(remoteItem.id)) {
                    const localItem = map.get(remoteItem.id);
                    const remoteTime = new Date(remoteItem.lastEdited || 0).getTime();
                    const localTime = new Date(localItem.lastEdited || 0).getTime();
                    
                    if (remoteTime > localTime) {
                        map.set(remoteItem.id, remoteItem);
                        updatedCount++;
                    }
                } else {
                    map.set(remoteItem.id, remoteItem);
                    newCount++;
                }
            });
            return {
                merged: Array.from(map.values()),
                stats: { updated: updatedCount, added: newCount }
            };
        };

        const compressImage = (file, maxWidth, quality) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        if (!maxWidth) { resolve(img.src); return; }
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const recompressBase64 = (base64Str, maxWidth = 600, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width <= maxWidth && base64Str.length < 500000) { 
                        resolve(base64Str); 
                        return;
                    }

                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(base64Str);
            });
        };

        const getStorageUsage = async () => {
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage / (1024 * 1024)).toFixed(1);
                    const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(0); 
                    const percent = ((estimate.usage / estimate.quota) * 100).toFixed(2);
                    return { usedMB, quotaMB, percent };
                } catch (e) { console.error(e); }
            }
            let total = 0;
            for (let x in localStorage) {
                if (localStorage.hasOwnProperty(x)) total += ((localStorage[x].length + x.length) * 2);
            }
            return { usedMB: (total / 1024 / 1024).toFixed(2), quotaMB: '5', percent: Math.min((total / 5242880) * 100, 100).toFixed(1) };
        };

        const StarRatingDisplay = ({ rating, size = "w-4 h-4", showValue = false }) => {
            const numericRating = parseFloat(rating) || 0;
            const percent = Math.min(100, Math.max(0, (numericRating / 5) * 100));
            
            return (
                <div className="flex items-center gap-2">
                    <div className="relative inline-flex items-center text-gray-800">
                        <div className="flex">
                            {[1,2,3,4,5].map(i => <Star key={i} className={`${size} mx-[1px]`} />)}
                        </div>
                        <div className="absolute top-0 left-0 flex overflow-hidden whitespace-nowrap text-yellow-500" style={{ width: `${percent}%` }}>
                            {[1,2,3,4,5].map(i => <Star key={i} className={`${size} fill-current flex-shrink-0 mx-[1px]`} />)}
                        </div>
                    </div>
                    {showValue && <span className="text-yellow-500 font-bold text-xs">{numericRating.toFixed(1)}</span>}
                </div>
            );
        };

        const InteractiveStarRating = ({ value, onChange }) => {
            const percent = Math.min(100, Math.max(0, (value / 5) * 100));
            
            const adjustRating = (delta) => {
                let newVal = parseFloat(value) + delta;
                if(newVal > 5) newVal = 5;
                if(newVal < 0) newVal = 0;
                onChange(Math.round(newVal * 10) / 10);
            };

            const handleInputChange = (e) => {
                let v = e.target.value;
                if(v === '') {
                    onChange(0); 
                    return;
                }
                let num = parseFloat(v);
                if(isNaN(num)) return;
                if(num > 5) num = 5;
                if(num < 0) num = 0;
                onChange(num);
            };

            const handleFocus = (e) => {
                if(value === 0) e.target.select(); 
            };

            return (
                <div className="flex flex-col items-center gap-3 w-full">
                    <div className="relative w-[280px] h-12 select-none group touch-pan-y mx-auto cursor-pointer">
                        <div className="absolute inset-0 flex justify-between items-center px-1 text-gray-800 pointer-events-none">
                            {[1,2,3,4,5].map(i => <Star key={i} className="w-10 h-10 fill-current" />)}
                        </div>
                        <div className="absolute inset-0 overflow-hidden px-1 transition-all duration-75 ease-out pointer-events-none" style={{ width: `${percent}%` }}>
                            <div className="w-[272px] flex justify-between items-center h-full"> 
                                {[1,2,3,4,5].map(i => <Star key={i} className="w-10 h-10 text-yellow-400 fill-current flex-shrink-0" />)}
                            </div>
                        </div>

                        <input 
                            type="range" 
                            min="0" 
                            max="5" 
                            step="0.1" 
                            value={value} 
                            onChange={(e) => {
                                const v = parseFloat(e.target.value);
                                if (!isNaN(v)) onChange(v);
                            }}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                            style={{ margin: 0 }}
                        />
                    </div>
                    
                    <div className="flex items-center justify-center gap-3 w-full max-w-[200px]">
                        <button 
                            onClick={() => adjustRating(-0.1)}
                            className="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 active:scale-95 transition"
                        >
                            <Minus className="w-4 h-4 text-gray-400" />
                        </button>

                        <div className="flex items-center justify-center gap-1 bg-black border border-white/20 px-3 py-1.5 rounded-lg w-20 relative">
                            <input 
                                type="number" 
                                min="0" 
                                max="5" 
                                step="0.1" 
                                value={value === 0 ? '' : value} 
                                placeholder="0"
                                onFocus={handleFocus}
                                onChange={handleInputChange}
                                onWheel={(e) => e.stopPropagation()}
                                className="w-full bg-transparent text-center font-mono text-xl font-bold text-yellow-400 outline-none p-0 z-10 placeholder:text-gray-700"
                            />
                            {value === 0 && <span className="absolute inset-0 flex items-center justify-center text-xl font-bold text-gray-700 font-mono pointer-events-none">0</span>}
                        </div>

                        <button 
                            onClick={() => adjustRating(0.1)}
                            className="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 active:scale-95 transition"
                        >
                            <Plus className="w-4 h-4 text-gray-400" />
                        </button>
                    </div>
                </div>
            );
        }

        const NavBtn = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all ${active ? 'bg-white/10 text-white border border-white/10 shadow-[0_0_10px_rgba(255,255,255,0.05)]' : 'text-gray-400 hover:text-white hover:bg-white/5 border border-transparent'}`}>
                {React.cloneElement(icon, { className: 'w-4 h-4' })}<span className="text-xs font-medium">{label}</span>
            </button>
        );
        const FilterBtn = ({ active, onClick, label }) => (
            <button onClick={onClick} className={`shrink-0 px-3 py-1 rounded-full text-xs transition ${active ? 'bg-white text-black font-bold' : 'bg-white/5 text-gray-400 hover:text-white'}`}>{label}</button>
        );
        const MobNav = ({ active, onClick, icon, label, accentClass }) => (
            <button onClick={onClick} className={`flex-1 flex flex-col items-center justify-center py-1 transition-colors ${active ? accentClass : 'text-gray-500'}`}>{React.cloneElement(icon, { className: 'w-5 h-5 mb-0.5' })}<span className="text-[8px] font-bold uppercase tracking-tight">{label}</span></button>
        );
        const StatCard = ({ icon, label, val, sub, onClick, highlight, accentText }) => (
            <div onClick={onClick} className={`glass-panel rounded-2xl p-3 md:p-4 flex flex-col justify-between h-20 md:h-24 hover:bg-white/5 transition ${onClick ? 'cursor-pointer active:scale-95' : ''}`}>
                <div className="flex justify-between items-start"><span className="text-[8px] md:text-[9px] font-bold text-gray-500 uppercase tracking-widest">{label}</span><div className="opacity-80 scale-75 md:scale-100 origin-top-right">{icon}</div></div>
                <div>
                    <div className={`text-lg md:text-2xl font-bold font-mono truncate ${highlight ? accentText : 'text-white'}`}>{val}</div>
                    <div className="text-[9px] md:text-[10px] text-gray-500 truncate">{sub}</div>
                </div>
            </div>
        );
        const StatusRow = ({ label, val, color, total }) => (
            <div>
                <div className="flex justify-between text-[10px] text-gray-400 mb-1"><span>{label}</span><span className="text-white font-bold">{val}</span></div>
                <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden"><div className={`h-full ${color}`} style={{width: `${total ? (val/total)*100 : 0}%`}} /></div>
            </div>
        );
        const TopTagsBox = ({ title, tags, accentText }) => (
            <div className="glass-panel rounded-2xl p-5 flex flex-col h-full">
                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Hash className="w-3 h-3"/> {title}</h3>
                <div className="flex-1 flex flex-col justify-center gap-2">
                    {tags.length > 0 ? tags.map(([tag, count], i) => (
                        <div key={i} className="flex items-center justify-between group cursor-default">
                            <div className="flex items-center gap-3">
                                <span className="text-[10px] font-mono text-gray-600 w-4">0{i+1}</span>
                                <span className="text-sm font-bold text-gray-300 group-hover:text-white transition capitalize truncate max-w-[120px]">{tag}</span>
                            </div>
                            <div className="h-px flex-1 bg-white/5 mx-3"></div>
                            <span className={`text-xs font-mono ${accentText}`}>{count}</span>
                        </div>
                    )) : (
                        <div className="text-xs text-gray-600 text-center">Sin datos suficientes</div>
                    )}
                </div>
            </div>
        );
        const DetailStatBox = ({ title, val, sub, icon }) => (
            <div className="glass-panel rounded-xl p-4 flex items-center gap-4">
                <div className="bg-white/5 p-3 rounded-full">{icon}</div>
                <div><div className="text-[10px] uppercase text-gray-500 font-bold">{title}</div><div className="text-xl font-bold text-white">{val}</div><div className="text-[10px] text-gray-400">{sub}</div></div>
            </div>
        );

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in">
                <div className="bg-[#0f0f10] border sm:border border-white/10 w-full sm:max-w-md rounded-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto custom-scrollbar flex flex-col" onClick={e => e.stopPropagation()}>
                    <button 
                        onClick={onClose} 
                        className="absolute top-4 right-4 z-50 bg-[#27272a] text-gray-400 hover:text-white rounded-full p-2 border border-white/10 shadow-lg"
                    >
                        <X className="w-4 h-4"/>
                    </button>
                    <div className="p-6 pt-8">
                        {children}
                    </div>
                </div>
            </div>
        );
        
        const P2PSyncModal = ({ onClose, currentItems, onMergeComplete, config }) => {
            const [peer, setPeer] = useState(null);
            const [myId, setMyId] = useState('');
            const [remoteIdInput, setRemoteIdInput] = useState('');
            const [status, setStatus] = useState('initializing'); 
            const [logs, setLogs] = useState(['Iniciando PeerJS...']);
            const qrRef = useRef(null);
            const connRef = useRef(null);

            const addLog = (msg) => setLogs(prev => [...prev.slice(-4), msg]);

            const initializePeer = () => {
                setStatus('initializing');
                addLog('Conectando al servidor P2P...');
                
                const randomId = 'chronicle-' + Math.random().toString(36).substr(2, 9);

                const newPeer = new window.Peer(randomId);
                
                newPeer.on('open', (id) => {
                    setMyId(id);
                    setPeer(newPeer);
                    setStatus('ready');
                    addLog('Listo. ID: ' + id);
                    
                    setTimeout(() => {
                        if(qrRef.current) {
                            qrRef.current.innerHTML = '';
                            try {
                                new window.QRCode(qrRef.current, {
                                    text: id,
                                    width: 160,
                                    height: 160,
                                    colorDark : "#ffffff",
                                    colorLight : "#000000",
                                    correctLevel : window.QRCode.CorrectLevel.L
                                });
                            } catch(e) { console.error("QR Error", e); }
                        }
                    }, 200);
                });

                newPeer.on('connection', (conn) => {
                    addLog('¬°Conexi√≥n entrante!');
                    handleConnection(conn);
                });

                newPeer.on('error', (err) => {
                    console.error("Peer Error", err);
                    setStatus('error');
                    
                    let msg = err.type || err.message;
                    if(msg.includes('server-error') || msg.includes('socket') || msg.includes('network')) {
                        msg = "Bloqueo de red detectado (CSP). Intenta otra red.";
                    }
                    addLog('Error: ' + msg);
                });
            };

            useEffect(() => {
                initializePeer();
                return () => {
                    if(peer) peer.destroy();
                };
            }, []);

            const handleConnection = (conn) => {
                connRef.current = conn;
                setStatus('connecting');
                
                conn.on('open', () => {
                    setStatus('connected');
                    addLog('Conectado con dispositivo remoto.');
                });

                conn.on('data', async (data) => {
                    addLog(`Recibido: ${data.type}`);
                    
                    if (data.type === 'SYNC_MERGE_REQUEST') {
                        addLog('Fusionando datos...');
                        const result = smartMerge(currentItems, data.items);
                        await DataManager.saveBatch(result.merged, config.storageType);
                        conn.send({ type: 'SYNC_MERGE_RESPONSE', items: result.merged });
                        addLog('Fusi√≥n completada. Enviando vuelta.');
                        onMergeComplete();
                        setStatus('done');
                    }
                    else if (data.type === 'SYNC_MERGE_RESPONSE') {
                        addLog('Datos fusionados recibidos. Guardando...');
                        await DataManager.saveBatch(data.items, config.storageType);
                        onMergeComplete();
                        setStatus('done');
                    }
                    else if (data.type === 'OVERWRITE_LOCAL_REQUEST') {
                        addLog('Preparando env√≠o de mis datos...');
                        conn.send({ type: 'OVERWRITE_REMOTE_DATA', items: currentItems });
                    }
                    else if (data.type === 'OVERWRITE_REMOTE_DATA') {
                        if(confirm(`‚ö†Ô∏è ALERTA: El otro dispositivo va a sobrescribir tus datos locales con ${data.items.length} elementos. ¬øConfirmar?`)) {
                            addLog('Sobrescribiendo datos locales...');
                            await DataManager.overwriteAll(data.items, config.storageType);
                            addLog('Datos reemplazados correctamente.');
                            onMergeComplete();
                            setStatus('done');
                        } else {
                            addLog('Sobreescritura cancelada por usuario.');
                        }
                    }
                });

                conn.on('close', () => {
                    addLog('Conexi√≥n cerrada.');
                    setStatus('ready');
                    connRef.current = null;
                });
            };

            const connectToRemote = () => {
                if(!peer || !remoteIdInput) return;
                addLog('Conectando a ' + remoteIdInput + '...');
                const conn = peer.connect(remoteIdInput);
                handleConnection(conn);
            };

            const triggerAction = (action) => {
                if(!connRef.current) return;
                
                if (action === 'merge') {
                    addLog('Iniciando fusi√≥n...');
                    connRef.current.send({ type: 'SYNC_MERGE_REQUEST', items: currentItems });
                } 
                else if (action === 'push') {
                    if(confirm("¬øSeguro? Esto borrar√° los datos del OTRO dispositivo y pondr√° los tuyos.")) {
                        addLog('Enviando mis datos para sobrescribir remoto...');
                        connRef.current.send({ type: 'OVERWRITE_REMOTE_DATA', items: currentItems });
                    }
                }
                else if (action === 'pull') {
                    if(confirm("¬øSeguro? Esto BORRAR√Å tus datos locales y traer√° los del otro dispositivo.")) {
                        addLog('Solicitando datos remotos...');
                        connRef.current.send({ type: 'OVERWRITE_LOCAL_REQUEST' });
                    }
                }
            };

            return (
                <Modal onClose={onClose}>
                    <div className="space-y-6 text-center">
                        <div className="flex justify-center mb-2">
                            <div className="p-3 bg-cyan-900/20 rounded-full border border-cyan-500/30">
                                <ArrowRightLeft className="w-8 h-8 text-cyan-400" />
                            </div>
                        </div>
                        <h2 className="text-xl font-bold text-white">Sincronizaci√≥n P2P</h2>
                        
                        <div className="bg-black/50 p-2 rounded text-[10px] font-mono text-left h-16 overflow-y-auto text-green-400 border border-white/10">
                            {logs.map((l, i) => <div key={i}>&gt; {l}</div>)}
                        </div>

                        {status === 'initializing' && <div className="text-cyan-500 text-sm animate-pulse">Iniciando red P2P...</div>}
                        
                        {status === 'ready' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="bg-white p-2 rounded-lg inline-block mx-auto">
                                    <div ref={qrRef}></div>
                                </div>
                                <div>
                                    <p className="text-[10px] uppercase font-bold text-gray-500 mb-1">Tu ID de Conexi√≥n</p>
                                    <div className="flex gap-2 justify-center">
                                        <code className="bg-black/50 border border-white/10 px-3 py-2 rounded text-cyan-400 font-mono text-sm select-all">{myId || 'Generando...'}</code>
                                        <button onClick={() => navigator.clipboard.writeText(myId)} className="p-2 bg-white/10 rounded hover:bg-white/20"><Share2 className="w-4 h-4 text-white"/></button>
                                    </div>
                                </div>
                                <div className="border-t border-white/10 pt-4">
                                    <p className="text-[10px] uppercase font-bold text-gray-500 mb-2">Conectar a otro dispositivo</p>
                                    <div className="flex gap-2">
                                        <input 
                                            value={remoteIdInput}
                                            onChange={e => setRemoteIdInput(e.target.value)}
                                            placeholder="Pega el ID del otro dispositivo" 
                                            className="flex-1 bg-black border border-white/20 rounded px-3 py-2 text-xs text-white outline-none focus:border-cyan-500"
                                        />
                                        <button onClick={connectToRemote} className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold px-4 rounded text-xs">CONECTAR</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {status === 'connected' && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="text-green-400 font-bold text-sm">‚óè Conectado</div>
                                <p className="text-xs text-gray-400">¬øQu√© deseas hacer con los datos?</p>
                                
                                <div className="grid grid-cols-1 gap-3">
                                    <button onClick={() => triggerAction('merge')} className="flex items-center justify-between p-4 bg-cyan-900/20 border border-cyan-500/30 hover:bg-cyan-900/40 rounded-xl group transition text-left">
                                        <div>
                                            <div className="font-bold text-cyan-400 text-sm">üîÑ Fusionar (Recomendado)</div>
                                            <div className="text-[10px] text-gray-400">Combina datos de ambos. Mantiene lo m√°s reciente.</div>
                                        </div>
                                    </button>

                                    <button onClick={() => triggerAction('push')} className="flex items-center justify-between p-4 bg-white/5 border border-white/10 hover:bg-white/10 rounded-xl group transition text-left">
                                        <div>
                                            <div className="font-bold text-white text-sm flex items-center gap-2"><ArrowUpCircle size={14}/> Sobrescribir Remoto</div>
                                            <div className="text-[10px] text-gray-500">Borra el otro dispositivo y env√≠a mis datos.</div>
                                        </div>
                                    </button>

                                    <button onClick={() => triggerAction('pull')} className="flex items-center justify-between p-4 bg-white/5 border border-white/10 hover:bg-white/10 rounded-xl group transition text-left">
                                        <div>
                                            <div className="font-bold text-white text-sm flex items-center gap-2"><ArrowDownCircle size={14}/> Sobrescribir Local</div>
                                            <div className="text-[10px] text-gray-500">Borra mis datos y trae los del otro.</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        )}

                        {status === 'done' && (
                            <div className="py-8 space-y-4">
                                <CheckCircle className="w-12 h-12 text-green-500 mx-auto" />
                                <div className="text-lg font-bold text-white">¬°Proceso Terminado!</div>
                                <button onClick={onClose} className="bg-white/10 hover:bg-white/20 px-6 py-2 rounded-lg text-white text-xs font-bold mt-4">Cerrar</button>
                            </div>
                        )}

                        {status === 'error' && (
                            <div className="py-4 space-y-2">
                                <XCircle className="w-10 h-10 text-red-500 mx-auto" />
                                <div className="text-red-400 text-xs font-mono">Error de conexi√≥n</div>
                                <button onClick={() => initializePeer()} className="text-xs text-gray-400 underline mt-2 flex items-center justify-center gap-1 w-full"><RefreshCcw size={12}/> Reiniciar Red</button>
                            </div>
                        )}
                    </div>
                </Modal>
            );
        };

        const getVolLabel = (type) => {
            if(['movie','music'].includes(type)) return 'Min';
            if(['series','anime'].includes(type)) return 'Eps';
            if(['book'].includes(type)) return 'P√°gs';
            if(['manga','manhwa','manhua'].includes(type)) return 'Caps';
            if(['game'].includes(type)) return 'Hrs';
            return 'Unidades';
        };
        const getTypeColor = (type) => {
            if(type === 'movie') return 'bg-blue-500';
            if(['series','anime'].includes(type)) return 'bg-purple-500';
            if(type === 'book') return 'bg-orange-500';
            if(['manga','manhwa'].includes(type)) return 'bg-pink-500';
            if(type === 'music') return 'bg-green-500';
            if(type === 'game') return 'bg-red-500';
            return 'bg-gray-500';
        };

        const typeLabels = {
            movie: 'Pel√≠cula', series: 'Serie', anime: 'Anime',
            book: 'Libro', manga: 'Manga', manhwa: 'Manhwa', manhua: 'Manhua',
            music: 'M√∫sica', game: 'Juego'
        };

        const categoryMap = { 
            visual: 'Audiovisual', 
            reading: 'Lectura', 
            audio: 'M√∫sica', 
            gaming: 'Juegos' 
        };

        const themeColors = {
            cyan: { text: 'text-cyan-400', bg: 'bg-cyan-600', border: 'border-cyan-500', shadow: 'shadow-cyan-900/50', hoverText: 'group-hover:text-cyan-200', activeNav: 'text-cyan-400', bgSoft: 'bg-cyan-500/20' },
            purple: { text: 'text-purple-400', bg: 'bg-purple-600', border: 'border-purple-500', shadow: 'shadow-purple-900/50', hoverText: 'group-hover:text-purple-200', activeNav: 'text-purple-400', bgSoft: 'bg-purple-500/20' },
            green: { text: 'text-green-400', bg: 'bg-green-600', border: 'border-green-500', shadow: 'shadow-green-900/50', hoverText: 'group-hover:text-green-200', activeNav: 'text-green-400', bgSoft: 'bg-green-500/20' },
            orange: { text: 'text-orange-400', bg: 'bg-orange-600', border: 'border-orange-500', shadow: 'shadow-orange-900/50', hoverText: 'group-hover:text-orange-200', activeNav: 'text-orange-400', bgSoft: 'bg-orange-500/20' },
            pink: { text: 'text-pink-400', bg: 'bg-pink-600', border: 'border-pink-500', shadow: 'shadow-pink-900/50', hoverText: 'group-hover:text-pink-200', activeNav: 'text-pink-400', bgSoft: 'bg-pink-500/20' },
            blue: { text: 'text-blue-400', bg: 'bg-blue-600', border: 'border-blue-500', shadow: 'shadow-blue-900/50', hoverText: 'group-hover:text-blue-200', activeNav: 'text-blue-400', bgSoft: 'bg-blue-500/20' },
        };

        function ChronicleAppLocal() {
            const [items, setItems] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [subTab, setSubTab] = useState('all'); 
            const [loading, setLoading] = useState(true);
            const [uploading, setUploading] = useState(false);
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showProfileEdit, setShowProfileEdit] = useState(false);
            const [showInfo, setShowInfo] = useState(false); 
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [showSyncModal, setShowSyncModal] = useState(false); 
            
            const [showBanner, setShowBanner] = useState(true);
            const [showIntroCard, setShowIntroCard] = useState(true);
            const [showRiskWarning, setShowRiskWarning] = useState(true);

            const [viewTimeAsDays, setViewTimeAsDays] = useState(false);
            const [storageInfo, setStorageInfo] = useState({ usedMB: 0, quota: 0, percent: 0 });

            const [config, setConfig] = useState({ 
                username: 'Usuario Local', 
                avatarUrl: '',
                headerUrl: '', 
                appName: 'CHRONICLE',
                accentColor: 'cyan',
                compressionLevel: 'standard', 
                performanceMode: 'normal',
                storageType: 'localStorage',
                cardSize: 'medium'
            });
            
            const [formMode, setFormMode] = useState('edit'); 
            const [tagInput, setTagInput] = useState('');
            const [formData, setFormData] = useState({
                title: '', type: 'movie', status: 'completed', rating: 0, progress: 0, total: 0, 
                manualTime: 0, timeCalcMode: 'auto', pace: 0,
                image: '', year: '', author: '', hypeScore: 0, isHypeAuto: false,
                genres: [], review: '', dateString: '', favorite: false
            });

            const theme = themeColors[config.accentColor] || themeColors.cyan;

            const updateStorageStats = async () => {
                const stats = await getStorageUsage();
                setStorageInfo({ usage: stats.usedMB, quota: stats.quotaMB, percent: stats.percent });
            };

            const reloadItems = async (cfg = config) => {
                const loadedItems = await DataManager.getAll(cfg.storageType);
                setItems(loadedItems);
                updateStorageStats();
            };

            useEffect(() => {
                const init = async () => {
                   const localConfig = localStorage.getItem('chronicle_config');
                   let currentConfig = config;

                   if (localConfig) {
                       try {
                           const parsed = JSON.parse(localConfig);
                           if (!parsed.accentColor) parsed.accentColor = 'cyan';
                           if (!parsed.compressionLevel) parsed.compressionLevel = 'standard';
                           if (!parsed.storageType) parsed.storageType = 'localStorage';
                           if (!parsed.cardSize) parsed.cardSize = 'medium';
                           setConfig(parsed);
                           currentConfig = parsed;
                           
                           if (parsed.performanceMode === 'fast') document.body.classList.add('performance-mode');
                       } catch(e) { console.error("Error config", e); }
                   } else {
                       setShowOnboarding(true);
                   }

                   await reloadItems(currentConfig);

                   const hideBanner = localStorage.getItem('hide_local_banner');
                   if (hideBanner === 'true') setShowBanner(false);

                   const hideIntro = localStorage.getItem('hide_intro_card');
                   if (hideIntro === 'true') setShowIntroCard(false);

                   const hideRisk = localStorage.getItem('hide_risk_warning');
                   if (hideRisk === 'true') setShowRiskWarning(false);

                   setLoading(false);
                };

                init();
            }, []);

            useEffect(() => {
                if (config.performanceMode === 'fast') document.body.classList.add('performance-mode');
                else document.body.classList.remove('performance-mode');
            }, [config.performanceMode]);

            useEffect(() => {
                reloadItems();
            }, [config.storageType]);

            const dismissBanner = () => {
                setShowBanner(false);
                localStorage.setItem('hide_local_banner', 'true');
            };

            const dismissIntroCard = () => {
                setShowIntroCard(false);
                localStorage.setItem('hide_intro_card', 'true');
            };

            const dismissRiskWarning = () => {
                setShowRiskWarning(false);
                localStorage.setItem('hide_risk_warning', 'true');
            };

            const exportData = async (sourceType) => {
                const source = sourceType || config.storageType;
                try {
                    const dataToExport = await DataManager.getAll(source);
                    const dataStr = JSON.stringify({
                        items: dataToExport,
                        config: config,
                        source: source,
                        exportedAt: new Date().toISOString()
                    }, null, 2);
                    
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `chronicle_${source}_backup_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {
                    alert("Error exportando: " + e.message);
                }
            };

            const processImportBatch = async (itemsToImport, startIndex, batchSize, onProgress, onComplete) => {
                const endIndex = Math.min(startIndex + batchSize, itemsToImport.length);
                const batch = itemsToImport.slice(startIndex, endIndex);
                
                for (const item of batch) {
                    if (item.image && item.image.length > 500000) {
                        try {
                            item.image = await recompressBase64(item.image, 600, 0.6);
                        } catch (e) { console.warn("Error comprimiendo imagen", e); }
                    }
                    await DataManager.save(item, config.storageType);
                }

                onProgress(endIndex);

                if (endIndex < itemsToImport.length) {
                    setTimeout(() => processImportBatch(itemsToImport, endIndex, batchSize, onProgress, onComplete), 10);
                } else {
                    onComplete();
                }
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (!json.items || !Array.isArray(json.items)) throw new Error("Formato inv√°lido");
                        
                        const targetName = config.storageType === 'indexedDB' ? 'IndexedDB' : 'LocalStorage';
                        if (!confirm(`Se importar√°n ${json.items.length} entradas a ${targetName}. \n\nLas im√°genes pesadas se optimizar√°n autom√°ticamente para evitar lentitud. ¬øContinuar?`)) return;

                        setLoading(true);
                        
                        processImportBatch(
                            json.items, 
                            0, 
                            10, 
                            (count) => { console.log(`Procesados ${count}/${json.items.length}`); },
                            async () => {
                                if (json.config) {
                                    let newConfig = { ...json.config, storageType: config.storageType };
                                    if (newConfig.headerUrl && newConfig.headerUrl.startsWith('data:image') && newConfig.headerUrl.length > 500000) {
                                        try { newConfig.headerUrl = await recompressBase64(newConfig.headerUrl, 1000, 0.7); } catch (e) { console.warn("Error optimizando header", e); }
                                    }
                                    if (newConfig.avatarUrl && newConfig.avatarUrl.startsWith('data:image') && newConfig.avatarUrl.length > 500000) {
                                        try { newConfig.avatarUrl = await recompressBase64(newConfig.avatarUrl, 300, 0.7); } catch (e) { console.warn("Error optimizando avatar", e); }
                                    }
                                    setConfig(newConfig);
                                    localStorage.setItem('chronicle_config', JSON.stringify(newConfig));
                                }
                                setItems(json.items);
                                updateStorageStats();
                                setLoading(false);
                                alert("Importaci√≥n completada con √©xito.");
                                window.location.reload(); 
                            }
                        );

                    } catch (err) {
                        setLoading(false);
                        alert("Error al importar: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const openDetail = (item) => {
                setFormData(item);
                setFormMode('view');
                setIsModalOpen(true);
            };

            const startManualEntry = () => {
                let defaultType = 'movie';
                if(activeTab === 'reading') defaultType = 'book';
                if(activeTab === 'audio') defaultType = 'music';
                if(activeTab === 'gaming') defaultType = 'game';
                if(activeTab === 'visual') defaultType = 'movie';

                setFormData({
                    title: '', type: defaultType, status: 'completed', rating: 0, progress: 0, total: 0, 
                    manualTime: 0, timeCalcMode: 'manual', pace: 0,
                    image: '', year: '', author: '', hypeScore: 0, isHypeAuto: false, genres: [], review: '', dateString: '', favorite: false
                });
                setFormMode('edit'); 
                setIsModalOpen(true);
            };

            const getCompressionSettings = () => {
                switch(config.compressionLevel) {
                    case 'none': return { size: null, quality: 1 };
                    case 'low': return { size: 1200, quality: 0.9 };
                    case 'medium': return { size: 800, quality: 0.7 };
                    case 'high': return { size: 500, quality: 0.5 };
                    default: return { size: 800, quality: 0.7 };
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setUploading(true);
                try {
                    const settings = getCompressionSettings();
                    const compressedBase64 = await compressImage(file, settings.size, settings.quality);
                    setFormData({...formData, image: compressedBase64});
                } catch (err) {
                    alert("Error al procesar la imagen.");
                } finally {
                    setUploading(false);
                }
            };

            const handleAvatarUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const compressedBase64 = await compressImage(file, 200, 0.7); 
                    setConfig({...config, avatarUrl: compressedBase64});
                } catch (err) { alert("Error al procesar imagen de perfil."); }
            };

            const handleHeaderUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const settings = getCompressionSettings();
                    const size = settings.size ? Math.max(settings.size, 800) : null;
                    const compressedBase64 = await compressImage(file, size, settings.quality); 
                    setConfig({...config, headerUrl: compressedBase64});
                } catch (err) { alert("Error al procesar imagen de header."); }
            };

            const commitTag = () => {
                if (tagInput.trim()) {
                    setFormData({...formData, genres: [...formData.genres, tagInput.trim()]});
                    setTagInput('');
                }
            };

            const addTag = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    commitTag();
                }
            };
            const removeTag = (tag) => {
                setFormData({...formData, genres: formData.genres.filter(t => t !== tag)});
            };

            const calculateFinalTime = (data = formData) => {
                if (data.timeCalcMode === 'manual') return parseInt(data.manualTime) || 0;
                const amount = data.status === 'completed' ? (data.total || data.progress) : data.progress;
                const pace = parseFloat(data.pace) || 0;
                if (data.type === 'movie') return parseInt(data.total) || 120;
                if (data.type === 'music') return parseInt(data.total) || 45;
                if (data.type === 'game') return parseInt(data.total) * 60; 
                return Math.round((parseInt(amount) || 0) * pace);
            };

            const saveEntry = async () => {
                const finalTime = calculateFinalTime();
                const now = new Date();
                const payload = {
                    ...formData,
                    timeSpent: finalTime,
                    lastEdited: new Date().toISOString()
                };

                let newItem = { ...payload };
                if (!newItem.id) {
                    newItem.id = Date.now().toString();
                    newItem.createdAt = new Date().toISOString();
                    newItem.dateString = now.toLocaleDateString('es-ES');
                    newItem.monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
                }

                try {
                    await DataManager.save(newItem, config.storageType);
                    setItems(prev => {
                        const exists = prev.find(i => i.id === newItem.id);
                        if (exists) return prev.map(i => i.id === newItem.id ? newItem : i);
                        return [...prev, newItem];
                    });
                    updateStorageStats();
                    closeModal();
                } catch (e) {
                    alert(e.message || "Error al guardar.");
                }
            };

            const toggleFavorite = async (item) => {
                const newVal = !item.favorite;
                const updatedItem = { ...item, favorite: newVal };
                await DataManager.save(updatedItem, config.storageType);
                setItems(prev => prev.map(i => i.id === item.id ? updatedItem : i));
            };

            const deleteItem = async (id) => {
                if(confirm("¬øSeguro de borrar este registro localmente? Esta acci√≥n no se puede deshacer.")) {
                    await DataManager.delete(id, config.storageType);
                    setItems(prev => prev.filter(i => i.id !== id));
                    updateStorageStats();
                    if(isModalOpen) closeModal();
                }
            };

            const saveConfig = (newConfig) => {
                const cfg = newConfig || config;
                try {
                    localStorage.setItem('chronicle_config', JSON.stringify(cfg));
                    if(!newConfig) updateStorageStats();
                    setShowSettings(false);
                    setShowProfileEdit(false);
                    setShowOnboarding(false);
                } catch (e) {
                    alert("Error al guardar configuraci√≥n.");
                }
            };
            
            const updateConfig = (key, value) => {
                const newConfig = { ...config, [key]: value };
                setConfig(newConfig);
                saveConfig(newConfig);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setFormMode('edit');
                setFormData({ 
                    title: '', type: 'movie', status: 'completed', rating: 0, progress: 0, total: 0, 
                    timeSpent: 0, manualTime: 0, timeCalcMode: 'auto', pace: 0,
                    image: '', year: '', author: '', hypeScore: 0, isHypeAuto: false, genres: [], review: '', dateString: '', favorite: false
                });
            };

            const getStats = (filterFn) => {
                const subset = items.filter(filterFn);
                const s = {
                    count: subset.length,
                    time: 0, ratingSum: 0, ratedCount: 0,
                    status: { completed:0, watching:0, planned:0, dropped:0, rewatch:0 },
                    ratingDist: [0,0,0,0,0], hypeSum: 0,
                    movies: { count:0, time:0 },
                    series: { count:0, time:0, eps:0 },
                    anime: { count:0, time:0, eps:0 },
                    books: { count:0, time:0, pages:0 },
                    manga: { count:0, time:0, chapters:0 },
                    music: { count:0, time:0 },
                    games: { count:0, time:0 },
                    genres: {}, recentLogs: [], years: {}, favoritesCount: 0
                };

                const sorted = [...subset].sort((a,b) => {
                    const timeA = new Date(a.createdAt).getTime() || 0;
                    const timeB = new Date(b.createdAt).getTime() || 0;
                    return timeB - timeA;
                });
                s.recentLogs = sorted.slice(0, 5);

                const currentMonthKey = `${new Date().getFullYear()}-${new Date().getMonth()+1}`;
                s.thisMonthCount = subset.filter(i => i.monthKey === currentMonthKey).length;

                subset.forEach(i => {
                    const t = i.timeSpent || 0;
                    s.time += t;
                    if(i.rating > 0 && i.rating <= 5) { 
                        s.ratingSum += parseFloat(i.rating); s.ratedCount++; 
                        const bucketIndex = Math.max(0, Math.min(4, Math.floor(i.rating) - 1));
                        s.ratingDist[bucketIndex]++;
                    }
                    s.hypeSum += (i.hypeScore || 0);
                    const st = i.status || 'completed';
                    s.status[st] = (s.status[st] || 0) + 1;
                    if(i.genres) i.genres.forEach(g => s.genres[g] = (s.genres[g] || 0) + 1);
                    if(i.year) s.years[i.year] = (s.years[i.year] || 0) + 1;
                    if(i.favorite) s.favoritesCount = (s.favoritesCount || 0) + 1;

                    const vol = i.status === 'completed' ? (i.total || i.progress) : i.progress;
                    
                    if(i.type === 'movie') { s.movies.count++; s.movies.time += t; }
                    if(i.type === 'series') { s.series.count++; s.series.time += t; s.series.eps += (parseInt(vol)||0); }
                    if(i.type === 'anime') { s.anime.count++; s.anime.time += t; s.anime.eps += (parseInt(vol)||0); }
                    if(i.type === 'book') { s.books.count++; s.books.time += t; s.books.pages += (parseInt(vol)||0); }
                    if(['manga','manhwa','manhua'].includes(i.type)) { s.manga.count++; s.manga.time += t; s.manga.chapters += (parseInt(vol)||0); }
                    if(i.type === 'music') { s.music.count++; s.music.time += t; }
                    if(i.type === 'game') { s.games.count++; s.games.time += t; }
                });

                s.avgRating = s.ratedCount ? (s.ratingSum / s.ratedCount).toFixed(1) : 0;
                s.avgHype = s.count ? Math.round(s.hypeSum / s.count) : 0;
                s.topGenres = Object.entries(s.genres).sort((a,b) => b[1] - a[1]).slice(0, 5);
                const sortedYears = Object.entries(s.years).sort((a,b) => b[1] - a[1]);
                s.favYear = sortedYears.length > 0 ? sortedYears[0][0] : '-';
                
                let nickname = "Espectador Nuevo";
                if (s.ratedCount > 0) {
                    const r = parseFloat(s.avgRating);
                    if (r < 2.5) nickname = "Hater Profesional";
                    else if (r < 3.5) nickname = "Cr√≠tico Duro";
                    else if (r < 4.2) nickname = "Espectador Casual";
                    else if (r < 4.8) nickname = "Fan Entusiasta";
                    else nickname = "Amante del Arte";
                }
                s.ratingNickname = nickname;

                const h = Math.floor(s.time / 60);
                const m = s.time % 60;
                const d = (s.time / (60 * 24)).toFixed(1);
                
                s.timeFormattedHours = `${h}h ${m}m`;
                s.timeFormattedDays = `${d} D√≠as`;

                return s;
            };

            const globalStats = useMemo(() => getStats(() => true), [items]);
            const visualStats = useMemo(() => getStats(i => ['movie','series','anime'].includes(i.type)), [items]);
            const readStats = useMemo(() => getStats(i => ['book','manga','manhwa','manhua'].includes(i.type)), [items]);
            const audioStats = useMemo(() => getStats(i => i.type === 'music'), [items]);
            const gameStats = useMemo(() => getStats(i => i.type === 'game'), [items]);

            const filteredItems = useMemo(() => {
                let f = items;
                if (activeTab === 'visual') f = f.filter(i => ['movie','series','anime'].includes(i.type));
                else if (activeTab === 'reading') f = f.filter(i => ['book','manga','manhwa','manhua'].includes(i.type));
                else if (activeTab === 'audio') f = f.filter(i => i.type === 'music');
                else if (activeTab === 'gaming') f = f.filter(i => i.type === 'game');
                else if (activeTab === 'favorites') f = f.filter(i => i.favorite); 
                
                if (subTab !== 'all') {
                    if (activeTab === 'favorites') {
                        if (subTab === 'visual') f = f.filter(i => ['movie','series','anime'].includes(i.type));
                        if (subTab === 'reading') f = f.filter(i => ['book','manga','manhwa','manhua'].includes(i.type));
                        if (subTab === 'audio') f = f.filter(i => i.type === 'music');
                        if (subTab === 'gaming') f = f.filter(i => i.type === 'game');
                    } else if (activeTab === 'audio') {
                        if (subTab === 'collection') f = f.filter(i => i.type === 'music');
                    } else {
                        f = f.filter(i => i.type === subTab);
                    }
                }
                return f.sort((a,b) => {
                    const timeA = new Date(a.createdAt).getTime() || 0;
                    const timeB = new Date(b.createdAt).getTime() || 0;
                    return timeB - timeA;
                });
            }, [items, activeTab, subTab]);

            const gridClass = useMemo(() => {
                if (config.cardSize === 'small') return "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-5 gap-3";
                if (config.cardSize === 'large') return "grid grid-cols-1 md:grid-cols-2 gap-4";
                return "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4";
            }, [config.cardSize]);

            if (loading) return <div className="min-h-screen bg-[#050505] flex items-center justify-center text-cyan-500 font-mono text-xs tracking-[0.2em] animate-pulse">CARGANDO ALMACENAMIENTO LOCAL...</div>;

            return (
                <div className="min-h-screen bg-[#050505] text-gray-200 font-sans overflow-x-hidden selection:bg-cyan-500/30">
                
                <div className="fixed inset-0 pointer-events-none z-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#0a0a0a] via-[#050505] to-black" />
                
                {showBanner && (
                    <div className="fixed top-0 left-0 w-full z-[50] bg-cyan-900/95 backdrop-blur text-white text-[10px] p-1 text-center font-bold flex items-center justify-center gap-2 border-b border-cyan-500/20 top-banner">
                        <div className="flex items-center gap-2">
                            <Database className="w-3 h-3"/> MODO LOCAL ({config.storageType === 'indexedDB' ? 'IDB' : 'LS'})
                        </div>
                        <button onClick={dismissBanner} className="ml-2 hover:text-cyan-200 p-1"><X className="w-3 h-3" /></button>
                    </div>
                )}

                <div className={`relative z-10 max-w-7xl mx-auto flex flex-col md:flex-row h-[100dvh] md:h-screen overflow-hidden ${showBanner ? 'pt-8 md:pt-4' : 'pt-4'}`}>
                    
                    <aside className="hidden md:flex flex-col w-64 border-r border-white/5 bg-black/40 backdrop-blur-xl h-full p-6 justify-between shrink-0 relative z-[60]">
                        <div>
                            <div className="flex items-center gap-3 mb-8 cursor-pointer hover:bg-white/5 p-2 rounded-xl transition group" onClick={() => setShowProfileEdit(true)}>
                                <div className={`w-12 h-12 rounded-full overflow-hidden border-2 border-white/10 group-hover:${theme.border}/50 transition bg-white/5 shadow-lg shrink-0`}>
                                    {config.avatarUrl ? <img src={config.avatarUrl} className="w-full h-full object-cover" /> : <User className="w-6 h-6 m-3 text-gray-500" />}
                                </div>
                                <div className="min-w-0">
                                    <h1 className="font-bold text-white text-base tracking-tight leading-tight truncate">{config.username}</h1>
                                    <div className={`text-[10px] ${theme.text} font-mono tracking-widest uppercase mt-0.5`}>{config.appName || 'CHRONICLE'}</div>
                                </div>
                            </div>
                            
                            <nav className="space-y-1">
                                <NavBtn active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutGrid />} label="Inicio" />
                                <NavBtn active={activeTab === 'favorites'} onClick={() => {setActiveTab('favorites'); setSubTab('all')}} icon={<Heart />} label="Favoritos" />
                                <div className="h-px bg-white/5 my-4 mx-2" />
                                <NavBtn active={activeTab === 'visual'} onClick={() => {setActiveTab('visual'); setSubTab('all')}} icon={<Film />} label="Audiovisual" />
                                <NavBtn active={activeTab === 'reading'} onClick={() => {setActiveTab('reading'); setSubTab('all')}} icon={<Book />} label="Lectura" />
                                <NavBtn active={activeTab === 'audio'} onClick={() => {setActiveTab('audio'); setSubTab('collection')}} icon={<Disc />} label="M√∫sica" />
                                <NavBtn active={activeTab === 'gaming'} onClick={() => {setActiveTab('gaming'); setSubTab('all')}} icon={<Gamepad2 />} label="Juegos" />
                            </nav>
                        </div>
                        <div className="space-y-3">
                                <button onClick={() => setShowSyncModal(true)} className="w-full py-2 bg-cyan-900/20 hover:bg-cyan-900/30 border border-cyan-500/20 rounded-lg text-xs flex items-center justify-center gap-2 text-cyan-400 hover:text-cyan-300 transition animate-in fade-in">
                                    <RefreshCw className="w-3 h-3" /> Sync P2P
                                </button>

                                <button onClick={() => setShowInfo(true)} className="w-full py-2 bg-yellow-900/20 hover:bg-yellow-900/30 border border-yellow-500/20 rounded-lg text-xs flex items-center justify-center gap-2 text-yellow-500 hover:text-yellow-400 transition">
                                    <Info className="w-3 h-3" /> Info Local
                                </button>
                                
                                <button onClick={startManualEntry} className={`w-full py-3 ${theme.bg} hover:opacity-90 text-white font-bold rounded-lg text-xs uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg ${theme.shadow}`}>
                                    <Plus className="w-4 h-4" /> Registrar
                                </button>
                                <button onClick={() => setShowSettings(true)} className="w-full py-2 bg-white/5 hover:bg-white/10 border border-white/5 rounded-lg text-xs flex items-center justify-center gap-2 text-gray-400 hover:text-white">
                                    <Settings className="w-3 h-3" /> Ajustes
                                </button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto scroll-smooth custom-scrollbar relative pb-24 md:pb-0">
                        {config.headerUrl && (
                            <div className="w-full h-48 md:h-64 relative mb-4">
                                <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: `url(${config.headerUrl})`}}></div>
                                <div className="absolute inset-0 bg-gradient-to-b from-transparent to-[#050505]"></div>
                                <div className="absolute bottom-4 left-4 md:left-8">
                                    <h1 className="text-3xl md:text-5xl font-black text-white drop-shadow-lg tracking-tighter">{config.appName || 'CHRONICLE'}</h1>
                                    <p className="text-sm text-gray-300 drop-shadow">Colecci√≥n de {config.username}</p>
                                </div>
                            </div>
                        )}

                        <div className={`p-4 md:p-8 ${config.headerUrl ? 'pt-0' : ''}`}>
                            <div className="md:hidden flex justify-between items-center mb-6">
                                <div className="flex items-center gap-3" onClick={() => setShowProfileEdit(true)}>
                                    <div className="w-10 h-10 rounded-full overflow-hidden bg-white/10 border border-white/10 shrink-0">
                                        {config.avatarUrl ? <img src={config.avatarUrl} className="w-full h-full object-cover" /> : <User className="w-5 h-5 m-2.5 text-gray-500" />}
                                    </div>
                                    <div>
                                        <div className="font-bold text-white text-sm leading-none">{config.username}</div>
                                        <span className={`font-mono text-[9px] ${theme.text} tracking-widest`}>{config.appName || 'CHRONICLE'}</span>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSyncModal(true)}><RefreshCw className="w-5 h-5 text-cyan-400" /></button>
                                    <button onClick={() => setShowInfo(true)}><Info className="w-5 h-5 text-yellow-500" /></button>
                                    <button onClick={() => setShowSettings(true)}><Settings className="w-5 h-5 text-gray-500" /></button>
                                </div>
                            </div>

                            {showRiskWarning && (
                                <div className="mb-6 bg-orange-900/20 border border-orange-500/30 rounded-xl p-4 flex items-start gap-3 relative animate-in fade-in">
                                    <AlertTriangle className="text-orange-500 shrink-0 mt-0.5" size={18} />
                                    <div className="text-xs text-orange-200/90 pr-6">
                                        <strong className="text-orange-400 block mb-1">Precauci√≥n: Datos Locales</strong>
                                        <ul className="list-disc pl-3 space-y-1">
                                            <li>Esta app funciona 100% en tu navegador. Si limpias el cach√©, <strong>perder√°s tus datos</strong>.</li>
                                            <li>Puede haber errores al importar archivos JSON corruptos.</li>
                                            <li>Recomendaci√≥n: Ve a <span className="font-bold text-white">Ajustes &gt; Exportar</span> regularmente.</li>
                                        </ul>
                                    </div>
                                    <button 
                                        onClick={dismissRiskWarning}
                                        className="absolute top-2 right-2 text-orange-500/50 hover:text-orange-400 p-1"
                                    >
                                        <X size={14} />
                                    </button>
                                </div>
                            )}

                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-in fade-in">
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {showIntroCard && (
                                            <div className="md:col-span-2 relative h-64 rounded-2xl overflow-hidden group border border-white/10 bg-[#0c0c0e]">
                                                <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1614726365206-8d5945399516?q=80&w=2000&auto=format&fit=crop')] bg-cover bg-center opacity-20"></div>
                                                <div className="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-transparent"></div>
                                                
                                                <button onClick={dismissIntroCard} className="absolute top-4 right-4 z-20 text-gray-500 hover:text-white p-2 bg-black/50 rounded-full backdrop-blur-md transition">
                                                    <X className="w-4 h-4" />
                                                </button>

                                                <div className="relative z-10 p-8 h-full flex flex-col justify-center">
                                                    <div className={`flex items-center gap-2 ${theme.text} font-bold text-xs uppercase tracking-[0.2em] mb-4`}>
                                                        <Database className="w-4 h-4"/> ALMACENAMIENTO LOCAL ({config.storageType === 'indexedDB' ? 'IDB' : 'LS'})
                                                    </div>
                                                    
                                                    <h2 className="text-2xl md:text-3xl font-bold text-white leading-tight mb-2">Tu colecci√≥n est√° segura.</h2>
                                                    <p className="text-gray-400 text-sm max-w-md mb-6">
                                                        Est√°s usando la versi√≥n local de Chronicle. No se requieren cuentas ni servidores externos. Todo vive en este dispositivo.
                                                    </p>
                                                    
                                                    <div className="flex gap-3">
                                                        <button onClick={startManualEntry} className="px-4 py-2 bg-white text-black font-bold rounded text-xs hover:bg-gray-200 transition">A√±adir Entrada Manual</button>
                                                        <button onClick={() => setShowSyncModal(true)} className="px-4 py-2 bg-cyan-900/50 text-cyan-400 border border-cyan-500/50 font-bold rounded text-xs hover:bg-cyan-900/70 transition flex items-center gap-2"><RefreshCw size={12}/> Sync P2P</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {(() => {
                                            const count = showIntroCard ? 1 : 3;
                                            const itemsToShow = globalStats.recentLogs.slice(0, count);
                                            
                                            if (itemsToShow.length > 0) {
                                                return itemsToShow.map((item, index) => (
                                                    <div 
                                                        key={item.id}
                                                        className={`glass-panel rounded-2xl relative overflow-hidden group border border-white/10 md:col-span-1 h-64 flex-col justify-end clickable-card transition-all duration-300 ease-out cursor-pointer ${!showIntroCard && index > 0 ? 'hidden md:flex' : 'flex'}`}
                                                        onClick={() => openDetail(item)}
                                                    >
                                                        <div className="absolute inset-0 pointer-events-none">
                                                            {item.image ? (
                                                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style={{backgroundImage: `url(${item.image})`}}></div>
                                                            ) : (
                                                                <div className="absolute inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center"><Film className="w-12 h-12 text-gray-700"/></div>
                                                            )}
                                                            <div className="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
                                                        </div>
                                                        
                                                        <div className="relative z-10 p-5 w-full pointer-events-none">
                                                            <div className={`text-[9px] font-bold ${theme.text} uppercase tracking-widest mb-2 flex items-center gap-2 shadow-black drop-shadow-md`}>
                                                                <History className="w-3 h-3"/> ACTIVIDAD RECIENTE
                                                            </div>
                                                            <h3 className={`text-xl font-bold text-white leading-tight line-clamp-1 mb-1 ${theme.hoverText} transition-colors drop-shadow-md`}>
                                                                {item.title}
                                                            </h3>
                                                            <div className="flex items-center gap-2 text-xs text-gray-200 mb-3 drop-shadow-md font-medium">
                                                                <span className="capitalize">{typeLabels[item.type]}</span>
                                                                <span>‚Ä¢</span>
                                                                <span>{item.year}</span>
                                                            </div>
                                                            
                                                            {item.status === 'watching' && (
                                                                <div className="w-full h-1 bg-white/20 rounded-full overflow-hidden backdrop-blur-sm">
                                                                    <div className={`h-full ${theme.bg}`} style={{width: `${(item.progress / item.total) * 100}%`}}></div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ));
                                            } else if (!showIntroCard && itemsToShow.length === 0) {
                                                return (
                                                    <div className="md:col-span-3 glass-panel rounded-2xl h-64 flex flex-col items-center justify-center p-6 text-center border border-white/10">
                                                        <Database className="w-12 h-12 text-gray-600 mb-4"/>
                                                        <div className="text-gray-400 text-lg font-bold">Tu colecci√≥n est√° vac√≠a</div>
                                                        <button onClick={startManualEntry} className={`mt-4 px-6 py-2 ${theme.bg} text-white font-bold rounded-lg text-xs uppercase`}>
                                                            Registrar Primera Entrada
                                                        </button>
                                                    </div>
                                                );
                                            } else {
                                                return (
                                                    <div className="w-full h-full flex flex-col items-center justify-center p-6 text-center relative z-10 glass-panel rounded-2xl border border-white/10">
                                                        <History className="w-8 h-8 text-gray-600 mb-2"/>
                                                        <div className="text-gray-500 text-sm">Sin actividad reciente</div>
                                                    </div>
                                                );
                                            }
                                        })()}
                                    </div>

                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                        <StatCard 
                                            icon={<Clock className={theme.text}/>} 
                                            label="Tiempo Total" 
                                            val={viewTimeAsDays ? globalStats.timeFormattedDays : globalStats.timeFormattedHours} 
                                            sub={viewTimeAsDays ? "Click para Horas" : "Click para D√≠as"} 
                                            onClick={() => setViewTimeAsDays(!viewTimeAsDays)}
                                            highlight={true}
                                            accentText={theme.text}
                                        />
                                        <StatCard icon={<CheckCircle className="text-green-400"/>} label="Completados" val={globalStats.status.completed} sub="Entradas Terminadas" />
                                        <StatCard icon={<Activity className="text-purple-400"/>} label="Mainstream" val={`${globalStats.avgHype}%`} sub="Popularidad" />
                                        <StatCard icon={<Star className="text-yellow-400"/>} label="Promedio" val={globalStats.avgRating} sub={globalStats.ratingNickname} />
                                        <StatCard icon={<Calendar className="text-pink-400"/>} label="Entradas este Mes" val={globalStats.thisMonthCount} sub="Ritmo Mensual" />
                                        <StatCard icon={<Database className="text-white"/>} label="Entradas" val={globalStats.count} sub="Archivo Local" />
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="glass-panel rounded-2xl p-5 md:col-span-1">
                                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><PieChart className="w-3 h-3"/> Estado del Archivo</h3>
                                            <div className="space-y-4">
                                                <StatusRow label="Completado" val={globalStats.status.completed} color="bg-green-500" total={globalStats.count} />
                                                <StatusRow label="Viendo / Leyendo" val={globalStats.status.watching} color="bg-blue-500" total={globalStats.count} />
                                                <StatusRow label="Planeado" val={globalStats.status.planned} color="bg-gray-500" total={globalStats.count} />
                                                <StatusRow label="Abandonado" val={globalStats.status.dropped} color="bg-red-500" total={globalStats.count} />
                                                <StatusRow label="Rewatch" val={globalStats.status.rewatch} color="bg-purple-500" total={globalStats.count} />
                                            </div>
                                        </div>

                                        <TopTagsBox title="Top Etiquetas" tags={globalStats.topGenres} accentText={theme.text} />

                                        <div className="glass-panel rounded-2xl p-5 md:col-span-1 flex flex-col justify-between">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2"><BarChart3 className="w-3 h-3" /> Distribuci√≥n</h3>
                                            </div>
                                            <div className="flex items-end justify-between h-32 gap-2 px-2 pb-2 mt-auto">
                                                {globalStats.ratingDist.map((count, i) => {
                                                    const max = Math.max(...globalStats.ratingDist, 1);
                                                    const height = max > 0 ? (count / max) * 100 : 0;
                                                    return (
                                                        <div key={i} className="flex-1 flex flex-col justify-end items-center gap-1 group h-full">
                                                            <div className="w-full bg-cyan-900/20 rounded-t hover:bg-cyan-500/40 transition-all relative flex flex-col justify-end" style={{height: `${Math.max(height, 5)}%`}}>
                                                                <div className="text-[9px] text-white text-center opacity-0 group-hover:opacity-100 mb-1">{count}</div>
                                                                <div className={`w-full ${height > 0 ? `${theme.bg}/50` : 'bg-transparent'} h-full rounded-t`}></div>
                                                            </div>
                                                            <div className="text-[10px] text-gray-500 font-bold">{i+1}‚òÖ</div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="glass-panel rounded-2xl p-5">
                                        <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><List className="w-3 h-3"/> Actividad Reciente</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            {globalStats.recentLogs.map(item => (
                                                <div 
                                                    key={item.id} 
                                                    className="flex items-center gap-3 bg-white/5 p-2 rounded-lg border border-white/5 cursor-pointer hover:bg-white/10 transition"
                                                    onClick={() => openDetail(item)} 
                                                >
                                                    <div className={`w-8 h-8 rounded shrink-0 ${getTypeColor(item.type)} opacity-80 flex items-center justify-center overflow-hidden`}>
                                                        {item.image ? <img src={item.image} className="w-full h-full object-cover"/> : (
                                                            <>
                                                                {item.type === 'movie' && <Film className="w-4 h-4 text-white"/>}
                                                                {item.type === 'book' && <Book className="w-4 h-4 text-white"/>}
                                                                {item.type === 'game' && <Gamepad2 className="w-4 h-4 text-white"/>}
                                                                {item.type === 'music' && <Music className="w-4 h-4 text-white"/>}
                                                            </>
                                                        )}
                                                    </div>
                                                    <div className="min-w-0 flex-1">
                                                        <div className="text-xs font-bold text-white truncate">{item.title}</div>
                                                        <div className="text-[9px] text-gray-500">{item.dateString}</div>
                                                    </div>
                                                    <div className="text-yellow-500 text-[10px] font-mono">{parseFloat(item.rating).toFixed(1)}‚òÖ</div>
                                                </div>
                                            ))}
                                            {globalStats.recentLogs.length === 0 && <div className="text-xs text-gray-600 col-span-full text-center py-4">No hay actividad reciente.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {(activeTab === 'visual' || activeTab === 'reading' || activeTab === 'gaming' || activeTab === 'audio' || activeTab === 'favorites') && (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {activeTab === 'visual' && (
                                            <>
                                                <DetailStatBox title="Cine" val={visualStats.movies.count} sub={`${Math.floor(visualStats.movies.time/60)} horas`} icon={<Film className="text-blue-400"/>} />
                                                <DetailStatBox title="Series & Anime" val={visualStats.series.count + visualStats.anime.count} sub={`${visualStats.series.eps + visualStats.anime.eps} episodios`} icon={<Tv className="text-purple-400"/>} />
                                                <div className="md:row-span-2"><TopTagsBox title="Top Visual" tags={visualStats.topGenres} accentText={theme.text} /></div>
                                            </>
                                        )}
                                        {activeTab === 'reading' && (
                                            <>
                                                <DetailStatBox title="Libros" val={readStats.books.count} sub={`${readStats.books.pages.toLocaleString()} p√°gs`} icon={<Book className="text-orange-400"/>} />
                                                <DetailStatBox title="Manga" val={readStats.manga.count} sub={`${readStats.manga.chapters} caps`} icon={<Layers className="text-pink-400"/>} />
                                                <div className="md:row-span-2"><TopTagsBox title="Top Lectura" tags={readStats.topGenres} accentText={theme.text} /></div>
                                            </>
                                        )}
                                        {activeTab === 'gaming' && (
                                            <>
                                                <DetailStatBox title="Biblioteca" val={gameStats.games.count} sub="T√≠tulos" icon={<Gamepad2 className="text-green-400"/>} />
                                                <DetailStatBox title="Tiempo Jugado" val={`${Math.floor(gameStats.games.time/60)}h`} sub="Estimado" icon={<Clock className="text-green-400"/>} />
                                                <div className="md:row-span-2"><TopTagsBox title="Top Gaming" tags={gameStats.topGenres} accentText={theme.text} /></div>
                                            </>
                                        )}
                                        {activeTab === 'audio' && (
                                            <>
                                                <DetailStatBox title="√Ålbumes" val={audioStats.music.count} sub="Colecci√≥n" icon={<Disc className="text-green-400"/>} />
                                                <DetailStatBox title="Tiempo Escucha" val={`${Math.floor(audioStats.music.time/60)}h`} sub="Estimado" icon={<Headphones className="text-green-400"/>} />
                                                <div className="md:row-span-2"><TopTagsBox title="Top Audio" tags={audioStats.topGenres} accentText={theme.text} /></div>
                                            </>
                                        )}
                                    </div>

                                    <div className="flex justify-between items-end border-b border-white/5 pb-2">
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                            <FilterBtn label="Todo" active={subTab === 'all'} onClick={() => setSubTab('all')} />
                                            {activeTab === 'visual' && ['movie', 'series', 'anime'].map(t => (
                                                <FilterBtn key={t} label={typeLabels[t].toUpperCase()} active={subTab === t} onClick={() => setSubTab(t)} />
                                            ))}
                                            {activeTab === 'reading' && ['book', 'manga', 'manhwa', 'manhua'].map(t => (
                                                <FilterBtn key={t} label={typeLabels[t].toUpperCase()} active={subTab === t} onClick={() => setSubTab(t)} />
                                            ))}
                                            {activeTab === 'favorites' && ['visual', 'reading', 'audio', 'gaming'].map(t => (
                                                <FilterBtn key={t} label={categoryMap[t].toUpperCase()} active={subTab === t} onClick={() => setSubTab(t)} />
                                            ))}
                                        </div>
                                        
                                        <div className="flex bg-white/5 rounded-lg p-1 shrink-0 ml-4">
                                            <button onClick={()=>updateConfig('cardSize', 'small')} className={`p-1.5 rounded transition ${config.cardSize === 'small' ? 'bg-white/20 text-white' : 'text-gray-500 hover:text-white'}`} title="P√≥ster"><Grid3X3 size={14}/></button>
                                            <button onClick={()=>updateConfig('cardSize', 'medium')} className={`p-1.5 rounded transition ${config.cardSize === 'medium' ? 'bg-white/20 text-white' : 'text-gray-500 hover:text-white'}`} title="Tarjeta"><List size={14}/></button>
                                            <button onClick={()=>updateConfig('cardSize', 'large')} className={`p-1.5 rounded transition ${config.cardSize === 'large' ? 'bg-white/20 text-white' : 'text-gray-500 hover:text-white'}`} title="Detallado"><Maximize2 size={14}/></button>
                                        </div>
                                    </div>

                                    <div className={gridClass}>
                                        {filteredItems.map(item => (
                                            <div 
                                                key={item.id} 
                                                className={`group bg-[#121214] border border-white/5 hover:border-cyan-500/30 rounded-xl overflow-hidden hover:shadow-2xl transition-all relative flex cursor-pointer ${
                                                    config.cardSize === 'small' ? 'flex-col h-auto' : 
                                                    config.cardSize === 'large' ? 'flex-row h-40 md:h-72' : 
                                                    'flex-row h-36'
                                                }`}
                                                onClick={() => openDetail(item)}
                                            >
                                                <div className={`bg-black relative shrink-0 hover:opacity-90 transition ${
                                                    config.cardSize === 'small' ? 'w-full aspect-[2/3]' : 
                                                    config.cardSize === 'large' ? 'w-28 md:w-48' : 
                                                    'w-24'
                                                }`}>
                                                    {item.image ? <img src={item.image} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition" /> : <div className="w-full h-full flex items-center justify-center bg-white/5 text-[9px]">NO IMG</div>}
                                                    <div className={`absolute top-0 left-0 bottom-0 w-1 ${getTypeColor(item.type)}`}></div>
                                                    <div className="absolute top-1 right-1 text-[8px] bg-black/80 px-1 rounded text-white font-bold shadow-md">{item.year}</div>
                                                </div>

                                                <div className="flex-1 p-3 flex flex-col justify-between min-w-0">
                                                    <div>
                                                        <div className="flex justify-between items-start mb-1">
                                                            <span className={`text-[8px] font-bold uppercase border px-1 rounded ${item.status === 'completed' ? 'border-green-500/50 text-green-400' : 'border-gray-500/50 text-gray-400'}`}>{typeLabels[item.type]}</span>
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); toggleFavorite(item); }}
                                                                className="z-10 relative"
                                                            >
                                                                <Heart className={`w-3 h-3 ${item.favorite ? 'text-red-500 fill-current' : 'text-gray-600 hover:text-white'}`} />
                                                            </button>
                                                        </div>
                                                        <h3 className={`${config.cardSize === 'small' ? 'text-xs' : 'text-sm'} font-bold text-white leading-tight truncate mb-0.5`}>{item.title}</h3>
                                                        <div className="text-[10px] text-gray-500 truncate">{item.author}</div>
                                                        
                                                        {config.cardSize === 'large' && item.review && (
                                                            <p className="text-[10px] text-gray-400 mt-2 line-clamp-3 md:line-clamp-6 italic leading-relaxed border-l-2 border-white/10 pl-2">
                                                                {item.review}
                                                            </p>
                                                        )}
                                                    </div>
                                                    
                                                    <div className={`flex justify-between items-end border-t border-white/5 ${config.cardSize === 'small' ? 'pt-2 mt-2' : 'pt-1 mt-1'}`}>
                                                        <div className="text-[9px] text-gray-600 font-mono">
                                                            {item.status === 'completed' ? item.total : `${item.progress}/${item.total}`} {getVolLabel(item.type)}
                                                        </div>
                                                        <div className={`flex gap-2 transition ${config.cardSize === 'small' ? '' : 'opacity-0 group-hover:opacity-100'}`}>
                                                            <div className="flex text-yellow-500 gap-0.5 items-center font-mono text-[10px]">
                                                                <Star className="w-2 h-2 fill-current"/> {parseFloat(item.rating).toFixed(1)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {filteredItems.length === 0 && (
                                            <div className="col-span-full py-12 text-center border border-dashed border-white/10 rounded-xl text-gray-600 text-xs">
                                                No hay items en esta categor√≠a. Usa el bot√≥n "Registrar" para a√±adir uno manualmente.
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>

                <div className="fixed bottom-0 left-0 w-full z-[500] md:hidden bg-[#050505]/95 backdrop-blur-md border-t border-white/10 pb-safe" id="mobile-nav-bar">
                    <div className="flex justify-between items-end text-[10px] px-2 pt-1 pb-1">
                        <MobNav active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutGrid />} label="Inicio" accentClass={theme.activeNav} />
                        <MobNav active={activeTab === 'visual'} onClick={() => {setActiveTab('visual'); setSubTab('all')}} icon={<Film />} label="Visual" accentClass={theme.activeNav} />
                        <MobNav active={activeTab === 'audio'} onClick={() => {setActiveTab('audio'); setSubTab('collection')}} icon={<Disc />} label="M√∫sica" accentClass={theme.activeNav} />
                        
                        <div className="relative -top-5 px-1 pointer-events-auto">
                            <button onClick={startManualEntry} className={`text-black p-3 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.1)] active:scale-95 transition border-4 border-[#050505] ${theme.bg}`}><Plus className="w-6 h-6 text-white" /></button>
                        </div>

                        <div className="relative -top-5 px-1 pointer-events-auto" style={{marginLeft: '-10px'}}>
                             <button onClick={() => setShowSyncModal(true)} className="bg-cyan-900/50 p-2 rounded-full border border-cyan-500/50 shadow-lg text-cyan-400 active:scale-95"><RefreshCw size={14}/></button>
                        </div>

                        <MobNav active={activeTab === 'reading'} onClick={() => {setActiveTab('reading'); setSubTab('all')}} icon={<Book />} label="Libros" accentClass={theme.activeNav} />
                        <MobNav active={activeTab === 'favorites'} onClick={() => {setActiveTab('favorites'); setSubTab('all')}} icon={<Heart />} label="Favs" accentClass={theme.activeNav} />
                    </div>
                </div>

                {showInfo && (
                    <Modal onClose={() => setShowInfo(false)}>
                        <div className="space-y-4">
                            <h3 className="text-sm font-bold text-yellow-500 flex items-center gap-2 border-b border-white/10 pb-2">
                                <AlertTriangle className="w-4 h-4" /> Recomendaciones Modo Local
                            </h3>
                            <div className="bg-yellow-900/20 border border-yellow-700/30 p-4 rounded-lg text-xs space-y-3 text-gray-300 leading-relaxed">
                                <p>Esta versi√≥n de Chronicle usa <strong>IndexedDB</strong> para almacenamiento masivo o <strong>LocalStorage</strong> para mayor estabilidad.</p>
                                
                                <ul className="list-disc pl-4 space-y-2 text-gray-400">
                                    <li><strong>Sincronizaci√≥n P2P:</strong> Usa el bot√≥n <RefreshCw className="inline w-3 h-3"/> para conectar PC y M√≥vil y transferir datos sin servidores.</li>
                                    <li><strong>Exporta frecuentemente:</strong> Si borras el cach√© del navegador, podr√≠as perder tus datos. Ve a <em>Ajustes &gt; Exportar</em> para guardar una copia de seguridad en archivo JSON.</li>
                                    <li><strong>Im√°genes:</strong> Se comprimen autom√°ticamente.</li>
                                    <li><strong>Privacidad Total:</strong> Tus datos son tuyos.</li>
                                </ul>
                                
                                <button onClick={() => setShowInfo(false)} className="w-full mt-4 py-2 bg-white text-black font-bold rounded text-xs">Entendido</button>
                            </div>
                        </div>
                    </Modal>
                )}

                {showOnboarding && (
                    <div className="fixed inset-0 z-[20000] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl animate-in fade-in">
                        <div className="bg-[#0f0f10] border border-white/10 w-full sm:max-w-lg rounded-2xl shadow-2xl p-6 text-center">
                            <div className="w-16 h-16 bg-cyan-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-cyan-500/30">
                                <Database className="w-8 h-8 text-cyan-400" />
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-2">Bienvenido a Chronicle Local</h2>
                            <p className="text-sm text-gray-400 mb-6">
                                Esta es una aplicaci√≥n <strong>100% local</strong>. Tus datos nunca salen de tu dispositivo. 
                                Para comenzar, elige d√≥nde quieres guardar tu colecci√≥n:
                            </p>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <button 
                                    onClick={() => { setConfig({...config, storageType: 'localStorage'}); setShowOnboarding(false); saveConfig(); }}
                                    className="bg-[#1a1a1c] hover:bg-[#27272a] border border-white/10 p-4 rounded-xl text-left transition group"
                                >
                                    <div className="font-bold text-white mb-1 flex items-center gap-2 group-hover:text-cyan-400">
                                        <Save className="w-4 h-4" /> LocalStorage
                                    </div>
                                    <div className="text-[10px] text-gray-500">
                                        <span className="text-green-400 block mb-0.5">‚úì M√°s compatible y estable</span>
                                        <span className="text-red-400 block">‚úï L√≠mite estricto (~5MB)</span>
                                    </div>
                                </button>
                                
                                <button 
                                    onClick={() => { setConfig({...config, storageType: 'indexedDB'}); setShowOnboarding(false); saveConfig(); }}
                                    className="bg-[#1a1a1c] hover:bg-[#27272a] border border-white/10 p-4 rounded-xl text-left transition group"
                                >
                                    <div className="font-bold text-white mb-1 flex items-center gap-2 group-hover:text-cyan-400">
                                        <HardDrive className="w-4 h-4" /> IndexedDB
                                    </div>
                                    <div className="text-[10px] text-gray-500">
                                        <span className="text-green-400 block mb-0.5">‚úì Gran capacidad (Gigas)</span>
                                        <span className="text-yellow-500 block">‚ö† Modo Experimental</span>
                                    </div>
                                </button>
                            </div>
                            
                            <p className="text-[10px] text-gray-600">
                                Podr√°s cambiar esto m√°s tarde en Ajustes, pero se recomienda exportar tus datos antes.
                            </p>
                        </div>
                    </div>
                )}
                
                {showSyncModal && (
                    <P2PSyncModal 
                        onClose={() => setShowSyncModal(false)}
                        currentItems={items}
                        onMergeComplete={() => {
                            reloadItems();
                        }}
                        config={config}
                    />
                )}

                {showProfileEdit && (
                    <Modal onClose={() => setShowProfileEdit(false)}>
                        <div className="space-y-4">
                            <h3 className="text-xs font-mono text-white uppercase border-b border-white/10 pb-2">Editar Perfil Local</h3>
                            <div className="bg-white/5 p-4 rounded-lg text-center">
                                    <div className="relative w-24 h-24 mx-auto mb-4 group cursor-pointer">
                                        <div className={`w-full h-full rounded-full overflow-hidden border-2 border-white/10 group-hover:${theme.border} transition bg-black`}>
                                            {config.avatarUrl ? <img src={config.avatarUrl} className="w-full h-full object-cover" /> : <User className="w-10 h-10 m-6 text-gray-500" />}
                                        </div>
                                        <label className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-200">
                                            <Upload className="w-6 h-6 text-white" />
                                            <input type="file" className="hidden" accept="image/*" onChange={handleAvatarUpload} />
                                        </label>
                                    </div>

                                    <input value={config.username} onChange={e => setConfig({...config, username: e.target.value})} className="w-full bg-black border border-white/10 rounded p-3 text-white text-center mb-2 font-bold" placeholder="Tu Nombre" />
                                    <input value={config.avatarUrl} onChange={e => setConfig({...config, avatarUrl: e.target.value})} className="w-full bg-black border border-white/10 rounded p-3 text-white text-xs text-center" placeholder="https://imagen.jpg" />
                            </div>
                            
                            <button onClick={saveConfig} className={`w-full py-3 ${theme.bg} text-white font-bold rounded-lg text-xs uppercase`}>Guardar Perfil</button>
                        </div>
                    </Modal>
                )}

                {showSettings && (
                    <Modal onClose={() => setShowSettings(false)}>
                        <div className="space-y-4">
                            <h3 className="text-xs font-mono text-white uppercase border-b border-white/10 pb-2">Perfil & Config</h3>
                            
                            <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                                <div className="text-white font-bold text-xs mb-1 flex items-center justify-between">
                                    <span className="flex items-center gap-2"><HardDrive className="w-3 h-3 text-orange-500"/> Modo Almacenamiento</span>
                                </div>
                                <div className="flex gap-2 mb-2">
                                    <button 
                                        onClick={() => setConfig({...config, storageType: 'localStorage'})}
                                        className={`flex-1 py-2 rounded text-[10px] uppercase font-bold border transition ${config.storageType === 'localStorage' ? `${theme.bg} border-transparent text-white` : 'bg-black border-white/10 text-gray-500 hover:text-white'}`}
                                    >
                                        LocalStorage
                                    </button>
                                    <button 
                                        onClick={() => setConfig({...config, storageType: 'indexedDB'})}
                                        className={`flex-1 py-2 rounded text-[10px] uppercase font-bold border transition ${config.storageType === 'indexedDB' ? `${theme.bg} border-transparent text-white` : 'bg-black border-white/10 text-gray-500 hover:text-white'}`}
                                    >
                                        IndexedDB
                                    </button>
                                </div>

                                <div className="border-t border-white/5 pt-3">
                                    <label className="text-[9px] text-gray-500 block mb-2 font-bold uppercase">Exportar Datos (Respaldo)</label>
                                    <div className="grid grid-cols-2 gap-2 mb-3">
                                        <button onClick={() => exportData('localStorage')} className="py-2 bg-black border border-white/10 hover:border-white/30 text-white rounded text-xs flex flex-col items-center gap-1">
                                            <div className="flex items-center gap-1 text-[10px] text-gray-400"><Save className="w-3 h-3"/> LocalStorage</div>
                                            <span className="font-bold">Exportar LS</span>
                                        </button>
                                        <button onClick={() => exportData('indexedDB')} className="py-2 bg-black border border-white/10 hover:border-white/30 text-white rounded text-xs flex flex-col items-center gap-1">
                                            <div className="flex items-center gap-1 text-[10px] text-gray-400"><HardDrive className="w-3 h-3"/> IndexedDB</div>
                                            <span className="font-bold">Exportar IDB</span>
                                        </button>
                                    </div>
                                    
                                    <label className="text-[9px] text-gray-500 block mb-2 font-bold uppercase">Importar Datos</label>
                                    <label className="w-full py-3 bg-black border border-white/10 hover:border-white/30 text-white rounded text-xs flex items-center justify-center gap-2 cursor-pointer border-dashed">
                                        <FileJson className="w-4 h-4 text-green-400"/>
                                        <span>Seleccionar archivo JSON...</span>
                                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                                    </label>
                                </div>
                            </div>
                            
                            <div className="bg-white/5 p-3 rounded-lg space-y-3">
                                <div className={`text-white font-bold text-xs mb-1 flex items-center gap-2`}><Palette className={`w-3 h-3 ${theme.text}`}/> Personalizaci√≥n</div>
                                <div className="space-y-2">
                                    <div>
                                        <label className="text-[9px] text-gray-500 block mb-1">Nombre de tu Espacio (Header)</label>
                                        <input value={config.appName} onChange={e => setConfig({...config, appName: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs" placeholder="Ej: Cueva de Cine, Mi Diario..." />
                                    </div>
                                    <div>
                                        <label className="text-[9px] text-gray-500 block mb-1">Imagen de Header (Horizontal)</label>
                                        <div className="flex gap-2">
                                            <input value={config.headerUrl} onChange={e => setConfig({...config, headerUrl: e.target.value})} className="flex-1 bg-black border border-white/10 rounded p-2 text-white text-xs" placeholder="URL Imagen" />
                                            <label className="bg-white/10 hover:bg-white/20 px-3 rounded flex items-center justify-center cursor-pointer border border-white/10">
                                                <Upload className="w-3 h-3 text-white"/>
                                                <input type="file" className="hidden" accept="image/*" onChange={handleHeaderUpload} />
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[9px] text-gray-500 block mb-2">Color de Acento</label>
                                        <div className="flex gap-2">
                                            {Object.keys(themeColors).map(c => (
                                                <button 
                                                    key={c}
                                                    onClick={() => setConfig({...config, accentColor: c})}
                                                    className={`w-6 h-6 rounded-full border-2 ${config.accentColor === c ? 'border-white scale-110' : 'border-transparent opacity-70 hover:opacity-100'} transition-all`}
                                                    style={{backgroundColor: c === 'cyan' ? '#06b6d4' : c === 'purple' ? '#9333ea' : c === 'green' ? '#16a34a' : c === 'orange' ? '#ea580c' : c === 'pink' ? '#db2777' : '#2563eb'}}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div className="pt-2 border-t border-white/5">
                                        <label className="text-[9px] text-gray-500 block mb-2">Rendimiento</label>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-[10px] text-white">Modo Ahorro / Sin Lag</span>
                                            <button 
                                                onClick={() => setConfig({...config, performanceMode: config.performanceMode === 'normal' ? 'fast' : 'normal'})}
                                                className={`w-8 h-4 rounded-full transition-colors relative ${config.performanceMode === 'fast' ? theme.bg : 'bg-gray-600'}`}
                                            >
                                                <div className={`w-3 h-3 bg-white rounded-full absolute top-0.5 transition-all ${config.performanceMode === 'fast' ? 'left-4.5' : 'left-0.5'}`} style={{left: config.performanceMode === 'fast' ? '18px' : '2px'}}></div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button onClick={saveConfig} className={`w-full py-2 ${theme.bg} text-white font-bold rounded text-xs`}>GUARDAR AJUSTES</button>
                        </div>
                    </Modal>
                )}

                {isModalOpen && (
                    <Modal onClose={() => closeModal()}>
                        {formMode === 'view' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="flex gap-4">
                                    <div className="w-24 h-36 bg-black rounded-lg overflow-hidden border border-white/10 shadow-xl shrink-0">
                                        {formData.image ? <img src={formData.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-xs text-gray-700">NO IMG</div>}
                                    </div>
                                    <div className="flex-1 min-w-0 flex flex-col justify-end">
                                       <div className={`text-[10px] font-bold ${theme.text} uppercase tracking-widest mb-1`}>{typeLabels[formData.type]}</div>
                                       <h2 className="text-2xl font-bold text-white leading-none mb-1">{formData.title}</h2>
                                       <div className="text-sm text-gray-400">{formData.author} {formData.year ? `(${formData.year})` : ''}</div>
                                       <div className="flex items-center gap-2 mt-3">
                                            <StarRatingDisplay rating={formData.rating} size="w-5 h-5" showValue={true} />
                                       </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-3 gap-2 bg-white/5 p-3 rounded-xl border border-white/5">
                                    <div className="text-center border-r border-white/10">
                                        <div className="text-[9px] text-gray-500 uppercase">Estado</div>
                                        <div className="text-xs font-bold text-white capitalize">{formData.status === 'watching' ? 'En Progreso' : formData.status === 'dropped' ? 'Abandonado' : formData.status === 'planned' ? 'Planeado' : formData.status === 'rewatch' ? 'Rewatch' : 'Completado'}</div>
                                    </div>
                                    <div className="text-center border-r border-white/10">
                                        <div className="text-[9px] text-gray-500 uppercase">Tiempo</div>
                                        <div className="text-xs font-bold text-white">{formData.timeSpent} min</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-[9px] text-gray-500 uppercase">Mainstream</div>
                                        <div className="text-xs font-bold text-green-400">{formData.hypeScore}%</div>
                                    </div>
                                </div>

                                <div className="bg-black/30 p-4 rounded-xl border border-white/5 min-h-[100px]">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2">
                                        <Edit2 className="w-3 h-3"/> Rese√±a Personal
                                    </h3>
                                    {formData.review ? (
                                        <p className="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-serif">{formData.review}</p>
                                    ) : (
                                        <p className="text-xs text-gray-600 italic">Sin rese√±a escrita...</p>
                                    )}
                                </div>

                                {formData.genres && formData.genres.length > 0 && (
                                    <div className="flex flex-wrap gap-2">
                                        {formData.genres.map((tag, i) => (
                                            <span key={i} className="bg-white/5 border border-white/5 px-2 py-1 rounded text-[10px] text-gray-400">#{tag}</span>
                                        ))}
                                    </div>
                                )}

                                <div className="flex gap-3 pt-4 border-t border-white/10">
                                    <button onClick={() => setFormMode('edit')} className="flex-1 py-3 bg-white text-black font-bold rounded-lg text-xs uppercase hover:bg-gray-200 transition">Editar</button>
                                    <button onClick={closeModal} className="flex-1 py-3 bg-transparent border border-white/10 text-white font-bold rounded-lg text-xs uppercase hover:bg-white/5 transition">Cerrar</button>
                                </div>
                                <button onClick={() => deleteItem(formData.id)} className="w-full py-3 bg-red-900/30 text-red-400 font-bold rounded-lg text-xs uppercase hover:bg-red-900/50 transition border border-red-900/50">Eliminar Entrada</button>
                            </div>
                        )}

                        {formMode === 'edit' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center border-b border-white/10 pb-2">
                                    <h3 className="text-xs font-mono text-white">Editar / Crear Entrada</h3>
                                </div>

                                <div className="flex gap-3 bg-black/30 p-2 rounded-lg border border-white/5">
                                    <div className="w-12 h-16 bg-white/5 rounded shrink-0 overflow-hidden relative group">
                                        {formData.image ? <img src={formData.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-xs text-gray-700">IMG</div>}
                                        {formData.image ? (
                                             <button onClick={() => setFormData({...formData, image: ''})} className="absolute top-1 right-1 bg-red-600 text-white p-1 rounded-full shadow-lg z-20 hover:scale-110 transition"><Trash2 className="w-3 h-3"/></button>
                                        ) : (
                                            <label className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition">
                                                {uploading ? <Loader2 className="w-4 h-4 text-white animate-spin"/> : <Upload className="w-4 h-4 text-white" />}
                                                <input type="file" className="hidden" onChange={handleFileUpload} accept="image/*" />
                                            </label>
                                        )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="bg-transparent font-bold text-white text-base w-full outline-none border-b border-transparent focus:border-white/10" placeholder="T√≠tulo" />
                                        <div className="flex items-center gap-2 mt-2">
                                            <input value={formData.year} onChange={e => setFormData({...formData, year: e.target.value})} className="bg-white/5 px-2 py-1 rounded w-12 text-center text-xs outline-none text-white border border-white/10" placeholder="A√±o" />
                                            <input value={formData.author} onChange={e => setFormData({...formData, author: e.target.value})} className="bg-white/5 px-2 py-1 rounded flex-1 text-xs outline-none text-white border border-white/10" placeholder="Autor / Director" />
                                            <button onClick={() => setFormData({...formData, favorite: !formData.favorite})} className={`p-1.5 rounded ${formData.favorite ? 'text-red-500 bg-red-500/10' : 'text-gray-500 bg-white/5'}`}>
                                                <Heart className={`w-4 h-4 ${formData.favorite ? 'fill-current' : ''}`} />
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex items-center gap-2 px-1">
                                    <LinkIcon className="w-3 h-3 text-gray-500 shrink-0" />
                                    <input 
                                        value={formData.image && !formData.image.startsWith('data:') ? formData.image : ''} 
                                        onChange={e => setFormData({...formData, image: e.target.value})} 
                                        className="bg-transparent border-b border-white/10 w-full text-[10px] text-gray-400 focus:text-white focus:border-cyan-500 outline-none pb-1 transition placeholder:text-gray-600"
                                        placeholder="O pega una URL de imagen aqu√≠..."
                                    />
                                </div>

                                <div>
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-2">Categor√≠a</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {['movie','series','anime','book','manga','manhwa','manhua','music','game'].map(t => (
                                            <button key={t} onClick={() => setFormData({...formData, type: t})}
                                                className={`text-[9px] py-2 rounded font-bold uppercase transition border ${
                                                    formData.type === t ? `${theme.bg} text-white ${theme.border} shadow-lg ${theme.shadow}` : 'bg-black text-gray-400 border-white/10 hover:border-white/30'
                                                }`}
                                            >
                                                {typeLabels[t]}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-1">
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block">Etiquetas</label>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {formData.genres.map((tag, i) => (
                                            <span key={i} className="bg-white/10 px-2 py-1 rounded text-[10px] text-white flex items-center gap-1">
                                                {tag} <button onClick={() => removeTag(tag)}><X className="w-3 h-3 text-gray-400 hover:text-white"/></button>
                                            </span>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <input value={tagInput} onChange={e => setTagInput(e.target.value)} onKeyDown={addTag}
                                            className="flex-1 bg-black border border-white/20 rounded p-2 text-white text-xs outline-none focus:border-cyan-500" 
                                            placeholder="Ej: Terror, A24..." 
                                        />
                                        <button onClick={commitTag} className="bg-white/10 hover:bg-white/20 px-3 rounded text-white border border-white/10 flex items-center justify-center">
                                            <Plus className="w-4 h-4" />
                                        </button>
                                    </div>
                                </div>

                                <div className="bg-white/5 p-3 rounded-lg space-y-3">
                                     <div className="flex justify-between items-center">
                                         <label className="text-[9px] font-bold text-gray-500 uppercase">Estado</label>
                                         <select value={formData.status} onChange={e => {
                                                  const st = e.target.value;
                                                  setFormData({ ...formData, status: st, progress: st === 'completed' ? formData.total : formData.progress });
                                              }} 
                                              className="bg-black border border-white/20 rounded px-2 py-1 text-[10px] text-white outline-none"
                                         >
                                               <option value="completed">Completado</option>
                                               <option value="watching">En Progreso</option>
                                               <option value="planned">Planeado</option>
                                               <option value="dropped">Abandonado</option>
                                               <option value="rewatch">Rewatch</option>
                                         </select>
                                     </div>
                                     
                                     <div className="border-t border-white/10 pt-2">
                                          <div className="flex justify-between mb-2">
                                               <label className={`text-[9px] font-bold ${theme.text} uppercase flex items-center gap-1`}><Timer className="w-3 h-3"/> C√°lculo Tiempo</label>
                                               <div className="flex bg-black rounded p-0.5">
                                                   <button onClick={() => setFormData({...formData, timeCalcMode: 'auto'})} className={`text-[8px] px-2 py-0.5 rounded transition ${formData.timeCalcMode === 'auto' ? `${theme.bg} text-white` : 'text-gray-500'}`}>AUTO</button>
                                                   <button onClick={() => setFormData({...formData, timeCalcMode: 'manual'})} className={`text-[8px] px-2 py-0.5 rounded transition ${formData.timeCalcMode === 'manual' ? `${theme.bg} text-white` : 'text-gray-500'}`}>MANUAL</button>
                                               </div>
                                          </div>
                                          
                                          {formData.timeCalcMode === 'auto' ? (
                                               <div className="flex gap-2 items-end">
                                                   {['watching', 'dropped'].includes(formData.status) && (
                                                       <div className="flex-1">
                                                           <label className="text-[8px] text-gray-500 block mb-1">Progreso</label>
                                                           <input type="number" onWheel={(e) => e.stopPropagation()} value={formData.progress} onChange={e => setFormData({...formData, progress: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none focus:border-cyan-500" placeholder="0" />
                                                       </div>
                                                   )}
                                                   <div className="flex-1">
                                                       <label className="text-[8px] text-gray-500 block mb-1">{getVolLabel(formData.type)} (Total)</label>
                                                       <input type="number" onWheel={(e) => e.stopPropagation()} value={formData.total} onChange={e => setFormData({...formData, total: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none focus:border-cyan-500" placeholder="Total" />
                                                   </div>
                                                   
                                                   {['book','manga','manhwa','series','anime'].includes(formData.type) && (
                                                       <div className="w-16 shrink-0">
                                                           <label className="text-[8px] text-gray-500 block mb-1">Ritmo</label>
                                                           <input type="number" onWheel={(e) => e.stopPropagation()} value={formData.pace} onChange={e => setFormData({...formData, pace: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none focus:border-cyan-500" placeholder="Min/Un" />
                                                       </div>
                                                   )}
                                                   
                                                   <div className="pb-2 pl-1">
                                                       <span className="text-white font-mono text-xs font-bold">{calculateFinalTime(formData)}m</span>
                                                   </div>
                                               </div>
                                          ) : (
                                               <div>
                                                   <label className="text-[8px] text-gray-500 block mb-1">Tiempo Total (Minutos)</label>
                                                   <input type="number" onWheel={(e) => e.stopPropagation()} value={formData.manualTime} onChange={e => setFormData({...formData, manualTime: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none focus:border-cyan-500" placeholder="Ej: 120" />
                                               </div>
                                          )}
                                     </div>
                                </div>

                                 <div>
                                     <div className="flex justify-between mb-1">
                                         <div className="flex items-center gap-2">
                                             <label className="text-[9px] font-bold text-gray-500 uppercase">Nivel Mainstream (Manual)</label>
                                             <button 
                                                 onClick={(e) => {
                                                     e.preventDefault();
                                                     if(formData.title) {
                                                         const suffixes = {
                                                             movie: ' pel√≠cula', series: ' serie', anime: ' anime',
                                                             book: ' libro', manga: ' manga', manhwa: ' manhwa', 
                                                             manhua: ' manhua', music: ' m√∫sica', game: ' videojuego'
                                                         };
                                                         const query = `${formData.title}${suffixes[formData.type] || ''}`;
                                                         window.open(`https://trends.google.com/trends/explore?q=${encodeURIComponent(query)}`, '_blank');
                                                     }
                                                 }}
                                                 className={`text-[8px] flex items-center gap-1 px-1.5 py-0.5 rounded border border-white/10 transition ${formData.title ? 'bg-blue-900/30 text-blue-300 hover:bg-blue-900/50 cursor-pointer' : 'bg-gray-800 text-gray-600 cursor-not-allowed'}`}
                                                 title="Buscar popularidad en Google Trends"
                                             >
                                                 <TrendingUp className="w-2.5 h-2.5" /> Trends
                                             </button>
                                         </div>
                                          <span className={`text-[9px] font-mono ${formData.isHypeAuto ? 'text-green-400' : theme.text}`}>{formData.hypeScore}%</span>
                                     </div>
                                     <input 
                                         type="range" 
                                         min="0" 
                                         max="100" 
                                         value={formData.hypeScore} 
                                         onChange={e => setFormData({...formData, hypeScore: parseInt(e.target.value), isHypeAuto: false})} 
                                         onWheel={(e) => e.stopPropagation()}
                                         className="w-full cursor-pointer visible-range" 
                                     />
                                     <div className="flex justify-between text-[8px] text-gray-600 mt-1 uppercase">
                                          <span>Underground</span>
                                          <span>Global Hit</span>
                                     </div>
                                 </div>

                                <div>
                                    <div className="flex items-center justify-center p-2 bg-black/40 rounded-xl border border-white/10">
                                        <InteractiveStarRating 
                                            value={formData.rating} 
                                            onChange={(val) => setFormData({...formData, rating: val})} 
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">Rese√±a Personal</label>
                                    <textarea value={formData.review} onChange={e => setFormData({...formData, review: e.target.value})} className="w-full bg-black border border-white/20 rounded p-3 text-white text-xs outline-none resize-none" rows={6} placeholder="Escribe tu opini√≥n extensa..." />
                                </div>

                                <button onClick={saveEntry} className="w-full py-3 bg-white text-black font-bold rounded-lg text-xs uppercase tracking-widest hover:bg-gray-200">Guardar</button>
                            </div>
                        )}
                    </Modal>
                )}
            </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChronicleAppLocal />);
    </script>
</body>
</html>
