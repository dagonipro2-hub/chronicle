<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicle V36 - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #09090b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #050505; color: #e5e7eb; font-family: system-ui, sans-serif; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-panel {
            background: rgba(20, 20, 23, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { 
            Film, Tv, Book, Layers, Disc, Plus, Trash2, Star, 
            LayoutGrid, Settings, Activity, Zap, Radio, 
            Edit2, Search, Database, Hash, 
            BarChart3, Clock, CheckCircle, PlayCircle,
            Calendar, User, Timer, AlignLeft, Headphones, 
            TrendingUp, Award, Lock, Image as ImageIcon,
            Smartphone, Globe, Eye, PauseCircle, XCircle, RefreshCw, Upload, Music,
            Mic2, Album, Tag, X, Gamepad2, MousePointer2, Heart, ArrowLeft,
            LogOut, Save, Download, FileJson, Mail, AlertTriangle, Speaker, List, History, 
            BarChart2, PieChart
        } from 'https://esm.sh/lucide-react@0.300.0?deps=react@18.2.0';

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken,
            signOut
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            deleteDoc, 
            doc, 
            setDoc,
            getDoc,
            updateDoc,
            serverTimestamp,
            writeBatch 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let app, auth, db, appId;
        let systemError = null;

        const localConfig = {
            apiKey: "AIzaSyCO4JR0-u1Jhx4RMm37r1lR6YZL27b2Rhc",
            authDomain: "chronicle-2c18d.firebaseapp.com",
            projectId: "chronicle-2c18d",
            storageBucket: "chronicle-2c18d.firebasestorage.app",
            messagingSenderId: "809462204348",
            appId: "1:809462204348:web:83ebc987639bebe5d6cdb9",
            measurementId: "G-L90ZQVH27V"
        };

        try {
            let config;
            if (typeof window.__firebase_config !== 'undefined') {
                config = JSON.parse(window.__firebase_config);
                appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            } 
            else if (localConfig.apiKey && localConfig.apiKey !== "TU_API_KEY_AQUI") {
                config = localConfig;
                appId = 'chronicle-local-app';
            } 
            else {
                console.warn("Falta configuración Firebase Local");
            }

            if (config) {
                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                systemError = "No se encontró configuración de Firebase válida.";
            }

        } catch (e) {
            systemError = e.message;
            console.error("Error inicializando Firebase:", e);
        }

        const safeFetch = async (url, options = {}) => {
            try {
                const res = await fetch(url, options);
                if (!res.ok) return null;
                return await res.json();
            } catch (e) { return null; }
        };

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const searchUniversal = async (queryRaw, keys, typeFilter) => {
            const query = encodeURIComponent(queryRaw);
            const promises = [];
            const filter = (typeFilter || '').toLowerCase();

            if ((filter === '' || filter === 'visual') && keys.tmdb) {
                promises.push(
                    safeFetch(`https://api.themoviedb.org/3/search/multi?api_key=${keys.tmdb}&query=${query}&language=es-ES`)
                    .then(data => data?.results?.filter(i => i.media_type === 'movie' || i.media_type === 'tv').map(i => ({
                        id: i.id, source: 'TMDB', type: i.media_type === 'movie' ? 'movie' : 'series',
                        title: i.title || i.name, image: i.poster_path ? `https://image.tmdb.org/t/p/w200${i.poster_path}` : '',
                        year: (i.release_date || i.first_air_date || '').substring(0,4),
                        popularity: i.vote_count, meta: i.overview, 
                        total: 0, 
                        genres: [] 
                    })) || [])
                );
            }

            if (filter === '' || filter === 'visual') {
                promises.push(
                    delay(100).then(() => safeFetch(`https://api.jikan.moe/v4/anime?q=${query}&limit=3`))
                    .then(data => data?.data?.map(i => ({
                        id: i.mal_id, source: 'MAL', type: 'anime', title: i.title, image: i.images.jpg.image_url,
                        year: i.year || '', popularity: i.members, 
                        meta: `${i.episodes || '?'} eps`, total: i.episodes || 0, genres: i.genres?.map(g => g.name) || []
                    })) || [])
                );
            }
            if (filter === '' || filter === 'reading') {
                promises.push(
                    delay(300).then(() => safeFetch(`https://api.jikan.moe/v4/manga?q=${query}&limit=5`))
                    .then(data => data?.data?.map(i => ({
                        id: i.mal_id, source: 'MAL', type: i.type === 'Manhwa' ? 'manhwa' : i.type === 'Manhua' ? 'manhua' : 'manga',
                        title: i.title, image: i.images.jpg.image_url, year: i.published?.from?.substring(0,4) || '',
                        popularity: i.members, 
                        meta: `${i.chapters || '?'} ch`, total: i.chapters || 0, genres: i.genres?.map(g => g.name) || []
                    })) || [])
                );
            }

            if (filter === '' || filter === 'reading') {
                promises.push(
                    safeFetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=3`)
                    .then(data => data?.items?.map(i => ({
                        id: i.id, source: 'GBooks', type: 'book', title: i.volumeInfo.title,
                        image: i.volumeInfo.imageLinks?.thumbnail, year: i.volumeInfo.publishedDate?.substring(0,4),
                        popularity: i.volumeInfo.ratingsCount || 0, 
                        meta: `${i.volumeInfo.pageCount || '?'} págs`, total: i.volumeInfo.pageCount || 0, 
                        author: i.volumeInfo.authors?.[0], genres: i.volumeInfo.categories || []
                    })) || [])
                );
            }

            if ((filter === '' || filter === 'audio') && keys.lastfm) {
                promises.push(
                    safeFetch(`https://ws.audioscrobbler.com/2.0/?method=album.search&album=${query}&api_key=${keys.lastfm}&format=json&limit=3`)
                    .then(data => data?.results?.albummatches?.album?.map(i => ({
                        id: i.url, source: 'LastFM', type: 'music', title: i.name, image: i.image[2]['#text'],
                        year: '', popularity: parseInt(i.listeners), meta: i.artist, total: 0, genres: [] 
                    })) || [])
                );
            }

            try {
                const results = await Promise.all(promises);
                return results.flat().sort((a,b) => b.popularity - a.popularity);
            } catch (err) { return []; }
        };

        const fetchLastFmStats = async (user, key) => {
            if (!user || !key) return null;
            try {
                const [info, artists, albums, tracks, recent] = await Promise.all([
                    safeFetch(`https://ws.audioscrobbler.com/2.0/?method=user.getinfo&user=${user}&api_key=${key}&format=json`),
                    safeFetch(`https://ws.audioscrobbler.com/2.0/?method=user.gettopartists&user=${user}&api_key=${key}&format=json&limit=8&period=7day`),
                    safeFetch(`https://ws.audioscrobbler.com/2.0/?method=user.gettopalbums&user=${user}&api_key=${key}&format=json&limit=8&period=7day`),
                    safeFetch(`https://ws.audioscrobbler.com/2.0/?method=user.gettoptracks&user=${user}&api_key=${key}&format=json&limit=1&period=7day`),
                    safeFetch(`https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${user}&api_key=${key}&format=json&limit=20`)
                ]);

                const totalScrobbles = parseInt(info?.user?.playcount || 0);
                const registered = parseInt(info?.user?.registered?.unixtime || 0);
                const now = Math.floor(Date.now() / 1000);
                const daysSince = Math.max((now - registered) / 86400, 1);
                const avgDaily = (totalScrobbles / daysSince).toFixed(1);
                const totalHours = Math.floor((totalScrobbles * 3.5) / 60);
                const totalDays = Math.floor(totalHours / 24);
                const remainingHours = totalHours % 24;

                const recentTracks = recent?.recenttracks?.track || [];
                const nowPlayingTrack = recentTracks[0]?.['@attr']?.nowplaying ? recentTracks[0] : null;
                const lastTrack = recentTracks[0] || null;

                return {
                    totalScrobbles,
                    avgDaily,
                    totalHours,
                    timeFormatted: `${totalDays}d ${remainingHours}h`,
                    topArtists: artists?.topartists?.artist || [],
                    topAlbums: albums?.topalbums?.album || [],
                    topTracks: tracks?.toptracks?.track || [],
                    recentTracks: recentTracks,
                    currentTrack: nowPlayingTrack || lastTrack,
                    isNowPlaying: !!nowPlayingTrack
                };
            } catch (e) { console.error(e); return null; }
        };

        const NavBtn = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all ${active ? 'bg-white/10 text-white border border-white/10' : 'text-gray-400 hover:text-white hover:bg-white/5 border border-transparent'}`}>
                {React.cloneElement(icon, { className: 'w-4 h-4' })}<span className="text-xs font-medium">{label}</span>
            </button>
        );
        const FilterBtn = ({ active, onClick, label }) => (
            <button onClick={onClick} className={`shrink-0 px-3 py-1 rounded-full text-xs transition ${active ? 'bg-white text-black font-bold' : 'bg-white/5 text-gray-400 hover:text-white'}`}>{label}</button>
        );
        const MobNav = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-16 transition-colors ${active ? 'text-cyan-400' : 'text-gray-500'}`}>{React.cloneElement(icon, { className: 'w-5 h-5 mb-1' })}<span className="text-[9px] font-bold uppercase">{label}</span></button>
        );
        const StatCard = ({ icon, label, val, sub }) => (
            <div className="glass-panel rounded-2xl p-4 flex flex-col justify-between h-24 hover:bg-white/5 transition">
                <div className="flex justify-between items-start"><span className="text-[9px] font-bold text-gray-500 uppercase tracking-widest">{label}</span><div className="opacity-80">{icon}</div></div>
                <div><div className="text-2xl font-bold text-white font-mono">{val}</div><div className="text-[10px] text-gray-500">{sub}</div></div>
            </div>
        );
        const DetailStatBox = ({ title, val, sub, icon }) => (
            <div className="glass-panel rounded-xl p-4 flex items-center gap-4">
                <div className="bg-white/5 p-3 rounded-full">{icon}</div>
                <div><div className="text-[10px] uppercase text-gray-500 font-bold">{title}</div><div className="text-xl font-bold text-white">{val}</div><div className="text-[10px] text-gray-400">{sub}</div></div>
            </div>
        );
        const StatusRow = ({ label, val, color, total }) => (
            <div>
                <div className="flex justify-between text-[10px] text-gray-400 mb-1"><span>{label}</span><span className="text-white font-bold">{val}</span></div>
                <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden"><div className={`h-full ${color}`} style={{width: `${total ? (val/total)*100 : 0}%`}} /></div>
            </div>
        );
        const StatRow = ({ label, val }) => (
            <div className="flex justify-between border-b border-white/5 pb-2 last:border-0">
                <span className="text-[10px] font-bold text-gray-500 uppercase">{label}</span>
                <span className="text-sm font-bold text-white font-mono">{val}</span>
            </div>
        );
        const TopTagsBox = ({ title, tags }) => (
            <div className="glass-panel rounded-2xl p-5 flex flex-col h-full">
                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Hash className="w-3 h-3"/> {title}</h3>
                <div className="flex-1 flex flex-col justify-center gap-2">
                    {tags.length > 0 ? tags.map(([tag, count], i) => (
                        <div key={i} className="flex items-center justify-between group cursor-default">
                            <div className="flex items-center gap-3">
                                <span className="text-[10px] font-mono text-gray-600 w-4">0{i+1}</span>
                                <span className="text-sm font-bold text-gray-300 group-hover:text-white transition capitalize truncate max-w-[120px]">{tag}</span>
                            </div>
                            <div className="h-px flex-1 bg-white/5 mx-3"></div>
                            <span className="text-xs font-mono text-cyan-500">{count}</span>
                        </div>
                    )) : (
                        <div className="text-xs text-gray-600 text-center">Sin datos suficientes</div>
                    )}
                </div>
            </div>
        );
        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-in fade-in">
                <div className="bg-[#0f0f10] border border-white/10 w-full max-w-md rounded-2xl p-6 shadow-2xl relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-600 hover:text-white sticky z-50 bg-[#0f0f10] rounded-full p-1">✕</button>{children}
                </div>
            </div>
        );
        const getVolLabel = (type) => {
            if(['movie','music'].includes(type)) return 'Min';
            if(['series','anime'].includes(type)) return 'Eps';
            if(['book'].includes(type)) return 'Págs';
            if(['manga','manhwa','manhua'].includes(type)) return 'Caps';
            if(['game'].includes(type)) return 'Hrs';
            return 'Unidades';
        };
        const getTypeColor = (type) => {
            if(type === 'movie') return 'bg-blue-500';
            if(['series','anime'].includes(type)) return 'bg-purple-500';
            if(type === 'book') return 'bg-orange-500';
            if(['manga','manhwa'].includes(type)) return 'bg-pink-500';
            if(type === 'music') return 'bg-green-500';
            if(type === 'game') return 'bg-red-500';
            return 'bg-gray-500';
        };
        const filterMap = { 'Todo': '', 'Visual': 'visual', 'Lectura': 'reading', 'Audio': 'audio', 'Juegos': 'gaming' };

        function ChronicleAppV35() {
            if (systemError) return <div className="p-10 text-red-500 font-mono">ERROR SISTEMA: {systemError}</div>;

            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [subTab, setSubTab] = useState('all'); 
            const [loading, setLoading] = useState(true);
            const [globalAuthError, setGlobalAuthError] = useState(null);
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showProfileEdit, setShowProfileEdit] = useState(false);
            
            const [config, setConfig] = useState({ 
                tmdbKey: '', lastfmKey: '', lastfmUser: '', rawgKey: '', 
                igdbClientId: '', igdbToken: '',
                username: 'Usuario', avatarUrl: ''
            });
            const [lastFmStats, setLastFmStats] = useState(null);
            
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [formMode, setFormMode] = useState('search'); 
            const [searchFilter, setSearchFilter] = useState(''); 
            const [tagInput, setTagInput] = useState('');
            const [formData, setFormData] = useState({
                title: '', type: 'movie', status: 'completed', rating: 0, progress: 0, total: 0, 
                manualTime: 0, timeCalcMode: 'auto', pace: 0,
                image: '', year: '', author: '', hypeScore: 0, isHypeAuto: false,
                genres: [], review: '', dateString: '', favorite: false
            });

            useEffect(() => {
                const init = async () => {
                    try {
                        if (auth) {
                            if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                                await signInWithCustomToken(auth, window.__initial_auth_token);
                            } else {
                                const currentUser = auth.currentUser;
                                if (!currentUser) {
                                    await signInAnonymously(auth);
                                }
                            }
                        }
                    } catch (e) { 
                        console.error("Auth failed:", e); 
                        if (e.code === 'auth/operation-not-allowed') {
                            setGlobalAuthError("La autenticación anónima no está habilitada en Firebase Console. Habilítala en Authentication > Sign-in method.");
                        }
                    }
                };
                if (auth) init();
                
                if (auth) {
                    const unsub = onAuthStateChanged(auth, u => { setUser(u); if(!u) setLoading(false); });
                    return () => unsub();
                } else {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'media_logs'));
                const unsub = onSnapshot(q, 
                    snap => {
                        setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        setLoading(false);
                    },
                    err => { console.error("Error fetching items", err); setLoading(false); }
                );
                
                getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'))
                    .then(s => s.exists() && setConfig(s.data()))
                    .catch(e => console.log("No config found yet"));

                return () => unsub();
            }, [user]);

            useEffect(() => {
                if(!config.lastfmUser || !config.lastfmKey) return;
                const refreshStats = async () => {
                    const stats = await fetchLastFmStats(config.lastfmUser, config.lastfmKey);
                    setLastFmStats(stats);
                };
                refreshStats();
                const interval = setInterval(refreshStats, 30000); 
                return () => clearInterval(interval);
            }, [config.lastfmUser, config.lastfmKey]);

            const exportData = () => {
                const dataStr = JSON.stringify({
                    items: items,
                    config: config,
                    exportedAt: new Date().toISOString()
                }, null, 2);
                
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `chronicle_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (!json.items || !Array.isArray(json.items)) throw new Error("Formato inválido");
                        
                        if (!confirm(`Se importarán ${json.items.length} items. ¿Continuar?`)) return;

                        const batch = writeBatch(db);
                        json.items.forEach(item => {
                            const docRef = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'media_logs'));
                            const { id, ...data } = item;
                            batch.set(docRef, { ...data, importedAt: serverTimestamp() });
                        });
                        
                        if (json.config) {
                            const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                            batch.set(configRef, json.config);
                        }

                        await batch.commit();
                        alert("Importación exitosa. Recarga la página.");
                        window.location.reload();
                    } catch (err) {
                        alert("Error al importar: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleSearch = async (e) => {
                e?.preventDefault();
                if (!searchQuery) return;
                setIsSearching(true);
                const res = await searchUniversal(searchQuery, { 
                    tmdb: config.tmdbKey, 
                    lastfm: config.lastfmKey, 
                    rawg: config.rawgKey,
                    igdbClientId: config.igdbClientId,
                    igdbToken: config.igdbToken
                }, searchFilter);
                setSearchResults(res);
                setIsSearching(false);
            };

            useEffect(() => {
                if(searchQuery && formMode === 'search') handleSearch();
            }, [searchFilter]);

            const selectItem = (item) => {
                let hype = 0;
                let isAuto = false;
                if(item.source === 'TMDB') { hype = Math.min((item.popularity / 20000) * 100, 100); isAuto = true; }
                else if(item.source === 'MAL') { hype = Math.min((item.popularity / 400000) * 100, 100); isAuto = true; }
                else if(item.source === 'LastFM') { hype = Math.min((item.popularity / 500000) * 100, 100); isAuto = true; }
                else if(item.source === 'RAWG') { hype = Math.min((item.popularity / 1000) * 100, 100); isAuto = true; }
                
                let defaultPace = 0;
                if (item.type === 'book') defaultPace = 2; 
                if (item.type === 'manga' || item.type === 'manhwa') defaultPace = 5; 
                if (item.type === 'series' || item.type === 'anime') defaultPace = 23; 

                setFormData({
                    ...formData,
                    title: item.type === 'music' ? `${item.title} - ${item.meta}` : item.title,
                    type: item.type,
                    image: item.image,
                    year: item.year,
                    total: item.total || 0,
                    progress: item.total || 0,
                    author: item.author || (item.type === 'music' ? item.meta : ''),
                    hypeScore: Math.round(hype),
                    isHypeAuto: isAuto,
                    status: 'completed',
                    genres: item.genres || [],
                    timeCalcMode: 'auto',
                    pace: defaultPace,
                    manualTime: 0,
                    favorite: false
                });
                setFormMode('edit');
            };

            const startManualEntry = () => {
                let defaultType = 'movie';
                if(activeTab === 'reading') defaultType = 'book';
                if(activeTab === 'audio') defaultType = 'music';
                if(activeTab === 'gaming') defaultType = 'game';
                if(activeTab === 'visual') defaultType = 'movie';

                setFormData({
                    title: '', type: defaultType, status: 'completed', rating: 0, progress: 0, total: 0, 
                    manualTime: 0, timeCalcMode: 'manual', pace: 0,
                    image: '', year: '', author: '', hypeScore: 0, isHypeAuto: false, genres: [], review: '', dateString: '', favorite: false
                });
                setFormMode('edit'); 
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 100000) { alert("Imagen < 100kb"); return; }
                const reader = new FileReader();
                reader.onloadend = () => setFormData({...formData, image: reader.result});
                reader.readAsDataURL(file);
            };

            const addTag = (e) => {
                if (e.key === 'Enter' && tagInput.trim()) {
                    e.preventDefault();
                    setFormData({...formData, genres: [...formData.genres, tagInput.trim()]});
                    setTagInput('');
                }
            };
            const removeTag = (tag) => {
                setFormData({...formData, genres: formData.genres.filter(t => t !== tag)});
            };

            const calculateFinalTime = (data = formData) => {
                if (data.timeCalcMode === 'manual') return parseInt(data.manualTime) || 0;
                
                const amount = data.status === 'completed' ? (data.total || data.progress) : data.progress;
                const pace = parseFloat(data.pace) || 0;

                if (data.type === 'movie') return parseInt(data.total) || 120;
                if (data.type === 'music') return parseInt(data.total) || 45;
                if (data.type === 'game') return parseInt(data.total) * 60; 

                return Math.round((parseInt(amount) || 0) * pace);
            };

            const saveEntry = async () => {
                if (!user) { alert("Error: No hay usuario autenticado."); return; }
                const finalTime = calculateFinalTime();
                const now = new Date();
                const payload = {
                    ...formData,
                    timeSpent: finalTime,
                    lastEdited: serverTimestamp()
                };

                try {
                    if (formData.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'media_logs', formData.id), payload);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'media_logs'), {
                            ...payload,
                            createdAt: serverTimestamp(),
                            dateString: now.toLocaleDateString('es-ES'),
                            monthKey: `${now.getFullYear()}-${now.getMonth()+1}`
                        });
                    }
                    closeModal();
                } catch (e) { console.error("Error saving", e); }
            };

            const toggleFavorite = async (item) => {
                const newVal = !item.favorite;
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'media_logs', item.id), { favorite: newVal });
            };

            const deleteItem = async (id) => {
                if(confirm("¿Seguro de borrar este registro?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'media_logs', id));
                }
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setFormMode('search');
                setSearchQuery('');
                setSearchResults([]);
                setFormData({ 
                    title: '', type: 'movie', status: 'completed', rating: 0, progress: 0, total: 0, 
                    timeSpent: 0, manualTime: 0, timeCalcMode: 'auto', pace: 0,
                    image: '', year: '', author: '', hypeScore: 0, isHypeAuto: false, genres: [], review: '', dateString: '', favorite: false
                });
            };

            const getStats = (filterFn) => {
                const subset = items.filter(filterFn);
                const s = {
                    count: subset.length,
                    time: 0, 
                    ratingSum: 0,
                    ratedCount: 0,
                    status: { completed:0, watching:0, planned:0, dropped:0, rewatch:0 },
                    ratingDist: [0,0,0,0,0],
                    hypeSum: 0,
                    movies: { count:0, time:0 },
                    series: { count:0, time:0, eps:0 },
                    anime: { count:0, time:0, eps:0 },
                    books: { count:0, time:0, pages:0 },
                    manga: { count:0, time:0, chapters:0 },
                    music: { count:0, time:0 },
                    games: { count:0, time:0 },
                    genres: {},
                    recentLogs: []
                };

                const sorted = [...subset].sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                s.recentLogs = sorted.slice(0, 5);

                const currentMonthKey = `${new Date().getFullYear()}-${new Date().getMonth()+1}`;
                s.monthCount = subset.filter(i => i.monthKey === currentMonthKey).length;

                subset.forEach(i => {
                    const t = i.timeSpent || 0;
                    s.time += t;
                    
                    if(i.rating > 0 && i.rating <= 5) { 
                        s.ratingSum += i.rating; 
                        s.ratedCount++;
                        s.ratingDist[i.rating - 1]++;
                    }
                    s.hypeSum += (i.hypeScore || 0);
                    
                    const st = i.status || 'completed';
                    s.status[st] = (s.status[st] || 0) + 1;

                    if(i.genres) i.genres.forEach(g => s.genres[g] = (s.genres[g] || 0) + 1);

                    const vol = i.status === 'completed' ? (i.total || i.progress) : i.progress;
                    
                    if(i.type === 'movie') { s.movies.count++; s.movies.time += t; }
                    if(i.type === 'series') { s.series.count++; s.series.time += t; s.series.eps += (parseInt(vol)||0); }
                    if(i.type === 'anime') { s.anime.count++; s.anime.time += t; s.anime.eps += (parseInt(vol)||0); }
                    if(i.type === 'book') { s.books.count++; s.books.time += t; s.books.pages += (parseInt(vol)||0); }
                    if(['manga','manhwa','manhua'].includes(i.type)) { s.manga.count++; s.manga.time += t; s.manga.chapters += (parseInt(vol)||0); }
                    if(i.type === 'music') { s.music.count++; s.music.time += t; }
                    if(i.type === 'game') { s.games.count++; s.games.time += t; }
                });

                s.avgRating = s.ratedCount ? (s.ratingSum / s.ratedCount).toFixed(1) : 0;
                s.avgHype = s.count ? Math.round(s.hypeSum / s.count) : 0;
                s.topGenres = Object.entries(s.genres).sort((a,b) => b[1] - a[1]).slice(0, 5);
                
                return s;
            };

            const globalStats = useMemo(() => getStats(() => true), [items]);
            const visualStats = useMemo(() => getStats(i => ['movie','series','anime'].includes(i.type)), [items]);
            const readStats = useMemo(() => getStats(i => ['book','manga','manhwa','manhua'].includes(i.type)), [items]);
            const audioStats = useMemo(() => getStats(i => i.type === 'music'), [items]);
            const gameStats = useMemo(() => getStats(i => i.type === 'game'), [items]);

            const filteredItems = useMemo(() => {
                let f = items;
                if (activeTab === 'visual') f = f.filter(i => ['movie','series','anime'].includes(i.type));
                else if (activeTab === 'reading') f = f.filter(i => ['book','manga','manhwa','manhua'].includes(i.type));
                else if (activeTab === 'audio') f = f.filter(i => i.type === 'music');
                else if (activeTab === 'gaming') f = f.filter(i => i.type === 'game');
                else if (activeTab === 'favorites') f = f.filter(i => i.favorite); 
                
                if (subTab !== 'all') {
                    if (subTab === 'history') return []; 
                    
                    if (activeTab === 'favorites') {
                        if (subTab === 'visual') f = f.filter(i => ['movie','series','anime'].includes(i.type));
                        if (subTab === 'reading') f = f.filter(i => ['book','manga','manhwa','manhua'].includes(i.type));
                        if (subTab === 'audio') f = f.filter(i => i.type === 'music');
                        if (subTab === 'gaming') f = f.filter(i => i.type === 'game');
                    } else if (activeTab === 'audio') {
                        if (subTab === 'collection') f = f.filter(i => i.type === 'music');
                    } else {
                        f = f.filter(i => i.type === subTab);
                    }
                }
                return f.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            }, [items, activeTab, subTab]);

            if (loading) return <div className="min-h-screen bg-[#050505] flex items-center justify-center text-cyan-500 font-mono text-xs tracking-[0.2em] animate-pulse">CARGANDO MATRIZ DE DATOS...</div>;

            return (
                <div className="min-h-screen bg-[#050505] text-gray-200 font-sans pb-24 md:pb-0 overflow-x-hidden selection:bg-cyan-500/30">
                
                <div className="fixed inset-0 pointer-events-none z-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#0a0a0a] via-[#050505] to-black" />
                
                {globalAuthError && (
                    <div className="fixed top-0 left-0 w-full z-[200] bg-red-600/90 text-white text-xs p-2 text-center font-bold flex items-center justify-center gap-2">
                        <AlertTriangle className="w-4 h-4"/> {globalAuthError}
                    </div>
                )}

                <div className="relative z-10 max-w-7xl mx-auto flex flex-col md:flex-row h-screen">
                    
                    <aside className="hidden md:flex flex-col w-64 border-r border-white/5 bg-black/40 backdrop-blur-xl h-full p-6 justify-between shrink-0">
                        <div>
                            <div className="flex items-center gap-3 mb-8 cursor-pointer hover:bg-white/5 p-2 rounded-lg transition" onClick={() => setShowProfileEdit(true)}>
                                <div className="w-10 h-10 rounded-full overflow-hidden border border-white/10 bg-white/5">
                                    {config.avatarUrl ? <img src={config.avatarUrl} className="w-full h-full object-cover" /> : <User className="w-6 h-6 m-2 text-gray-500" />}
                                </div>
                                <div>
                                    <h1 className="font-bold font-mono text-cyan-400 tracking-wider">CHRONICLE</h1>
                                    <div className="text-[10px] text-gray-500 truncate max-w-[100px]">{config.username || 'Usuario'}</div>
                                    <div className="text-[9px] text-gray-600 truncate">{user?.isAnonymous ? 'Modo Local' : 'Online'}</div>
                                </div>
                            </div>
                            
                            <nav className="space-y-1">
                                <NavBtn active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutGrid />} label="Dashboard" />
                                <NavBtn active={activeTab === 'favorites'} onClick={() => {setActiveTab('favorites'); setSubTab('all')}} icon={<Heart />} label="Favoritos" />
                                <div className="h-px bg-white/5 my-4 mx-2" />
                                <NavBtn active={activeTab === 'visual'} onClick={() => {setActiveTab('visual'); setSubTab('all')}} icon={<Film />} label="Visual" />
                                <NavBtn active={activeTab === 'reading'} onClick={() => {setActiveTab('reading'); setSubTab('all')}} icon={<Book />} label="Lectura" />
                                <NavBtn active={activeTab === 'audio'} onClick={() => {setActiveTab('audio'); setSubTab('collection')}} icon={<Disc />} label="Audio" />
                                <NavBtn active={activeTab === 'gaming'} onClick={() => {setActiveTab('gaming'); setSubTab('all')}} icon={<Gamepad2 />} label="Juegos" />
                            </nav>
                        </div>
                        <div className="space-y-3">
                                <button onClick={() => {setFormMode('search'); setIsModalOpen(true)}} className="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg text-xs uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg shadow-cyan-900/20">
                                <Plus className="w-4 h-4" /> Registrar
                                </button>
                                <button onClick={() => setShowSettings(true)} className="w-full py-2 bg-white/5 hover:bg-white/10 border border-white/5 rounded-lg text-xs flex items-center justify-center gap-2 text-gray-400 hover:text-white">
                                <Settings className="w-3 h-3" /> Ajustes
                                </button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                        
                        <div className="md:hidden flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2" onClick={() => setShowProfileEdit(true)}>
                                <div className="w-8 h-8 rounded-full overflow-hidden bg-white/10">
                                    {config.avatarUrl ? <img src={config.avatarUrl} className="w-full h-full object-cover" /> : <User className="w-5 h-5 m-1.5 text-gray-500" />}
                                </div>
                                <span className="font-bold font-mono text-cyan-400">CHRONICLE</span>
                            </div>
                            <button onClick={() => setShowSettings(true)}><Settings className="w-5 h-5 text-gray-500" /></button>
                        </div>

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in">
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="md:col-span-2 relative h-64 rounded-2xl overflow-hidden group border border-white/10">
                                        {lastFmStats && lastFmStats.currentTrack ? (
                                            <>
                                                <div className="absolute inset-0 bg-cover bg-center opacity-30 blur-xl scale-110" style={{backgroundImage: `url(${lastFmStats.currentTrack.image[3]['#text']})`}}></div>
                                                <div className="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-transparent"></div>
                                                
                                                <div className="relative z-10 p-8 h-full flex flex-col justify-center">
                                                    <div className="flex items-center gap-2 text-red-400 font-bold text-xs uppercase tracking-[0.2em] mb-4">
                                                        {lastFmStats.isNowPlaying ? (
                                                            <span className="flex items-center gap-2"><Activity className="w-4 h-4 animate-pulse"/> ESCUCHANDO AHORA</span>
                                                        ) : (
                                                            <span className="flex items-center gap-2"><Disc className="w-4 h-4"/> ÚLTIMA REPRODUCCIÓN</span>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex items-center gap-6">
                                                        <div className="w-24 h-24 rounded-lg overflow-hidden shadow-2xl border border-white/10 shrink-0">
                                                            <img src={lastFmStats.currentTrack.image[3]['#text']} className="w-full h-full object-cover" />
                                                        </div>
                                                        <div className="min-w-0">
                                                            <h2 className="text-2xl md:text-3xl font-bold text-white truncate leading-tight mb-1">{lastFmStats.currentTrack.name}</h2>
                                                            <div className="text-lg text-gray-400 truncate">{lastFmStats.currentTrack.artist['#text']}</div>
                                                            <div className="text-sm text-gray-600 truncate mt-1">{lastFmStats.currentTrack.album['#text']}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <Disc className="absolute -right-12 -bottom-12 w-64 h-64 text-white/5 animate-spin-slow" />
                                            </>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center bg-[#121214] text-gray-500">
                                                <Music className="w-12 h-12 mb-2 opacity-20"/>
                                                <span className="text-xs">Conecta Last.fm en Ajustes</span>
                                            </div>
                                        )}
                                    </div>

                                    <div className="glass-panel rounded-2xl p-5 flex flex-col justify-between relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-4 opacity-10"><Music className="w-16 h-16"/></div>
                                        <div>
                                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Insights Semanales</h3>
                                            {lastFmStats ? (
                                                <div className="space-y-4 relative z-10">
                                                    <div>
                                                        <div className="text-[10px] text-gray-500 uppercase mb-1">Top Artista</div>
                                                        <div className="font-bold text-white text-lg truncate">{lastFmStats.topArtists[0]?.name || '-'}</div>
                                                        <div className="text-xs text-red-400 font-mono">{lastFmStats.topArtists[0]?.playcount || 0} plays</div>
                                                    </div>
                                                    <div className="h-px bg-white/5 w-full"></div>
                                                    <div>
                                                        <div className="text-[10px] text-gray-500 uppercase mb-1">Promedio Diario</div>
                                                        <div className="font-bold text-white text-2xl font-mono">{lastFmStats.avgDaily}</div>
                                                        <div className="text-[9px] text-gray-600">Scrobbles / día</div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-xs text-gray-600">Sin datos</div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <StatCard icon={<Clock className="text-cyan-400"/>} label="Tiempo Total" val={`${Math.floor(globalStats.time / 60)}h`} sub="Vida Invertida" />
                                    <StatCard icon={<CheckCircle className="text-green-400"/>} label="Completados" val={globalStats.status.completed} sub="Items Terminados" />
                                    <StatCard icon={<Activity className="text-purple-400"/>} label="Mainstream" val={`${globalStats.avgHype}%`} sub="Popularidad Global" />
                                    <StatCard icon={<Database className="text-white"/>} label="Items" val={globalStats.count} sub="Archivo Total" />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="glass-panel rounded-2xl p-5 md:col-span-1">
                                        <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><PieChart className="w-3 h-3"/> Estado del Archivo</h3>
                                        <div className="space-y-4">
                                            <StatusRow label="Completado" val={globalStats.status.completed} color="bg-green-500" total={globalStats.count} />
                                            <StatusRow label="Viendo / Leyendo" val={globalStats.status.watching} color="bg-blue-500" total={globalStats.count} />
                                            <StatusRow label="Planeado" val={globalStats.status.planned} color="bg-gray-500" total={globalStats.count} />
                                            <StatusRow label="Abandonado" val={globalStats.status.dropped} color="bg-red-500" total={globalStats.count} />
                                            <StatusRow label="Rewatch" val={globalStats.status.rewatch} color="bg-purple-500" total={globalStats.count} />
                                        </div>
                                    </div>

                                    <TopTagsBox title="Top Global" tags={globalStats.topGenres} />

                                    <div className="glass-panel rounded-2xl p-5 md:col-span-1 flex flex-col justify-end">
                                        <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><BarChart3 className="w-3 h-3" /> Distribución</h3>
                                        <div className="flex items-end justify-between h-32 gap-2 px-2 border-b border-white/5 pb-2">
                                            {globalStats.ratingDist.map((count, i) => {
                                                const max = Math.max(...globalStats.ratingDist, 1);
                                                const height = max > 0 ? (count / max) * 100 : 0;
                                                return (
                                                    <div key={i} className="flex-1 flex flex-col justify-end items-center gap-1 group h-full">
                                                        <div className="w-full bg-cyan-900/20 rounded-t hover:bg-cyan-500/40 transition-all relative flex flex-col justify-end" style={{height: `${Math.max(height, 5)}%`}}>
                                                            <div className="text-[9px] text-white text-center opacity-0 group-hover:opacity-100 mb-1">{count}</div>
                                                            <div className={`w-full ${height > 0 ? 'bg-cyan-500/50' : 'bg-transparent'} h-full rounded-t`}></div>
                                                        </div>
                                                        <div className="text-[10px] text-gray-500 font-bold">{i+1}★</div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-panel rounded-2xl p-5">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2"><List className="w-3 h-3"/> Actividad Reciente</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {globalStats.recentLogs.map(item => (
                                            <div key={item.id} className="flex items-center gap-3 bg-white/5 p-2 rounded-lg border border-white/5">
                                                <div className={`w-8 h-8 rounded shrink-0 ${getTypeColor(item.type)} opacity-20 flex items-center justify-center`}>
                                                    {item.type === 'movie' && <Film className="w-4 h-4 text-white"/>}
                                                    {item.type === 'book' && <Book className="w-4 h-4 text-white"/>}
                                                    {item.type === 'game' && <Gamepad2 className="w-4 h-4 text-white"/>}
                                                    {item.type === 'music' && <Music className="w-4 h-4 text-white"/>}
                                                </div>
                                                <div className="min-w-0 flex-1">
                                                    <div className="text-xs font-bold text-white truncate">{item.title}</div>
                                                    <div className="text-[9px] text-gray-500">{item.dateString}</div>
                                                </div>
                                                <div className="text-yellow-500 text-[10px] font-mono">{item.rating}★</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {(activeTab === 'visual' || activeTab === 'reading' || activeTab === 'gaming') && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {activeTab === 'visual' && (
                                        <>
                                            <DetailStatBox title="Cine" val={visualStats.movies.count} sub={`${Math.floor(visualStats.movies.time/60)} horas`} icon={<Film className="text-blue-400"/>} />
                                            <DetailStatBox title="Series & Anime" val={visualStats.series.count + visualStats.anime.count} sub={`${visualStats.series.eps + visualStats.anime.eps} episodios`} icon={<Tv className="text-purple-400"/>} />
                                            <div className="md:row-span-2"><TopTagsBox title="Top Visual" tags={visualStats.topGenres} /></div>
                                        </>
                                    )}
                                    {activeTab === 'reading' && (
                                        <>
                                            <DetailStatBox title="Libros" val={readStats.books.count} sub={`${readStats.books.pages.toLocaleString()} págs`} icon={<Book className="text-orange-400"/>} />
                                            <DetailStatBox title="Manga" val={readStats.manga.count} sub={`${readStats.manga.chapters} caps`} icon={<Layers className="text-pink-400"/>} />
                                            <div className="md:row-span-2"><TopTagsBox title="Top Lectura" tags={readStats.topGenres} /></div>
                                        </>
                                    )}
                                    {activeTab === 'gaming' && (
                                        <>
                                            <DetailStatBox title="Biblioteca" val={gameStats.games.count} sub="Títulos" icon={<Gamepad2 className="text-green-400"/>} />
                                            <DetailStatBox title="Tiempo Jugado" val={`${Math.floor(gameStats.games.time/60)}h`} sub="Estimado" icon={<Clock className="text-green-400"/>} />
                                            <div className="md:row-span-2"><TopTagsBox title="Top Gaming" tags={gameStats.topGenres} /></div>
                                        </>
                                    )}
                                </div>

                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar border-b border-white/5">
                                    <FilterBtn label="Todo" active={subTab === 'all'} onClick={() => setSubTab('all')} />
                                    {activeTab === 'visual' && ['movie', 'series', 'anime'].map(t => (
                                        <FilterBtn key={t} label={t.toUpperCase()} active={subTab === t} onClick={() => setSubTab(t)} />
                                    ))}
                                    {activeTab === 'reading' && ['book', 'manga', 'manhwa', 'manhua'].map(t => (
                                        <FilterBtn key={t} label={t.toUpperCase()} active={subTab === t} onClick={() => setSubTab(t)} />
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {filteredItems.map(item => (
                                        <div key={item.id} className="group bg-[#121214] border border-white/5 hover:border-cyan-500/30 rounded-xl overflow-hidden hover:shadow-2xl transition-all relative flex h-36">
                                            <div className="w-24 bg-black relative shrink-0">
                                                {item.image ? <img src={item.image} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition" /> : <div className="w-full h-full flex items-center justify-center bg-white/5 text-[9px]">NO IMG</div>}
                                                <div className={`absolute top-0 left-0 bottom-0 w-1 ${getTypeColor(item.type)}`}></div>
                                                <div className="absolute top-1 right-1 text-[8px] bg-black/80 px-1 rounded text-white font-bold">{item.year}</div>
                                            </div>

                                            <div className="flex-1 p-3 flex flex-col justify-between min-w-0">
                                                <div>
                                                    <div className="flex justify-between items-start mb-1">
                                                        <span className={`text-[8px] font-bold uppercase border px-1 rounded ${item.status === 'completed' ? 'border-green-500/50 text-green-400' : 'border-gray-500/50 text-gray-400'}`}>{item.type}</span>
                                                        <div className="flex text-yellow-500 gap-0.5">{[...Array(item.rating)].map((_,i)=><Star key={i} className="w-2 h-2 fill-current"/>)}</div>
                                                    </div>
                                                    <h3 className="font-bold text-sm text-white leading-tight truncate">{item.title}</h3>
                                                    <div className="text-[10px] text-gray-500 truncate mt-0.5">{item.author}</div>
                                                </div>
                                                
                                                <div className="flex justify-between items-end mt-1 pt-1 border-t border-white/5">
                                                    <div className="text-[9px] text-gray-600 font-mono">
                                                        {item.status === 'completed' ? item.total : `${item.progress}/${item.total}`} {getVolLabel(item.type)}
                                                        {item.type === 'anime' && (
                                                            <span className="ml-1 text-gray-500">
                                                                (≈{Math.round((item.total * (item.pace || 23))/60)}h)
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                                        <button onClick={() => toggleFavorite(item)} className={`${item.favorite ? 'text-red-500 fill-current' : 'text-gray-500 hover:text-white'}`}><Heart className="w-3 h-3" /></button>
                                                        <button onClick={() => {setFormData(item); setFormMode('edit'); setIsModalOpen(true)}} className="text-gray-500 hover:text-white"><Edit2 className="w-3 h-3"/></button>
                                                        <button onClick={() => deleteItem(item.id)} className="text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3"/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'audio' && (
                            <div className="space-y-8 animate-in fade-in">
                                
                                <div>
                                    <h2 className="text-sm font-bold text-white uppercase tracking-widest mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
                                        <Activity className="w-4 h-4 text-red-500"/> Last.fm Stats & Activity
                                    </h2>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <StatCard icon={<Music className="text-red-400"/>} label="Scrobbles" val={lastFmStats ? lastFmStats.totalScrobbles.toLocaleString() : '---'} sub="Total Plays" />
                                        <StatCard icon={<Clock className="text-red-400"/>} label="Tiempo Total" val={lastFmStats ? lastFmStats.timeFormatted : '---'} sub="Escuchado (Est.)" />
                                        <StatCard icon={<TrendingUp className="text-red-400"/>} label="Promedio" val={lastFmStats ? lastFmStats.avgDaily : '---'} sub="Scrobbles / Día" />
                                        <StatCard icon={<Disc className="text-green-400"/>} label="Colección" val={audioStats.music.count} sub="Manual Items" />
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        
                                        <div className="space-y-4">
                                            {lastFmStats?.topArtists[0] && (
                                                <div className="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
                                                    <div className="absolute inset-0 bg-gradient-to-r from-red-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                                                    <div className="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-red-500 font-bold border border-white/10 shrink-0">#1</div>
                                                    <div className="min-w-0 z-10">
                                                        <div className="text-[10px] text-gray-500 uppercase tracking-widest">Top Artista Semanal</div>
                                                        <div className="font-bold text-white text-lg truncate">{lastFmStats.topArtists[0].name}</div>
                                                        <div className="text-xs text-red-400 font-mono">{lastFmStats.topArtists[0].playcount} plays</div>
                                                    </div>
                                                </div>
                                            )}
                                            {lastFmStats?.topAlbums[0] && (
                                                <div className="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
                                                    <div className="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                                                    <img src={lastFmStats.topAlbums[0].image[2]['#text']} className="w-16 h-16 rounded shadow-lg border border-white/10 shrink-0" />
                                                    <div className="min-w-0 z-10">
                                                        <div className="text-[10px] text-gray-500 uppercase tracking-widest">Top Álbum Semanal</div>
                                                        <div className="font-bold text-white text-lg truncate">{lastFmStats.topAlbums[0].name}</div>
                                                        <div className="text-xs text-gray-400 truncate">{lastFmStats.topAlbums[0].artist.name}</div>
                                                    </div>
                                                </div>
                                            )}
                                            {lastFmStats?.topTracks[0] && (
                                                <div className="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
                                                    <div className="absolute inset-0 bg-gradient-to-r from-green-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                                                    {lastFmStats.topTracks[0].image && lastFmStats.topTracks[0].image[2]['#text'] ? (
                                                        <img src={lastFmStats.topTracks[0].image[2]['#text']} className="w-16 h-16 rounded shadow-lg border border-white/10 shrink-0" />
                                                    ) : (
                                                        <div className="w-16 h-16 rounded bg-white/10 flex items-center justify-center border border-white/10 shrink-0"><Disc className="w-8 h-8 text-green-500"/></div>
                                                    )}
                                                    <div className="min-w-0 z-10">
                                                        <div className="text-[10px] text-gray-500 uppercase tracking-widest">Top Track Semanal</div>
                                                        <div className="font-bold text-white text-lg truncate">{lastFmStats.topTracks[0].name}</div>
                                                        <div className="text-xs text-gray-400 truncate">{lastFmStats.topTracks[0].artist.name}</div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="md:col-span-2 glass-panel rounded-2xl p-5">
                                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Historial Reciente</h3>
                                            <div className="space-y-2 h-64 overflow-y-auto custom-scrollbar pr-2">
                                                {lastFmStats?.recentTracks.map((track, i) => (
                                                    <div key={i} className="flex items-center gap-4 bg-white/5 p-2 rounded-lg border border-white/5 hover:bg-white/10 transition group">
                                                        <div className="relative w-10 h-10 shrink-0">
                                                            <img src={track.image[1]['#text']} className="w-full h-full rounded bg-black" />
                                                            {track['@attr']?.nowplaying && (
                                                                <div className="absolute -top-1 -right-1 bg-red-500 w-3 h-3 rounded-full border-2 border-[#121214] animate-pulse"></div>
                                                            )}
                                                        </div>
                                                        <div className="min-w-0 flex-1">
                                                            <div className={`text-sm font-bold truncate ${track['@attr']?.nowplaying ? 'text-red-400' : 'text-white'}`}>{track.name}</div>
                                                            <div className="text-xs text-gray-500 truncate">{track.artist['#text']}</div>
                                                        </div>
                                                        <div className="text-[10px] text-gray-600 opacity-0 group-hover:opacity-100 transition">
                                                            {track['@attr']?.nowplaying ? 'Escuchando' : ''}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h2 className="text-sm font-bold text-white uppercase tracking-widest mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
                                        <Database className="w-4 h-4 text-green-500"/> Colección Manual
                                    </h2>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                        {filteredItems.map(item => (
                                            <div key={item.id} className="group bg-[#121214] border border-white/5 hover:border-cyan-500/30 rounded-xl overflow-hidden hover:shadow-2xl transition-all relative flex h-32">
                                                <div className="w-24 bg-black relative shrink-0">
                                                    {item.image ? <img src={item.image} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition" /> : <div className="w-full h-full flex items-center justify-center bg-gray-800"><Disc className="w-8 h-8 text-gray-500 animate-spin-slow"/></div>}
                                                    <div className={`absolute top-0 left-0 bottom-0 w-1 ${getTypeColor(item.type)}`}></div>
                                                </div>

                                                <div className="flex-1 p-3 flex flex-col justify-between min-w-0">
                                                    <div>
                                                        <h3 className="font-bold text-sm text-white leading-tight truncate">{item.title}</h3>
                                                        <div className="text-[10px] text-gray-500 truncate mt-0.5">{item.author}</div>
                                                    </div>
                                                    <div className="flex justify-between items-end mt-1 pt-1 border-t border-white/5">
                                                        <div className="flex text-yellow-500 gap-0.5">{[...Array(item.rating)].map((_,i)=><Star key={i} className="w-2 h-2 fill-current"/>)}</div>
                                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                                            <button onClick={() => toggleFavorite(item)} className={`${item.favorite ? 'text-red-500 fill-current' : 'text-gray-500 hover:text-white'}`}><Heart className="w-3 h-3" /></button>
                                                            <button onClick={() => {setFormData(item); setFormMode('edit'); setIsModalOpen(true)}} className="text-gray-500 hover:text-white"><Edit2 className="w-3 h-3"/></button>
                                                            <button onClick={() => deleteItem(item.id)} className="text-gray-500 hover:text-red-500"><Trash2 className="w-3 h-3"/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {filteredItems.length === 0 && (
                                            <div className="col-span-full py-8 text-center border border-dashed border-white/10 rounded-xl text-gray-600 text-xs">
                                                Tu colección manual está vacía. Añade vinilos, CDs o descargas locales aquí.
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'favorites' && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar border-b border-white/5">
                                    <FilterBtn label="Todo" active={subTab === 'all'} onClick={() => setSubTab('all')} />
                                    <FilterBtn label="Visual" active={subTab === 'visual'} onClick={() => setSubTab('visual')} />
                                    <FilterBtn label="Lectura" active={subTab === 'reading'} onClick={() => setSubTab('reading')} />
                                    <FilterBtn label="Audio" active={subTab === 'audio'} onClick={() => setSubTab('audio')} />
                                    <FilterBtn label="Juegos" active={subTab === 'gaming'} onClick={() => setSubTab('gaming')} />
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {filteredItems.map(item => (
                                        <div key={item.id} className="group bg-[#121214] border border-red-500/20 hover:border-red-500/50 rounded-xl overflow-hidden hover:shadow-2xl transition-all relative flex h-36">
                                            <div className="w-24 bg-black relative shrink-0">
                                                {item.image ? <img src={item.image} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition" /> : <div className="w-full h-full flex items-center justify-center bg-white/5 text-[9px]">NO IMG</div>}
                                                <div className="absolute top-1 right-1 text-[8px] bg-black/80 px-1 rounded text-white font-bold">{item.year}</div>
                                            </div>
                                            <div className="flex-1 p-3 flex flex-col justify-between min-w-0">
                                                <div>
                                                    <div className="flex justify-between items-start mb-1">
                                                        <span className={`text-[8px] font-bold uppercase border px-1 rounded text-gray-400`}>{item.type}</span>
                                                        <Heart className="w-3 h-3 text-red-500 fill-current" />
                                                    </div>
                                                    <h3 className="font-bold text-sm text-white leading-tight truncate">{item.title}</h3>
                                                    <div className="text-[10px] text-gray-500 truncate mt-0.5">{item.author}</div>
                                                </div>
                                                <div className="flex justify-between items-end mt-2 pt-2 border-t border-white/5">
                                                    <div className="text-[9px] text-gray-600 font-mono">{item.status}</div>
                                                    <button onClick={() => toggleFavorite(item)} className="text-red-500 hover:text-white"><XCircle className="w-3 h-3" /></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                    </main>
                </div>

                <div className="md:hidden fixed bottom-0 left-0 right-0 bg-[#09090b]/95 backdrop-blur-xl border-t border-white/10 pb-safe z-50 px-4 py-2">
                    <div className="flex justify-around items-center">
                        <MobNav active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutGrid />} label="Dash" />
                        <MobNav active={activeTab === 'visual'} onClick={() => {setActiveTab('visual'); setSubTab('all')}} icon={<Film />} label="Ver" />
                        <button onClick={() => {setFormMode('search'); setIsModalOpen(true)}} className="bg-cyan-500 text-black p-4 rounded-full shadow-[0_0_20px_rgba(6,182,212,0.4)] -translate-y-6 active:scale-95 transition border-4 border-[#09090b]"><Plus className="w-6 h-6" /></button>
                        <MobNav active={activeTab === 'reading'} onClick={() => {setActiveTab('reading'); setSubTab('all')}} icon={<Book />} label="Leer" />
                        <MobNav active={activeTab === 'audio'} onClick={() => {setActiveTab('audio'); setSubTab('collection')}} icon={<Disc />} label="Oír" />
                    </div>
                </div>

                {isModalOpen && (
                    <Modal onClose={() => closeModal()}>
                        {formMode === 'search' && (
                            <div className="space-y-4">
                                <div className="flex gap-2 border-b border-white/10 pb-4 overflow-x-auto no-scrollbar">
                                    {['Todo', 'Visual', 'Lectura', 'Audio', 'Gaming'].map(t => (
                                        <button key={t} onClick={() => setSearchFilter(filterMap[t])} className={`text-xs px-3 py-1 rounded-full ${searchFilter === filterMap[t] ? 'bg-white text-black font-bold' : 'bg-white/10 text-gray-400'}`}>
                                            {t}
                                        </button>
                                    ))}
                                </div>

                                <form onSubmit={handleSearch} className="relative">
                                    <input autoFocus value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-black border border-white/20 rounded-xl pl-4 pr-12 py-3 text-white focus:border-cyan-500 outline-none text-sm font-mono placeholder-gray-700" placeholder="Buscar..." />
                                    <button className="absolute right-2 top-2 bg-white/10 hover:bg-white/20 text-white p-1.5 rounded-lg mt-0.5">{isSearching ? <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"/> : <Search className="w-4 h-4" />}</button>
                                </form>
                                
                                <div className="h-[400px] overflow-y-auto custom-scrollbar pr-2 space-y-2">
                                    {searchResults.map((res, i) => (
                                        <button key={i} onClick={() => selectItem(res)} className="w-full flex gap-3 bg-white/5 hover:bg-white/10 p-2 rounded-lg text-left group transition border-l-4 border-transparent hover:border-cyan-500 relative overflow-hidden">
                                            <div className={`absolute top-0 bottom-0 left-0 w-1 ${getTypeColor(res.type)}`} />
                                            
                                            <div className="w-16 h-20 bg-black shrink-0 overflow-hidden rounded relative ml-2">
                                                {res.image ? <img src={res.image} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-gray-800" />}
                                                <div className="absolute bottom-0 right-0 text-[8px] font-bold px-1 bg-black/80 text-white uppercase w-full text-center">{res.type.slice(0,3)}</div>
                                            </div>
                                            <div className="min-w-0 flex-1 py-1">
                                                <h4 className="font-bold text-white text-sm truncate group-hover:text-cyan-400">{res.title}</h4>
                                                <div className="text-[10px] text-gray-500 flex items-center gap-2 mt-1">
                                                    <span className="bg-white/10 px-1.5 py-0.5 rounded text-white font-bold uppercase text-[9px]">{res.source}</span>
                                                    <span>{res.year}</span>
                                                </div>
                                                <div className="text-[9px] text-gray-600 truncate mt-1">{res.meta}</div>
                                            </div>
                                        </button>
                                    ))}
                                    <button onClick={startManualEntry} className="w-full py-3 border border-dashed border-white/20 text-[10px] text-gray-500 hover:text-white rounded mt-4">
                                        Ingreso Manual (Cualquier Tipo)
                                    </button>
                                </div>
                            </div>
                        )}

                        {formMode === 'edit' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center border-b border-white/10 pb-2">
                                    <h3 className="text-xs font-mono text-white">Detalles</h3>
                                    <button 
                                        onClick={() => {
                                            setFormMode('search');
                                        }} 
                                        className="flex items-center gap-1 text-[10px] text-gray-500 hover:text-white bg-white/5 px-2 py-1 rounded"
                                    >
                                        <ArrowLeft className="w-3 h-3" /> Volver a Búsqueda
                                    </button>
                                </div>

                                <div className="flex gap-3 bg-black/30 p-2 rounded-lg border border-white/5">
                                    <div className="w-12 h-16 bg-white/5 rounded shrink-0 overflow-hidden relative group">
                                        {formData.image ? <img src={formData.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-xs text-gray-700">IMG</div>}
                                        <label className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition">
                                            <Upload className="w-4 h-4 text-white" />
                                            <input type="file" className="hidden" onChange={handleFileUpload} accept="image/*" />
                                        </label>
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="bg-transparent font-bold text-white text-base w-full outline-none border-b border-transparent focus:border-white/10" placeholder="Título" />
                                        <div className="flex items-center gap-2 mt-2">
                                            <input value={formData.year} onChange={e => setFormData({...formData, year: e.target.value})} className="bg-white/5 px-2 py-1 rounded w-12 text-center text-xs outline-none text-white border border-white/10" placeholder="Año" />
                                            <button onClick={() => setFormData({...formData, favorite: !formData.favorite})} className={`p-1.5 rounded ${formData.favorite ? 'text-red-500 bg-red-500/10' : 'text-gray-500 bg-white/5'}`}>
                                                <Heart className={`w-4 h-4 ${formData.favorite ? 'fill-current' : ''}`} />
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-2">Categoría</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {['movie','series','anime','book','manga','manhwa','manhua','music','game'].map(t => (
                                            <button 
                                                key={t} 
                                                onClick={() => setFormData({...formData, type: t})}
                                                className={`text-[9px] py-2 rounded font-bold uppercase transition border ${
                                                    formData.type === t 
                                                    ? 'bg-cyan-600 text-white border-cyan-500 shadow-lg shadow-cyan-900/50' 
                                                    : 'bg-black text-gray-400 border-white/10 hover:border-white/30'
                                                }`}
                                            >
                                                {t}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-1">
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block">Imagen URL (Opcional)</label>
                                    <input value={formData.image} onChange={e => setFormData({...formData, image: e.target.value})} className="w-full bg-black border border-white/20 rounded p-2 text-white text-xs outline-none focus:border-cyan-500" placeholder="https://..." />
                                </div>

                                <div className="space-y-1">
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block">Etiquetas (Enter para agregar)</label>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {formData.genres.map((tag, i) => (
                                            <span key={i} className="bg-white/10 px-2 py-1 rounded text-[10px] text-white flex items-center gap-1">
                                                {tag} <button onClick={() => removeTag(tag)}><X className="w-3 h-3 text-gray-400 hover:text-white"/></button>
                                            </span>
                                        ))}
                                    </div>
                                    <input 
                                        value={tagInput} 
                                        onChange={e => setTagInput(e.target.value)} 
                                        onKeyDown={addTag}
                                        className="w-full bg-black border border-white/20 rounded p-2 text-white text-xs outline-none focus:border-cyan-500" 
                                        placeholder="Ej: Terror, A24, Cyberpunk..." 
                                    />
                                </div>

                                <div className="bg-white/5 p-3 rounded-lg space-y-3">
                                     <div className="flex justify-between items-center">
                                         <label className="text-[9px] font-bold text-gray-500 uppercase">Estado</label>
                                         <select 
                                            value={formData.status} 
                                            onChange={e => {
                                                const st = e.target.value;
                                                setFormData({
                                                    ...formData, status: st, 
                                                    progress: st === 'completed' ? formData.total : formData.progress
                                                });
                                            }} 
                                            className="bg-black border border-white/20 rounded px-2 py-1 text-[10px] text-white outline-none"
                                         >
                                            <option value="completed">Completado</option>
                                            <option value="watching">En Progreso</option>
                                            <option value="planned">Planeado</option>
                                            <option value="dropped">Abandonado</option>
                                            <option value="rewatch">Rewatch</option>
                                         </select>
                                     </div>
                                     
                                     <div className="border-t border-white/10 pt-2">
                                         <div className="flex justify-between mb-2">
                                             <label className="text-[9px] font-bold text-cyan-500 uppercase flex items-center gap-1"><Timer className="w-3 h-3"/> Cálculo Tiempo</label>
                                             <div className="flex bg-black rounded p-0.5">
                                                 <button onClick={() => setFormData({...formData, timeCalcMode: 'auto'})} className={`text-[8px] px-2 py-0.5 rounded transition ${formData.timeCalcMode === 'auto' ? 'bg-cyan-600 text-white' : 'text-gray-500'}`}>AUTO</button>
                                                 <button onClick={() => setFormData({...formData, timeCalcMode: 'manual'})} className={`text-[8px] px-2 py-0.5 rounded transition ${formData.timeCalcMode === 'manual' ? 'bg-cyan-600 text-white' : 'text-gray-500'}`}>MANUAL</button>
                                             </div>
                                         </div>
                                         
                                         {formData.timeCalcMode === 'auto' ? (
                                             <div className="flex gap-2">
                                                 <div className="flex-1">
                                                     <label className="text-[8px] text-gray-500 block mb-1">{getVolLabel(formData.type)}</label>
                                                     <input type="number" value={formData.total} onChange={e => setFormData({...formData, total: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none" placeholder="Total" />
                                                 </div>
                                                 <div className="flex-1 text-right pt-4">
                                                     <span className="text-white font-mono text-xs">{calculateFinalTime(formData)} min</span>
                                                 </div>
                                                 {['book','manga','manhwa','series','anime'].includes(formData.type) && (
                                                     <div className="flex-1">
                                                         <label className="text-[8px] text-gray-500 block mb-1">Ritmo (Min/Un)</label>
                                                         <input type="number" value={formData.pace} onChange={e => setFormData({...formData, pace: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none" placeholder={['series','anime'].includes(formData.type) ? "23" : "1.5"} />
                                                     </div>
                                                 )}
                                             </div>
                                         ) : (
                                             <div>
                                                 <label className="text-[8px] text-gray-500 block mb-1">Tiempo Total (Minutos)</label>
                                                 <input type="number" value={formData.manualTime} onChange={e => setFormData({...formData, manualTime: e.target.value})} className="w-full bg-black border border-white/20 rounded p-1.5 text-white text-xs outline-none focus:border-cyan-500" placeholder="Ej: 120" />
                                             </div>
                                         )}
                                     </div>
                                </div>

                                 <div>
                                    <div className="flex justify-between mb-1">
                                        <label className="text-[9px] font-bold text-gray-500 uppercase">Nivel Mainstream (Manual)</label>
                                        <span className={`text-[9px] font-mono ${formData.isHypeAuto ? 'text-green-400' : 'text-cyan-400'}`}>{formData.hypeScore}% {formData.isHypeAuto ? '(Dato de Base de Datos)' : '(Ajuste Manual)'}</span>
                                    </div>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="100" 
                                        value={formData.hypeScore} 
                                        onChange={e => setFormData({...formData, hypeScore: parseInt(e.target.value), isHypeAuto: false})} 
                                        className="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500" 
                                    />
                                    <div className="flex justify-between text-[8px] text-gray-600 mt-1 uppercase">
                                        <span>Underground</span>
                                        <span>Global Hit</span>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">Rating</label>
                                    <div className="flex justify-between bg-black border border-white/20 rounded p-2.5">
                                        {[1,2,3,4,5].map(s => (
                                            <button key={s} onClick={() => setFormData({...formData, rating: s})}>
                                                <Star className={`w-5 h-5 ${formData.rating >= s ? 'text-yellow-400 fill-current' : 'text-gray-700'}`} />
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">Reseña Personal</label>
                                    <textarea value={formData.review} onChange={e => setFormData({...formData, review: e.target.value})} className="w-full bg-black border border-white/20 rounded p-3 text-white text-xs outline-none resize-none" rows={6} placeholder="Escribe tu opinión extensa..." />
                                </div>

                                <button onClick={saveEntry} className="w-full py-3 bg-white text-black font-bold rounded-lg text-xs uppercase tracking-widest hover:bg-gray-200">Guardar</button>
                            </div>
                        )}
                    </Modal>
                )}

                {showSettings && (
                    <Modal onClose={() => setShowSettings(false)}>
                        <div className="space-y-4">
                            <h3 className="text-xs font-mono text-white uppercase border-b border-white/10 pb-2">Perfil & Config</h3>
                            
                            <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                                <div className="text-white font-bold text-xs mb-3 flex items-center gap-2"><Save className="w-3 h-3 text-orange-500"/> Respaldo Manual (JSON)</div>
                                <div className="text-[10px] text-gray-500 mb-3">Guarda tus datos en un archivo local o impórtalos para restaurar o mover datos entre cuentas.</div>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={exportData} className="py-2 bg-black border border-white/10 hover:border-white/30 text-white rounded text-xs flex flex-col items-center gap-1">
                                        <Download className="w-4 h-4 text-cyan-400"/>
                                        <span>Exportar</span>
                                    </button>
                                    <label className="py-2 bg-black border border-white/10 hover:border-white/30 text-white rounded text-xs flex flex-col items-center gap-1 cursor-pointer">
                                        <FileJson className="w-4 h-4 text-green-400"/>
                                        <span>Importar</span>
                                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                                    </label>
                                </div>
                            </div>
                            
                            <div className="bg-white/5 p-3 rounded-lg">
                                <div className="text-white font-bold text-xs mb-2">Perfil Público</div>
                                <input value={config.username} onChange={e => setConfig({...config, username: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs mb-2" placeholder="Nombre de Usuario" />
                                <input value={config.avatarUrl} onChange={e => setConfig({...config, avatarUrl: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs" placeholder="URL Foto de Perfil" />
                            </div>

                            <div className="bg-white/5 p-3 rounded-lg">
                                <div className="text-cyan-400 font-bold text-xs mb-1">TMDB (Cine)</div>
                                <input type="password" value={config.tmdbKey} onChange={e => setConfig({...config, tmdbKey: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs" placeholder="API Key" />
                            </div>
                            
                            <div className="bg-white/5 p-3 rounded-lg">
                                <div className="text-red-400 font-bold text-xs mb-1">Last.fm (Música)</div>
                                <input value={config.lastfmUser} onChange={e => setConfig({...config, lastfmUser: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs mb-2" placeholder="Usuario" />
                                <input type="password" value={config.lastfmKey} onChange={e => setConfig({...config, lastfmKey: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs" placeholder="API Key" />
                            </div>

                            <div className="bg-white/5 p-3 rounded-lg">
                                <div className="text-green-400 font-bold text-xs mb-1">RAWG (Juegos)</div>
                                <input type="password" value={config.rawgKey} onChange={e => setConfig({...config, rawgKey: e.target.value})} className="w-full bg-black border border-white/10 rounded p-2 text-white text-xs" placeholder="API Key" />
                            </div>
                            
                            <button onClick={() => {setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), config); setShowSettings(false);}} className="w-full py-2 bg-cyan-600 text-white font-bold rounded text-xs">GUARDAR TODO</button>
                        </div>
                    </Modal>
                )}

                {showProfileEdit && (
                    <Modal onClose={() => setShowProfileEdit(false)}>
                        <div className="space-y-4">
                            <h3 className="text-xs font-mono text-white uppercase border-b border-white/10 pb-2">Editar Perfil</h3>
                            <div className="bg-white/5 p-4 rounded-lg text-center">
                                    <div className="w-20 h-20 rounded-full overflow-hidden border-2 border-cyan-500 mx-auto mb-4 bg-black">
                                        {config.avatarUrl ? <img src={config.avatarUrl} className="w-full h-full object-cover" /> : <User className="w-10 h-10 m-5 text-gray-500" />}
                                    </div>
                                    <input value={config.username} onChange={e => setConfig({...config, username: e.target.value})} className="w-full bg-black border border-white/10 rounded p-3 text-white text-center mb-2 font-bold" placeholder="Tu Nombre" />
                                    <input value={config.avatarUrl} onChange={e => setConfig({...config, avatarUrl: e.target.value})} className="w-full bg-black border border-white/10 rounded p-3 text-white text-xs text-center" placeholder="https://imagen.jpg" />
                            </div>
                            <button onClick={() => {setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), config); setShowProfileEdit(false);}} className="w-full py-3 bg-cyan-600 text-white font-bold rounded-lg text-xs uppercase">Guardar Perfil</button>
                        </div>
                    </Modal>
                )}
            </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChronicleAppV35 />);
    </script>
</body>
</html>
