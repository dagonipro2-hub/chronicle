<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicle v2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Maps para módulos -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0?dev",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?dev",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?dev"
      }
    }
    </script>

    <style>
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Glass Utilities */
        .glass-panel {
            background: rgba(20, 20, 24, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-solid {
             background: rgba(9, 9, 11, 0.95);
             backdrop-filter: blur(20px);
             border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="bg-[#09090b] text-gray-200 selection:bg-indigo-500/30">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useReducer, createContext, useContext, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          BookOpen, Clapperboard, Gamepad2, Headphones, Tv, Ghost,
          Search, Plus, Settings, X, Save, Share2, User, Edit3,
          BarChart2, Calendar, LayoutGrid, List, RefreshCw, 
          Dice5, Trophy, ChevronRight, Activity, Command, Globe,
          Music, ExternalLink, Image as ImageIcon, Download, Upload, AlertCircle,
          Clock, CheckCircle2, Bookmark, Eye, XCircle, RotateCcw,
          Library, Smartphone, Hash, Star, Heart, MonitorPlay, Zap, Quote
        } from 'lucide-react';

        /**
         * ==========================================
         * UTILITIES & CONFIG
         * ==========================================
         */

        const GROUPS = {
            VISUAL: { id: 'visual', label: 'Visual', icon: MonitorPlay },
            READING: { id: 'reading', label: 'Lectura', icon: BookOpen },
            AUDIO: { id: 'audio', label: 'Audio', icon: Headphones },
            GAME: { id: 'game_group', label: 'Juegos', icon: Gamepad2 }
        };

        const CATEGORIES = {
          MOVIE: { id: 'movie', groupId: 'visual', label: 'Película', icon: Clapperboard, color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' },
          TV: { id: 'tv', groupId: 'visual', label: 'Serie', icon: Tv, color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' },
          ANIME: { id: 'anime', groupId: 'visual', label: 'Anime', icon: Ghost, color: 'text-pink-400', bg: 'bg-pink-500/10', border: 'border-pink-500/20' },
          
          BOOK: { id: 'book', groupId: 'reading', label: 'Libro', icon: BookOpen, color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20' },
          MANGA: { id: 'manga', groupId: 'reading', label: 'Manga', icon: BookOpen, color: 'text-orange-400', bg: 'bg-orange-500/10', border: 'border-orange-500/20' },
          MANHWA: { id: 'manhwa', groupId: 'reading', label: 'Manhwa', icon: Smartphone, color: 'text-green-400', bg: 'bg-green-500/10', border: 'border-green-500/20' },
          MANHUA: { id: 'manhua', groupId: 'reading', label: 'Manhua', icon: Library, color: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'border-cyan-500/20' },
          
          GAME: { id: 'game', groupId: 'game_group', label: 'Juego', icon: Gamepad2, color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' },
          
          MUSIC: { id: 'music', groupId: 'audio', label: 'Música', icon: Headphones, color: 'text-rose-400', bg: 'bg-rose-500/10', border: 'border-rose-500/20' },
        };

        const STATUSES = {
            COMPLETED: { id: 'completed', label: 'Completado', icon: CheckCircle2, color: 'text-emerald-500' },
            WATCHING: { id: 'watching', label: 'En Progreso', icon: Eye, color: 'text-blue-500' },
            PLANNED: { id: 'planned', label: 'Planeado', icon: Bookmark, color: 'text-gray-400' },
            DROPPED: { id: 'dropped', label: 'Abandonado', icon: XCircle, color: 'text-red-500' },
            REWATCH: { id: 'rewatch', label: 'Rewatch', icon: RotateCcw, color: 'text-purple-500' }
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
        const formatDuration = (minutes) => {
            if (!minutes) return '0m';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return h === 0 ? `${m}m` : `${h}h ${m}m`;
        };

        /**
         * ==========================================
         * API SERVICE
         * ==========================================
         */
        const APIService = {
            searchTMDB: async (query, type, apiKey) => {
                if (!apiKey) return [];
                const endpoint = type === 'movie' ? 'movie' : 'tv';
                try {
                    const res = await fetch(`https://api.themoviedb.org/3/search/${endpoint}?api_key=${apiKey}&query=${encodeURIComponent(query)}&language=es-ES`);
                    const data = await res.json();
                    return data.results ? data.results.slice(0, 5).map(item => ({
                        id: item.id,
                        title: item.title || item.name,
                        year: (item.release_date || item.first_air_date || '').split('-')[0],
                        poster: item.poster_path ? `https://image.tmdb.org/t/p/w200${item.poster_path}` : null,
                        rating: item.vote_average * 10,
                        mainstreamScore: Math.round(item.popularity > 100 ? 100 : item.popularity),
                        overview: item.overview,
                        source: 'TMDB'
                    })) : [];
                } catch(e) { return []; }
            },
            searchRAWG: async (query, apiKey) => {
                if (!apiKey) return [];
                try {
                    const res = await fetch(`https://api.rawg.io/api/games?key=${apiKey}&search=${encodeURIComponent(query)}&page_size=5`);
                    const data = await res.json();
                    return data.results ? data.results.map(item => ({
                        id: item.id,
                        title: item.name,
                        year: (item.released || '').split('-')[0],
                        poster: item.background_image,
                        rating: item.metacritic,
                        mainstreamScore: item.rating ? item.rating * 20 : 0, // RAWG Rating is 1-5
                        genres: item.genres.map(g => g.name).join(', '),
                        source: 'RAWG'
                    })) : [];
                } catch(e) { return []; }
            },
            searchBooks: async (query) => {
                try {
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5`);
                    const data = await res.json();
                    return (data.items || []).map(item => ({
                        id: item.id,
                        title: item.volumeInfo.title,
                        year: (item.volumeInfo.publishedDate || '').split('-')[0],
                        poster: item.volumeInfo.imageLinks?.thumbnail,
                        author: item.volumeInfo.authors?.join(', '),
                        rating: item.volumeInfo.averageRating ? item.volumeInfo.averageRating * 20 : 0,
                        mainstreamScore: item.volumeInfo.ratingsCount ? Math.min(item.volumeInfo.ratingsCount / 10, 100) : 0,
                        source: 'Google Books'
                    }));
                } catch(e) { return []; }
            },
            // Handles Anime, Manga, Manhwa, Manhua via Jikan
            searchJikan: async (query, type = 'anime') => {
                try {
                    await new Promise(r => setTimeout(r, 600)); // Rate limit
                    const res = await fetch(`https://api.jikan.moe/v4/${type}?q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    return (data.data || []).map(item => ({
                        id: item.mal_id,
                        title: item.title,
                        year: item.year || (item.aired?.from ? item.aired.from.split('-')[0] : (item.published?.from ? item.published.from.split('-')[0] : '')),
                        poster: item.images?.jpg?.large_image_url,
                        rating: item.score ? item.score * 10 : 0,
                        mainstreamScore: item.members ? Math.min((item.members / 50000) * 100, 100) : 0,
                        overview: item.synopsis,
                        source: 'MyAnimeList'
                    }));
                } catch(e) { return []; }
            },
            getLastFmUser: async (user, apiKey) => {
                 if (!user || !apiKey) return null;
                 try {
                     const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${user}&api_key=${apiKey}&format=json&limit=1`);
                     const data = await res.json();
                     const resTop = await fetch(`https://ws.audioscrobbler.com/2.0/?method=user.gettopartists&user=${user}&api_key=${apiKey}&format=json&limit=5&period=7day`);
                     const dataTop = await resTop.json();
                     const track = data.recenttracks?.track?.[0];
                     const isPlaying = track ? (track['@attr']?.nowplaying === 'true') : false;
                     return {
                         recent: track ? { name: track.name, artist: track.artist['#text'], album: track.album['#text'], image: track.image[2]['#text'], isPlaying } : null,
                         topArtists: dataTop.topartists?.artist || []
                     };
                 } catch(e) { return null; }
            }
        };

        /**
         * ==========================================
         * STATE & CONTEXT
         * ==========================================
         */
        const AppContext = createContext();
        const initialState = {
          entries: [],
          settings: { tmdbKey: '', rawgKey: '', lastfmKey: '', lastfmUser: '' },
          profile: { name: 'Viajero', bio: 'Explorando mundos digitales.', avatar: '', banner: '' },
          ui: { modalOpen: false, settingsOpen: false, shareOpen: false, searchOpen: false, activeCategory: 'all', editingEntry: null, shareEntry: null }
        };

        const reducer = (state, action) => {
          switch (action.type) {
            case 'LOAD_DATA': return { ...state, entries: action.payload.entries || [], settings: { ...state.settings, ...action.payload.settings }, profile: { ...state.profile, ...(action.payload.profile || {}) } };
            case 'ADD_ENTRY': return { ...state, entries: [action.payload, ...state.entries] };
            case 'UPDATE_ENTRY': return { ...state, entries: state.entries.map(e => e.id === action.payload.id ? action.payload : e) };
            case 'DELETE_ENTRY': return { ...state, entries: state.entries.filter(e => e.id !== action.payload) };
            case 'UPDATE_SETTINGS': return { ...state, settings: { ...state.settings, ...action.payload } };
            case 'UPDATE_PROFILE': return { ...state, profile: { ...state.profile, ...action.payload } };
            case 'SET_UI': return { ...state, ui: { ...state.ui, ...action.payload } };
            default: return state;
          }
        };

        /**
         * ==========================================
         * COMPONENTS
         * ==========================================
         */
        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
          const variants = {
            primary: "bg-white/5 hover:bg-white/10 text-white border border-white/5 backdrop-blur-md",
            accent: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20 border border-transparent",
            ghost: "hover:bg-white/5 text-gray-400 hover:text-white border-transparent",
            danger: "bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20"
          };
          return (
            <button className={`px-4 py-2 rounded-xl font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 text-xs md:text-sm ${variants[variant]} ${className}`} onClick={onClick} {...props}>
              {children}
            </button>
          );
        };

        const Input = ({ label, className = '', ...props }) => (
          <div className="flex flex-col gap-1.5 w-full">
            {label && <label className="text-[10px] uppercase tracking-wider text-gray-500 font-bold ml-1">{label}</label>}
            <input className={`bg-black/40 border border-white/10 rounded-xl px-4 py-2.5 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50 transition-all w-full ${className}`} {...props} />
          </div>
        );

        // --- SHARE CARD MODAL ---
        const ShareModal = () => {
            const { state, dispatch } = useContext(AppContext);
            const entry = state.ui.shareEntry;
            if (!state.ui.shareOpen || !entry) return null;

            const cat = CATEGORIES[entry.category.toUpperCase()] || CATEGORIES.MOVIE;
            const status = Object.values(STATUSES).find(s => s.id === entry.status);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md" onClick={() => dispatch({type: 'SET_UI', payload: {shareOpen: false}})}>
                    <div className="bg-[#09090b] border border-white/10 p-1 rounded-3xl max-w-sm w-full shadow-2xl animate-in slide-up" onClick={e => e.stopPropagation()}>
                        <div className="bg-gradient-to-br from-indigo-950 to-black rounded-[20px] p-6 relative overflow-hidden flex flex-col items-center text-center">
                            {/* Decorative Blobs */}
                            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500/20 blur-3xl rounded-full"></div>
                            <div className="absolute bottom-0 left-0 w-32 h-32 bg-pink-500/20 blur-3xl rounded-full"></div>
                            
                            {/* Card Content */}
                            <div className="relative z-10 w-full flex flex-col items-center">
                                <div className="w-40 h-60 rounded-lg shadow-2xl mb-6 relative group overflow-hidden border-2 border-white/10">
                                    {entry.image ? <img src={entry.image} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-gray-800 flex items-center justify-center"><cat.icon size={40} /></div>}
                                </div>
                                
                                <h2 className="text-2xl font-black text-white leading-tight mb-1">{entry.title}</h2>
                                <p className="text-gray-400 text-sm mb-4">{cat.label} • {entry.date ? new Date(entry.date).getFullYear() : 'Unknown'}</p>
                                
                                <div className="flex gap-2 mb-6">
                                     <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-white/10 border border-white/5`}>{status?.label}</span>
                                     {entry.rating > 0 && <span className="px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">{entry.rating}/100</span>}
                                </div>

                                {entry.review && (
                                    <div className="bg-white/5 p-4 rounded-xl text-sm italic text-gray-300 w-full relative mb-4">
                                        <Quote size={16} className="absolute top-2 left-2 text-indigo-500/50" />
                                        "{entry.review}"
                                    </div>
                                )}

                                <div className="flex justify-between w-full items-end border-t border-white/10 pt-4 mt-2">
                                    <div className="text-left">
                                        <div className="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Chronicle v2</div>
                                        <div className="text-xs text-gray-300">@{state.profile.name}</div>
                                    </div>
                                    <div className="text-right">
                                         <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400">{entry.rating >= 90 ? 'MASTERPIECE' : entry.rating >= 70 ? 'GREAT' : 'GOOD'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 flex justify-center text-xs text-gray-500">
                            Toma una captura de pantalla para compartir
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD WIDGETS ---
        const StatCard = ({ label, value, sub, icon: Icon, color, className }) => (
            <div className={`glass-panel p-5 rounded-2xl flex flex-col justify-between h-full ${className}`}>
                <div className="flex justify-between items-start mb-4">
                    <div className={`p-2.5 rounded-xl ${color.replace('text-', 'bg-')}/10 ${color}`}><Icon size={20} /></div>
                    {sub && <span className="text-[10px] font-bold uppercase tracking-wider text-gray-500 bg-white/5 px-2 py-1 rounded-md">{sub}</span>}
                </div>
                <div><h3 className="text-2xl font-bold text-white tracking-tight">{value}</h3><p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">{label}</p></div>
            </div>
        );

        const RecentlyAdded = ({ entries, dispatch }) => (
            <div className="mb-8">
                <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4 flex items-center gap-2"><Zap size={14} className="text-yellow-400"/> Añadido Recientemente</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    {entries.slice(0, 6).map(e => (
                        <div key={e.id} className="group relative aspect-[2/3] rounded-xl overflow-hidden cursor-pointer" onClick={() => dispatch({ type: 'SET_UI', payload: { editingEntry: e, modalOpen: true } })}>
                            {e.image ? <img src={e.image} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" /> : <div className="w-full h-full bg-white/5 flex items-center justify-center"><Ghost/></div>}
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-3">
                                <span className="text-xs font-bold text-white line-clamp-2">{e.title}</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const MusicStats = ({ entries, user, apiKey }) => {
            const [fmData, setFmData] = useState(null);
            useEffect(() => { APIService.getLastFmUser(user, apiKey).then(setFmData); }, [user]);
            const musicEntries = entries.filter(e => e.category === 'music');

            return (
                <div className="glass-panel p-6 rounded-2xl mb-8">
                     <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4 flex items-center gap-2"><Headphones size={14} className="text-rose-400"/> Estadísticas Musicales</h3>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div>
                             <div className="text-3xl font-black text-white mb-1">{musicEntries.length}</div>
                             <div className="text-xs text-gray-500 uppercase tracking-wide mb-6">Álbumes / Artistas Guardados</div>
                             {fmData?.recent && (
                                 <div className="bg-white/5 p-4 rounded-xl flex items-center gap-4">
                                     {fmData.recent.image ? <img src={fmData.recent.image} className="w-12 h-12 rounded-md" /> : <div className="w-12 h-12 bg-white/10 rounded-md"/>}
                                     <div>
                                         <div className="text-[10px] text-rose-400 font-bold uppercase">{fmData.recent.isPlaying ? 'Escuchando Ahora' : 'Última Canción'}</div>
                                         <div className="text-white font-bold text-sm line-clamp-1">{fmData.recent.name}</div>
                                         <div className="text-gray-400 text-xs">{fmData.recent.artist}</div>
                                     </div>
                                 </div>
                             )}
                         </div>
                         <div>
                             <h4 className="text-xs text-gray-500 font-bold uppercase mb-3">Top Artistas (Last.fm 7d)</h4>
                             <div className="space-y-2">
                                 {fmData?.topArtists.map((a, i) => (
                                     <div key={a.name} className="flex justify-between items-center text-sm">
                                         <span className="text-gray-300"><span className="text-gray-600 font-mono mr-2">0{i+1}</span> {a.name}</span>
                                         <span className="text-xs text-gray-500">{a.playcount} scrobbles</span>
                                     </div>
                                 ))}
                                 {!fmData && <div className="text-sm text-gray-600 italic">Configura Last.fm para ver datos</div>}
                             </div>
                         </div>
                     </div>
                </div>
            );
        };

        const DashboardView = ({ entries, profile, settings, dispatch }) => {
            const stats = useMemo(() => {
                const totalMins = entries.reduce((acc, cur) => acc + (cur.totalMinutes || 0), 0);
                const days = Math.floor(totalMins / (24 * 60));
                const ratedEntries = entries.filter(e => e.rating > 0);
                const avgRating = ratedEntries.length ? (ratedEntries.reduce((a, b) => a + b.rating, 0) / ratedEntries.length / 10).toFixed(1) : "0.0";
                return { days, avgRating, count: entries.length };
            }, [entries]);

            return (
                <div className="animate-in slide-up max-w-5xl mx-auto pb-20">
                    <div className="relative overflow-hidden rounded-3xl glass-panel p-8 mb-8 group">
                        <div className="absolute inset-0 z-0">{profile.banner ? <img src={profile.banner} className="w-full h-full object-cover opacity-30 group-hover:scale-105 transition-transform duration-700" /> : <div className="w-full h-full bg-gradient-to-br from-indigo-900/40 via-purple-900/40 to-black/80" />}<div className="absolute inset-0 bg-gradient-to-r from-[#09090b] via-[#09090b]/80 to-transparent"></div></div>
                        <div className="relative z-10 flex items-center gap-6">
                            <div className="w-20 h-20 rounded-full border-2 border-white/10 overflow-hidden shadow-2xl">{profile.avatar ? <img src={profile.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-indigo-500 flex items-center justify-center text-2xl font-bold">{profile.name[0]}</div>}</div>
                            <div><h1 className="text-3xl font-bold text-white mb-1">{profile.name}</h1><p className="text-gray-400 max-w-lg text-sm">{profile.bio}</p></div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <StatCard label="Tiempo" value={`${stats.days} Días`} icon={Clock} color="text-blue-400" />
                        <StatCard label="Total Items" value={stats.count} icon={CheckCircle2} color="text-emerald-400" />
                        <StatCard label="Promedio" value={stats.avgRating} icon={Star} color="text-yellow-400" />
                        <StatCard label="Favoritos" value={entries.filter(e=>e.favorite).length} icon={Heart} color="text-rose-400" />
                    </div>

                    <RecentlyAdded entries={entries} dispatch={dispatch} />
                    <MusicStats entries={entries} user={settings.lastfmUser} apiKey={settings.lastfmKey} />
                </div>
            );
        };

        // --- ENTRY MODAL ---
        const EntryModal = () => {
            const { state, dispatch } = useContext(AppContext);
            const entry = state.ui.editingEntry;
            const [form, setForm] = useState(entry || {});
            const [tagInput, setTagInput] = useState("");
            const [timeMode, setTimeMode] = useState('manual');
            const [mainstreamMode, setMainstreamMode] = useState('manual');
            const [eps, setEps] = useState(0);
            const [duration, setDuration] = useState(0);

            useEffect(() => { 
                if (entry) {
                    setForm(entry);
                    setEps(entry.episodes || 0);
                    setDuration(entry.durationPerEp || 0);
                }
            }, [entry]);

            useEffect(() => { if (timeMode === 'auto') setForm(f => ({ ...f, totalMinutes: eps * duration, episodes: eps, durationPerEp: duration })); }, [eps, duration, timeMode]);

            if (!state.ui.modalOpen || !entry) return null;

            const handleKeyDownTags = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!tagInput.trim()) return;
                    const newTags = [...(form.tags || []), tagInput.trim()];
                    setForm({ ...form, tags: newTags });
                    setTagInput("");
                }
            };
            const removeTag = (t) => setForm({ ...form, tags: form.tags.filter(tag => tag !== t) });
            
            const handleSave = () => {
                if (state.entries.some(e => e.id === form.id)) dispatch({ type: 'UPDATE_ENTRY', payload: form });
                else dispatch({ type: 'ADD_ENTRY', payload: form });
                dispatch({ type: 'SET_UI', payload: { modalOpen: false, editingEntry: null } });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md" onClick={() => dispatch({ type: 'SET_UI', payload: { modalOpen: false } })}>
                    <div className="relative w-full max-w-2xl bg-[#09090b] border border-white/10 rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-in slide-up" onClick={e=>e.stopPropagation()}>
                        <div className="h-32 bg-gray-900 relative">
                             {form.image ? <img src={form.image} className="w-full h-full object-cover opacity-40 blur-sm" /> : <div className="w-full h-full bg-indigo-900/20" />}
                             <div className="absolute inset-0 bg-gradient-to-t from-[#09090b] to-transparent" />
                             <div className="absolute bottom-0 left-0 p-6 w-full flex justify-between items-end">
                                 <h2 className="text-2xl font-bold text-white shadow-black drop-shadow-lg line-clamp-1 mr-4">{form.title || 'Nueva Entrada'}</h2>
                                 <div className="flex gap-2 shrink-0">
                                     <button onClick={() => setForm({...form, favorite: !form.favorite})} className={`p-2 rounded-xl border ${form.favorite ? 'bg-rose-500 text-white border-rose-500' : 'bg-black/40 text-gray-400 border-white/10'}`}><Heart size={16} fill={form.favorite ? "currentColor" : "none"} /></button>
                                     <Button variant="accent" onClick={handleSave} className="py-1 px-4 h-9">Guardar</Button>
                                 </div>
                             </div>
                        </div>

                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6">
                            <div className="flex gap-6">
                                <div className="w-32 flex-shrink-0 space-y-3">
                                    <div className="aspect-[2/3] bg-black/50 rounded-lg overflow-hidden border border-white/10 relative group">
                                        {form.image ? <img src={form.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-gray-700"><ImageIcon /></div>}
                                    </div>
                                    <Input placeholder="URL Img" value={form.image || ''} onChange={e => setForm({...form, image: e.target.value})} className="text-xs py-1.5 px-2" />
                                </div>
                                <div className="flex-1 space-y-4">
                                    <Input label="Título" value={form.title || ''} onChange={e => setForm({...form, title: e.target.value})} className="text-lg font-bold" />
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] uppercase text-gray-500 font-bold ml-1 mb-1 block">Categoría</label>
                                            <select className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-sm outline-none" value={form.category || 'movie'} onChange={e => setForm({...form, category: e.target.value})}>
                                                {Object.values(CATEGORIES).map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase text-gray-500 font-bold ml-1 mb-1 block">Estado</label>
                                            <select className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-sm outline-none" value={form.status || 'completed'} onChange={e => setForm({...form, status: e.target.value})}>
                                                {Object.values(STATUSES).map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Fecha" type="date" value={form.date || ''} onChange={e => setForm({...form, date: e.target.value})} />
                                        <div className="relative">
                                             <Input label={`Rating (${form.rating || 0})`} type="range" min="0" max="100" value={form.rating || 0} onChange={e => setForm({...form, rating: parseInt(e.target.value)})} />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr className="border-white/5" />

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="glass-panel p-4 rounded-xl">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-[10px] uppercase text-gray-500 font-bold">Tiempo</label>
                                        <div className="flex bg-black/40 rounded-lg p-0.5"><button onClick={() => setTimeMode('auto')} className={`px-2 py-0.5 text-[10px] rounded-md ${timeMode==='auto'?'bg-indigo-600':'text-gray-500'}`}>AUTO</button><button onClick={() => setTimeMode('manual')} className={`px-2 py-0.5 text-[10px] rounded-md ${timeMode==='manual'?'bg-indigo-600':'text-gray-500'}`}>MAN</button></div>
                                    </div>
                                    {timeMode === 'auto' ? (
                                        <div className="grid grid-cols-2 gap-3">
                                            <Input label="Eps" type="number" value={eps} onChange={e => setEps(parseInt(e.target.value) || 0)} />
                                            <Input label="Dur (min)" type="number" value={duration} onChange={e => setDuration(parseInt(e.target.value) || 0)} />
                                        </div>
                                    ) : (
                                        <Input label="Total Min" type="number" value={form.totalMinutes || 0} onChange={e => setForm({...form, totalMinutes: parseInt(e.target.value) || 0})} />
                                    )}
                                    <div className="text-right text-xs text-indigo-400 font-mono mt-2">{formatDuration(form.totalMinutes || 0)}</div>
                                </div>

                                <div className="glass-panel p-4 rounded-xl">
                                    <div className="flex justify-between items-center mb-3">
                                         <label className="text-[10px] uppercase text-gray-500 font-bold">Mainstream</label>
                                         <div className="flex bg-black/40 rounded-lg p-0.5"><button onClick={() => setMainstreamMode('auto')} className={`px-2 py-0.5 text-[10px] rounded-md ${mainstreamMode==='auto'?'bg-indigo-600':'text-gray-500'}`}>AUTO</button><button onClick={() => setMainstreamMode('manual')} className={`px-2 py-0.5 text-[10px] rounded-md ${mainstreamMode==='manual'?'bg-indigo-600':'text-gray-500'}`}>MAN</button></div>
                                    </div>
                                    {mainstreamMode === 'manual' ? (
                                        <input type="range" min="0" max="100" className="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" value={form.mainstreamScore || 0} onChange={e => setForm({...form, mainstreamScore: parseInt(e.target.value)})} />
                                    ) : (
                                        <div className="text-center py-2 text-xs text-gray-400">Puntuación: <span className="text-purple-400 font-bold text-lg">{form.mainstreamScore || 0}</span> (API)</div>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="text-[10px] uppercase text-gray-500 font-bold ml-1 mb-1 block">Etiquetas (Enter para añadir)</label>
                                    <div className="flex flex-wrap gap-2 mb-2 bg-black/40 border border-white/10 rounded-xl p-2 min-h-[46px]">
                                        {(form.tags || []).map(t => (
                                            <span key={t} className="bg-indigo-500/20 text-indigo-300 text-xs px-2 py-1 rounded-md flex items-center gap-1">
                                                {t} <button onClick={() => removeTag(t)} className="hover:text-white"><X size={10}/></button>
                                            </span>
                                        ))}
                                        <input className="bg-transparent text-sm text-white focus:outline-none flex-1 min-w-[100px]" placeholder={form.tags?.length ? "" : "Cyberpunk, Isekai..."} value={tagInput} onChange={e => setTagInput(e.target.value)} onKeyDown={handleKeyDownTags} />
                                    </div>
                                </div>
                                <Input label="Sinopsis" value={form.overview || ''} onChange={e => setForm({...form, overview: e.target.value})} />
                                <Input label="Reseña" value={form.review || ''} onChange={e => setForm({...form, review: e.target.value})} />
                                <Button variant="danger" className="w-full mt-4" onClick={() => { dispatch({ type: 'DELETE_ENTRY', payload: form.id }); dispatch({ type: 'SET_UI', payload: { modalOpen: false } }); }}>Eliminar Entrada</Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EntryCard = ({ entry, onClick, onShare }) => {
          const cat = CATEGORIES[entry.category.toUpperCase()] || CATEGORIES.MOVIE;
          const status = Object.values(STATUSES).find(s => s.id === entry.status) || STATUSES.COMPLETED;
          return (
            <div onClick={onClick} className="group relative bg-zinc-900/40 border border-white/5 hover:border-white/20 rounded-2xl overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-black/50 cursor-pointer flex flex-col h-full">
              <div className="aspect-[2/3] w-full bg-zinc-950 relative overflow-hidden">
                {entry.image ? <img src={entry.image} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-80 group-hover:opacity-100" /> : <div className={`w-full h-full flex items-center justify-center ${cat.bg}`}><cat.icon size={40} className={cat.color} /></div>}
                <div className="absolute top-2 right-2 flex flex-col items-end gap-1"><div className={`bg-black/60 backdrop-blur-md px-2 py-1 rounded-md border ${cat.border} ${cat.color} text-[10px] font-bold uppercase`}>{cat.label}</div><div className={`bg-black/80 backdrop-blur-md px-2 py-1 rounded-md text-[10px] font-bold uppercase ${status.color}`}>{status.label}</div></div>
                {entry.favorite && <div className="absolute top-2 left-2 text-rose-500 drop-shadow-md"><Heart size={18} fill="currentColor"/></div>}
                <button onClick={(e) => { e.stopPropagation(); onShare(entry); }} className="absolute bottom-2 right-2 p-2 bg-black/60 backdrop-blur-md rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-indigo-600"><Share2 size={14} /></button>
              </div>
              <div className="p-4 flex-1 flex flex-col">
                <div className="flex justify-between items-start mb-1"><h3 className="text-white font-bold leading-tight line-clamp-2 text-sm group-hover:text-indigo-400 transition-colors">{entry.title}</h3>{entry.rating > 0 && <span className={`text-xs font-bold px-1.5 py-0.5 rounded bg-white/5 ${entry.rating >= 80 ? 'text-emerald-400' : entry.rating >= 60 ? 'text-yellow-400' : 'text-red-400'}`}>{entry.rating}</span>}</div>
                <p className="text-[10px] text-gray-500 mb-2">{formatDate(entry.date)}</p>
                <div className="mt-auto flex flex-wrap gap-1">{entry.tags?.slice(0,3).map(t => <span key={t} className="text-[9px] text-gray-400 bg-white/5 px-1.5 py-0.5 rounded border border-white/5">{t}</span>)}</div>
              </div>
            </div>
          );
        };

        const CommandPalette = () => {
          const { state, dispatch } = useContext(AppContext);
          const [query, setQuery] = useState('');
          const [results, setResults] = useState([]);
          const [loading, setLoading] = useState(false);
          const [searchSource, setSearchSource] = useState('ALL'); // 'ALL' or specific
          const inputRef = useRef(null);
          
          useEffect(() => { if (state.ui.searchOpen) setTimeout(() => inputRef.current?.focus(), 100); }, [state.ui.searchOpen]);

          const doSearch = async () => {
               if (query.length < 3) return;
               setLoading(true);
               setResults([]);
               
               const promises = [];
               const keys = state.settings;

               // TMDB
               if (keys.tmdbKey && (searchSource === 'ALL' || searchSource === 'MOVIE')) promises.push(APIService.searchTMDB(query, 'movie', keys.tmdbKey).then(r => r.map(i => ({...i, type: 'movie'}))));
               if (keys.tmdbKey && (searchSource === 'ALL' || searchSource === 'TV')) promises.push(APIService.searchTMDB(query, 'tv', keys.tmdbKey).then(r => r.map(i => ({...i, type: 'tv'}))));
               
               // RAWG
               if (keys.rawgKey && (searchSource === 'ALL' || searchSource === 'GAME')) promises.push(APIService.searchRAWG(query, keys.rawgKey).then(r => r.map(i => ({...i, type: 'game'}))));
               
               // Books
               if (searchSource === 'ALL' || searchSource === 'BOOK') promises.push(APIService.searchBooks(query).then(r => r.map(i => ({...i, type: 'book'}))));
               
               // Anime/Manga (Jikan)
               if (searchSource === 'ALL' || searchSource === 'ANIME') promises.push(APIService.searchJikan(query, 'anime').then(r => r.map(i => ({...i, type: 'anime'}))));
               if (searchSource === 'ALL' || searchSource === 'MANGA') promises.push(APIService.searchJikan(query, 'manga').then(r => r.map(i => ({...i, type: 'manga'})))); // Covers manga/manhwa/manhua
               
               const allResults = (await Promise.all(promises)).flat();
               setResults(allResults);
               setLoading(false);
          };

          useEffect(() => { const t = setTimeout(doSearch, 800); return () => clearTimeout(t); }, [query, searchSource]);

          if (!state.ui.searchOpen) return null;

          const handleSelect = (item) => {
            const newEntry = {
              id: generateId(),
              title: item.title,
              category: item.type, // Map 'manga' from jikan correctly in modal if needed, or unify
              image: item.poster,
              rating: 0,
              mainstreamScore: item.mainstreamScore || 0,
              overview: item.overview || '',
              tags: [],
              date: new Date().toISOString().split('T')[0],
              status: 'completed',
              totalMinutes: 0
            };
            dispatch({ type: 'SET_UI', payload: { searchOpen: false, editingEntry: newEntry, modalOpen: true } });
          };

          return (
            <div className="fixed inset-0 z-50 flex items-start justify-center pt-[15vh] px-4 bg-black/80 backdrop-blur-sm" onClick={() => dispatch({ type: 'SET_UI', payload: { searchOpen: false } })}>
              <div className="relative w-full max-w-2xl bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[70vh] animate-in slide-up" onClick={e=>e.stopPropagation()}>
                <div className="flex border-b border-white/10 bg-black/20 p-2 gap-2 overflow-x-auto scrollbar-hide">
                    <button onClick={() => setSearchSource('ALL')} className={`px-3 py-1 rounded-lg text-xs font-bold ${searchSource==='ALL'?'bg-indigo-600 text-white':'text-gray-400 hover:bg-white/5'}`}>TODO</button>
                    {Object.values(CATEGORIES).filter(c=>c.id!=='music').map(c => <button key={c.id} onClick={() => setSearchSource(c.id.toUpperCase())} className={`px-3 py-1 rounded-lg text-xs font-bold ${searchSource===c.id.toUpperCase()?'bg-white/10 text-white':'text-gray-400 hover:bg-white/5'}`}>{c.label}</button>)}
                </div>
                <div className="p-4 border-b border-white/10 flex items-center gap-3">
                  <Search className="text-indigo-400" size={24} />
                  <input ref={inputRef} placeholder="Busca en todas las dimensiones..." className="w-full bg-transparent text-xl text-white placeholder-gray-600 focus:outline-none" value={query} onChange={e => setQuery(e.target.value)} />
                  {loading && <RefreshCw className="animate-spin text-gray-500" size={20} />}
                </div>
                <div className="overflow-y-auto p-2">
                  {results.map((item) => (
                    <button key={item.id+item.type} onClick={() => handleSelect(item)} className="w-full text-left p-3 rounded-xl hover:bg-white/5 flex gap-4 transition-colors group">
                        <div className="w-10 h-14 bg-black/50 rounded flex-shrink-0 overflow-hidden">{item.poster ? <img src={item.poster} className="w-full h-full object-cover" /> : null}</div>
                        <div>
                            <h4 className="text-white font-medium group-hover:text-indigo-400 line-clamp-1">{item.title}</h4>
                            <div className="flex items-center gap-2 text-xs text-gray-500">
                                <span className="uppercase font-bold text-[10px] bg-white/5 px-1 rounded">{item.type}</span>
                                <span>{item.year}</span>
                                <span>• {item.source}</span>
                            </div>
                        </div>
                        <Plus size={20} className="ml-auto opacity-0 group-hover:opacity-100 text-indigo-400" />
                    </button>
                  ))}
                  {!query && <div className="p-12 text-center text-gray-600 flex flex-col items-center"><Globe className="mb-4 opacity-50" size={32}/><p>Buscador Universal</p><p className="text-xs mt-2">Busca en TMDB, RAWG, Google Books y MyAnimeList simultáneamente.</p></div>}
                </div>
              </div>
            </div>
          );
        };

        const SettingsDrawer = () => {
          const { state, dispatch } = useContext(AppContext);
          const [keys, setKeys] = useState(state.settings);
          if (!state.ui.settingsOpen) return null;
          return (
            <div className="fixed inset-0 z-[70] flex justify-end bg-black/60 backdrop-blur-sm" onClick={() => dispatch({ type: 'SET_UI', payload: { settingsOpen: false } })}>
              <div className="relative w-full max-w-md bg-zinc-950 border-l border-white/10 shadow-2xl h-full flex flex-col animate-in slide-up" onClick={e=>e.stopPropagation()}>
                <div className="p-6 border-b border-white/10 flex justify-between items-center"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Settings className="text-indigo-400" /> Ajustes</h2><button onClick={() => dispatch({ type: 'SET_UI', payload: { settingsOpen: false } })}><X className="text-gray-500" /></button></div>
                <div className="p-6 space-y-6 overflow-y-auto flex-1">
                  <div className="space-y-4">
                      <Input label="Nombre" value={state.profile.name} onChange={e => dispatch({type: 'UPDATE_PROFILE', payload: {name: e.target.value}})} />
                      <Input label="Bio" value={state.profile.bio} onChange={e => dispatch({type: 'UPDATE_PROFILE', payload: {bio: e.target.value}})} />
                      <Input label="Avatar URL" value={state.profile.avatar} onChange={e => dispatch({type: 'UPDATE_PROFILE', payload: {avatar: e.target.value}})} />
                      <Input label="Banner URL" value={state.profile.banner} onChange={e => dispatch({type: 'UPDATE_PROFILE', payload: {banner: e.target.value}})} />
                  </div>
                  <hr className="border-white/10" />
                  <div className="space-y-4">
                      <Input label="TMDB Key (Cine)" type="password" value={keys.tmdbKey || ''} onChange={e => setKeys({...keys, tmdbKey: e.target.value})} />
                      <Input label="RAWG Key (Juegos)" type="password" value={keys.rawgKey || ''} onChange={e => setKeys({...keys, rawgKey: e.target.value})} />
                      <Input label="Last.fm User" value={keys.lastfmUser || ''} onChange={e => setKeys({...keys, lastfmUser: e.target.value})} />
                      <Input label="Last.fm Key" type="password" value={keys.lastfmKey || ''} onChange={e => setKeys({...keys, lastfmKey: e.target.value})} />
                  </div>
                </div>
                <div className="p-6 border-t border-white/10"><Button variant="accent" className="w-full" onClick={() => { dispatch({ type: 'UPDATE_SETTINGS', payload: keys }); dispatch({ type: 'SET_UI', payload: { settingsOpen: false } }); }}>Guardar</Button></div>
              </div>
            </div>
          );
        };

        const AppLayout = () => {
          const { state, dispatch } = useContext(AppContext);
          const { entries, ui, profile } = state;

          const filteredEntries = useMemo(() => {
            let list = entries;
            if (ui.activeCategory === 'favorites') list = list.filter(e => e.favorite);
            else if (ui.activeCategory !== 'all') list = list.filter(e => e.category === ui.activeCategory);
            return list;
          }, [entries, ui.activeCategory]);

          return (
            <div className="min-h-screen pb-20 md:pb-0 flex">
              {/* Sidebar */}
              <aside className="fixed left-0 top-0 bottom-0 w-64 border-r border-white/5 bg-[#0c0c0e]/80 backdrop-blur-xl hidden md:flex flex-col z-20">
                <div className="p-8">
                  <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-500 tracking-tighter">CHRONICLE<span className="text-indigo-500">.v2</span></h1>
                </div>
                <nav className="flex-1 px-4 space-y-6 overflow-y-auto custom-scrollbar">
                  <div className="space-y-1">
                      <button onClick={() => dispatch({type: 'SET_UI', payload: {activeCategory: 'all'}})} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl transition-all ${ui.activeCategory === 'all' ? 'bg-white/10 text-white shadow-lg shadow-white/5' : 'text-gray-500 hover:text-white hover:bg-white/5'}`}><LayoutGrid size={18} /> Inicio</button>
                      <button onClick={() => dispatch({type: 'SET_UI', payload: {activeCategory: 'favorites'}})} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl transition-all ${ui.activeCategory === 'favorites' ? 'bg-rose-500/10 text-rose-400 border border-rose-500/20' : 'text-gray-500 hover:text-white hover:bg-white/5'}`}><Heart size={18} /> Favoritos</button>
                  </div>
                  
                  {Object.values(GROUPS).map(group => (
                      <div key={group.id}>
                          <div className="px-4 text-[10px] font-bold text-gray-600 uppercase tracking-widest mb-2 flex items-center gap-2">{group.label}</div>
                          <div className="space-y-0.5">
                              {Object.values(CATEGORIES).filter(c => c.groupId === group.id).map(cat => (
                                <button key={cat.id} onClick={() => dispatch({type: 'SET_UI', payload: {activeCategory: cat.id}})} className={`w-full flex items-center justify-between px-4 py-2 rounded-lg transition-all text-sm ${ui.activeCategory === cat.id ? `bg-white/5 text-white` : 'text-gray-500 hover:text-white hover:bg-white/5'}`}>
                                  <div className="flex items-center gap-3"><cat.icon size={14} className={ui.activeCategory === cat.id ? cat.color : 'opacity-50'} /> {cat.label}</div>
                                </button>
                              ))}
                          </div>
                      </div>
                  ))}
                </nav>
              </aside>

              {/* Main */}
              <main className="md:ml-64 flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full">
                 <header className="flex justify-between items-center mb-10 sticky top-0 z-30 py-4 bg-[#09090b]/90 backdrop-blur-xl -mx-4 px-4 md:-mx-8 md:px-8 border-b border-white/5">
                    <h2 className="text-xl font-bold text-white capitalize hidden md:block">{ui.activeCategory === 'all' ? 'Dashboard' : ui.activeCategory === 'favorites' ? 'Favoritos' : CATEGORIES[ui.activeCategory.toUpperCase()]?.label || 'Colección'}</h2>
                    <div className="flex gap-2">
                      <Button variant="ghost" onClick={() => dispatch({type: 'SET_UI', payload: {searchOpen: true}})}><Search size={18} /> <span className="hidden md:inline text-xs opacity-50">Buscar Todo</span></Button>
                      <Button variant="accent" onClick={() => dispatch({ type: 'SET_UI', payload: { editingEntry: { id: generateId(), category: 'movie', date: new Date().toISOString().split('T')[0] }, modalOpen: true } })}><Plus size={18} /></Button>
                      <Button variant="ghost" onClick={() => dispatch({type: 'SET_UI', payload: {settingsOpen: true}})}><Settings size={18} /></Button>
                    </div>
                 </header>

                 {ui.activeCategory === 'all' ? (
                     <DashboardView entries={entries} profile={profile} settings={state.settings} dispatch={dispatch} />
                 ) : (
                     <div className="animate-in slide-up">
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                            {filteredEntries.map(entry => (
                                <EntryCard key={entry.id} entry={entry} onClick={() => dispatch({ type: 'SET_UI', payload: { editingEntry: entry, modalOpen: true } })} onShare={(e) => dispatch({ type: 'SET_UI', payload: { shareEntry: e, shareOpen: true } })} />
                            ))}
                            {filteredEntries.length === 0 && (
                                <div className="col-span-full py-32 text-center flex flex-col items-center justify-center text-gray-600">
                                    <Ghost size={48} className="mb-4 opacity-20" /><p>Nada por aquí...</p>
                                </div>
                            )}
                        </div>
                     </div>
                 )}
              </main>
              
              <div className="fixed bottom-0 left-0 right-0 h-16 bg-[#0c0c0e]/90 backdrop-blur-xl border-t border-white/10 flex md:hidden items-center justify-around z-40 px-2">
                 <button onClick={() => dispatch({type: 'SET_UI', payload: {activeCategory: 'all'}})} className="p-2 text-gray-400 hover:text-white"><LayoutGrid /></button>
                 <button onClick={() => dispatch({type: 'SET_UI', payload: {searchOpen: true}})} className="p-3 -mt-6 bg-indigo-600 rounded-full text-white shadow-lg border border-white/10"><Search /></button>
                 <button onClick={() => dispatch({type: 'SET_UI', payload: {settingsOpen: true}})} className="p-2 text-gray-400 hover:text-white"><Settings /></button>
              </div>

              <EntryModal />
              <CommandPalette />
              <SettingsDrawer />
              <ShareModal />
            </div>
          );
        };

        const ChronicleApp = () => {
          const [state, dispatch] = useReducer(reducer, initialState);
          useEffect(() => {
            const saved = localStorage.getItem('chronicle_v2_data');
            if (saved) { const parsed = JSON.parse(saved); if (!parsed.profile) parsed.profile = initialState.profile; dispatch({ type: 'LOAD_DATA', payload: parsed }); }
          }, []);
          useEffect(() => { localStorage.setItem('chronicle_v2_data', JSON.stringify({ entries: state.entries, settings: state.settings, profile: state.profile })); }, [state.entries, state.settings, state.profile]);
          useEffect(() => {
            const handleKeyDown = (e) => { if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); dispatch({ type: 'SET_UI', payload: { searchOpen: !state.ui.searchOpen } }); }};
            window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
          }, [state.ui.searchOpen]);
          return (<AppContext.Provider value={{ state, dispatch }}><AppLayout /></AppContext.Provider>);
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<ChronicleApp />);
    </script>
</body>
</html>
